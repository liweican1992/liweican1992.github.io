<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="iOS Developer">
<meta property="og:type" content="website">
<meta property="og:title" content="licc">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="licc">
<meta property="og:description" content="iOS Developer">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="weican Li">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>licc</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="licc" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">licc</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">AppçŸ©é˜µ|å‡ºæµ·|æŠ•æ”¾å½’å› </p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2025/02/14/iOS%E5%9B%BD%E9%99%85%E5%8C%96-%E5%A4%A7%E6%A8%A1%E5%9E%8B%E8%87%AA%E5%8A%A8%E7%BF%BB%E8%AF%91%E8%84%9A%E6%9C%AC%EF%BC%88GPT-DeepSeek%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img/avatar.png">
      <meta itemprop="name" content="weican Li">
      <meta itemprop="description" content="iOS Developer">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="licc">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/02/14/iOS%E5%9B%BD%E9%99%85%E5%8C%96-%E5%A4%A7%E6%A8%A1%E5%9E%8B%E8%87%AA%E5%8A%A8%E7%BF%BB%E8%AF%91%E8%84%9A%E6%9C%AC%EF%BC%88GPT-DeepSeek%EF%BC%89/" class="post-title-link" itemprop="url">iOSå›½é™…åŒ–-å¤§æ¨¡å‹è‡ªåŠ¨ç¿»è¯‘è„šæœ¬ï¼ˆGPT+DeepSeekï¼‰</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-02-14 19:56:00" itemprop="dateCreated datePublished" datetime="2025-02-14T19:56:00+08:00">2025-02-14</time>
            </span>

          
            <span id="/2025/02/14/iOS%E5%9B%BD%E9%99%85%E5%8C%96-%E5%A4%A7%E6%A8%A1%E5%9E%8B%E8%87%AA%E5%8A%A8%E7%BF%BB%E8%AF%91%E8%84%9A%E6%9C%AC%EF%BC%88GPT-DeepSeek%EF%BC%89/" class="post-meta-item leancloud_visitors" data-flag-title="iOSå›½é™…åŒ–-å¤§æ¨¡å‹è‡ªåŠ¨ç¿»è¯‘è„šæœ¬ï¼ˆGPT+DeepSeekï¼‰" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2025/02/14/iOS%E5%9B%BD%E9%99%85%E5%8C%96-%E5%A4%A7%E6%A8%A1%E5%9E%8B%E8%87%AA%E5%8A%A8%E7%BF%BB%E8%AF%91%E8%84%9A%E6%9C%AC%EF%BC%88GPT-DeepSeek%EF%BC%89/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2025/02/14/iOS%E5%9B%BD%E9%99%85%E5%8C%96-%E5%A4%A7%E6%A8%A1%E5%9E%8B%E8%87%AA%E5%8A%A8%E7%BF%BB%E8%AF%91%E8%84%9A%E6%9C%AC%EF%BC%88GPT-DeepSeek%EF%BC%89/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨pythonè„šæœ¬é€šè¿‡å¤§æ¨¡å‹APIè¿›è¡Œæ‰¹é‡æ–‡æœ¬ç¿»è¯‘ã€‚æœ¬æ–‡æ˜¯å¯¹ä¹‹å‰Xliffè‡ªåŠ¨å½•å…¥è„šæœ¬çš„è¡¥å……ã€‚</p>
</blockquote>
<p>è¿™ä¸ªè„šæœ¬æ˜¯å¯¹ä¹‹å‰åœ¨Xcodeä¸Šä½¿ç”¨çš„Xliffè‡ªåŠ¨å½•å…¥è„šæœ¬çš„è¡¥å……ã€‚<br>å…³äºå¦‚ä½•åœ¨Xcodeä¸­ä½¿ç”¨è‡ªåŠ¨å¯¼å‡ºï¼Œæ‰¹é‡å½•å…¥ã€å¯¼å…¥å›½é™…åŒ–æ–‡æ¡ˆï¼Œè¯¦è§ï¼š<a href="https://leevcan.com/2020/10/12/iOS%E5%9B%BD%E9%99%85%E5%8C%96%E2%80%94Xliff%E5%BD%95%E5%85%A5%E8%84%9A%E6%9C%AC/" target="_blank" rel="noopener">iOSå›½é™…åŒ–â€”xliffè‡ªåŠ¨å½•å…¥è„šæœ¬</a></p>
<h6 id="0-èƒŒæ™¯ä»‹ç»"><a href="#0-èƒŒæ™¯ä»‹ç»" class="headerlink" title="0.èƒŒæ™¯ä»‹ç»"></a>0.èƒŒæ™¯ä»‹ç»</h6><p>iOSå›½é™…åŒ–â€”xliffè‡ªåŠ¨å½•å…¥è„šæœ¬åœ¨é¡¹ç›®ä¸­å·²ç»ç¨³å®šè¿è¡Œäº†4å¹´ï¼Œä¹‹æ‰€ä»¥ä½¿ç”¨äº‘ç«¯Excleç®¡ç†ç¿»è¯‘æ–‡æ¡ˆæ˜¯è€ƒè™‘åˆ°å…¼å®¹Androidç«¯å’ŒWebç«¯ç­‰ã€‚ä¹‹å‰æ¯ä¸ªç‰ˆæœ¬éƒ½éœ€è¦äº§å“åŒå­¦å½’çº³æ–°å¢çš„æ–‡æ¡ˆï¼Œå¹¶é€šè¿‡ç¿»è¯‘å¼•æ“æ‰‹åŠ¨ç¿»è¯‘åå¡«å†™åˆ°Excelä¸­ã€‚<br><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/202507141958631.png" alt=""><br>éšç€GPTçš„è¯ç”Ÿï¼Œç¿»è¯‘å·¥å…·å°±åˆ‡æ¢æˆäº†GPTï¼Œç¿»è¯‘çš„æ›´åœ°é“ï¼Œæ›´äººæ€§åŒ–ã€‚<br>ä½†æ˜¯æ¯æ¬¡é€šè¿‡å¯¹è¯æ¡†ç¿»è¯‘ï¼Œæ‹¿åˆ°ç»“æœå†ç²˜è´´åˆ°Excelä¸­æ˜æ˜¾æ•ˆç‡æœ‰æå‡ç©ºé—´ï¼Œå¹¶ä¸”éšç€DeepSeekçš„çˆ†ç«ï¼Œå‘ç°DeepSeek R1çš„ç¿»è¯‘è¿˜ä¼šè€ƒè™‘å½“åœ°é£ä¿—ä¹ æƒ¯ç­‰ï¼Œå¹¶ä¸”èƒ½çœ‹åˆ°æ€è€ƒè¿‡ç¨‹ã€‚æ‰€ä»¥ç›´æ¥é€šè¿‡è„šæœ¬è°ƒç”¨APIæ•ˆç‡ä¼šæ›´é«˜ã€‚<br><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/202507141958282.png" alt=""></p>
<h6 id="1-éœ€æ±‚åˆ†æ"><a href="#1-éœ€æ±‚åˆ†æ" class="headerlink" title="1.éœ€æ±‚åˆ†æ"></a>1.éœ€æ±‚åˆ†æ</h6><p>å› ä¸ºæ˜¯å¯¹ä¹‹å‰è„šæœ¬çš„è¡¥å……ï¼Œé‚£ä¹ˆå‚è€ƒä¹‹å‰è„šæœ¬é€»è¾‘ã€‚åœ¨xliff.pyä¸­å­˜åœ¨ä¸€ä¸ªExcelè¯­ç§æ ‡é¢˜å’ŒXcodeä¸­å¤šè¯­è¨€Bundle Nameç¼©å†™çš„æ˜ å°„å…³ç³»ã€‚<br><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/202507141959685.png" alt=""><br>Localization.shä¸­å£°æ˜éœ€è¦å¤„ç†é‚£äº›è¯­ç§ã€‚<br><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/202507142000661.png" alt=""></p>
<p>é‚£ä¹ˆç›´æ¥è¯»å–æœ¬åœ°Excelå¹¶æ‰¹é‡ç¿»è¯‘åç”Ÿæˆä¸€ä¸ªæ–°Excelçš„æ–¹æ¡ˆä¼šæ›´å¥½ã€‚è¿™æ ·ç»“åˆ<a href="https://leevcan.com/2020/10/12/iOS%E5%9B%BD%E9%99%85%E5%8C%96%E2%80%94Xliff%E5%BD%95%E5%85%A5%E8%84%9A%E6%9C%AC/" target="_blank" rel="noopener">iOSå›½é™…åŒ–â€”xliffè‡ªåŠ¨å½•å…¥è„šæœ¬</a>ã€‚æ•´ä¸ªæµç¨‹éƒ½å¯ä»¥å®ç°è‡ªåŠ¨åŒ–ã€‚</p>
<p>å¹¶ä¸”ä¹‹å‰å°è¯•ä½¿ç”¨åˆ†éš”ç¬¦æ‰¹é‡è¯·æ±‚å¹¶ä¸”è®©å¤§æ¨¡å‹è¿”å›jsonæ ¼å¼çš„ç¿»è¯‘ç»“æœï¼Œæ˜æ˜¾ä¼šå¢åŠ å¤§æ¨¡å‹å¹»è§‰ï¼Œé€ æˆç¿»è¯‘ç»“æœé”™ä½ç­‰ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/202507142000888.png" alt=""></p>
<h6 id="2-è„šæœ¬å®ç°"><a href="#2-è„šæœ¬å®ç°" class="headerlink" title="2.è„šæœ¬å®ç°"></a>2.è„šæœ¬å®ç°</h6><p>DeepSeekçš„APIå¯ä»¥åœ¨å®˜ç½‘è´­ä¹°ï¼Œä½†æ˜¯æ¨èç¬¬ä¸‰æ–¹å¹³å°æ¥å…¥ï¼Œæ¯•ç«Ÿå¯ä»¥ç™½å«–ï¼ˆä¸æ˜¯â€¦ï¼‰ã€‚æˆ‘ä½¿ç”¨çš„æ˜¯siliconflowå¹³å°ã€‚æ³¨å†Œé€2000w tokenã€‚æ¬¢è¿å¤§å®¶é€šè¿‡æˆ‘çš„<a href="https://cloud.siliconflow.cn/i/gdaCaOmO" target="_blank" rel="noopener">é‚€è¯·é“¾æ¥æ³¨å†Œ</a>ï¼Œæˆ–è€…å¡«å†™é‚€è¯·ç ï¼š<strong>gdaCaOmO</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/202507142001911.png" alt=""></p>
<p>GPTçš„è¯æ˜¯é€šè¿‡å¾®è½¯Azureå¹³å°æ¥å…¥ï¼Œè¯¦è§ï¼š<a href="https://learn.microsoft.com/en-us/azure/ai-services/openai/chatgpt-quickstart?tabs=command-line%2Ckeyless%2Ctypescript-keyless%2Cpython-new&pivots=programming-language-python" target="_blank" rel="noopener">Quickstart: Get started using GPT-35-Turbo and GPT-4 with Azure OpenAI Service</a></p>
<p>ä¸‹é¢æ˜¯æ•´ä¸ªè„šæœ¬çš„å®ç°ï¼Œé»˜è®¤ä½¿ç”¨GPTè¿›è¡Œç¿»è¯‘ï¼Œä¹Ÿå¯ä»¥æŒ‡å®šDeepSeekï¼Œæ”¯æŒä¿®æ”¹DeepSeekçš„æ¨¡å‹ã€‚æ¨¡å‹åç§°è¯¦è§ï¼š<a href="https://docs.siliconflow.cn/cn/api-reference/chat-completions/chat-completions" target="_blank" rel="noopener">Siliconflow API</a>ã€‚æ³¨æ„DeepSeekå’ŒGPTçš„payloadæ ¼å¼ä¸ä¸€æ ·ã€‚</p>
<p>éœ€è¦æå‰åœ¨æœ¬åœ°é…ç½®API Keyå¹¶é˜²æ­¢ç§˜é’¥æ³„éœ²ã€‚</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line"><span class="comment">#è¿™ç§æ–¹å¼åªåœ¨å½“å‰Terminalä¸­ç”Ÿæ•ˆ å¦‚ä½•å…¨å±€ç”Ÿæ•ˆè¯·ç»“åˆè‡ªå·±æ“ä½œç³»ç»Ÿ è‡ªè¡Œæ“ä½œï¼</span></span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">AZURE_OPENAI_API_KEY</span>=<span class="string">"REPLACE_WITH_YOUR_KEY_VALUE_HERE"</span></span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">AZURE_OPENAI_ENDPOINT</span>=<span class="string">"REPLACE_WITH_YOUR_KEY_VALUE_HERE"</span></span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">DEEPSEEK_API_URL</span>=<span class="string">"REPLACE_WITH_YOUR_KEY_VALUE_HERE"</span></span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">DEEPSEEK_API_KEY</span>=<span class="string">"REPLACE_WITH_YOUR_KEY_VALUE_HERE"</span></span><br></pre></td></tr></table></figure>

<p>ä¾èµ–åŒ…å®‰è£…å¯ä»¥ä½¿ç”¨pipè¿›è¡Œå®‰è£…</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line">pip <span class="keyword">install</span> openpyxl requests openai</span><br></pre></td></tr></table></figure>
<p>è„šæœ¬å®ç°ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment">#liweican@corp.netease.com</span></span><br><span class="line"><span class="comment">#æ”¯æŒgpt+deepseekã€‚è¯·è‡ªå·±åœ¨æœ¬åœ°é…ç½®DEEPSEEK_API_URL/DEEPSEEK_API_KEY/AZURE_OPENAI_ENDPOINT/AZURE_OPENAI_API_KEY é˜²æ­¢ç§˜é’¥æ³„éœ²</span></span><br><span class="line"><span class="comment">#eg:</span></span><br><span class="line"><span class="comment">#export AZURE_OPENAI_API_KEY="REPLACE_WITH_YOUR_KEY_VALUE_HERE"</span></span><br><span class="line"><span class="comment">#è¿™ç§æ–¹å¼åªåœ¨å½“å‰Terminalä¸­ç”Ÿæ•ˆ å¦‚ä½•å…¨å±€ç”Ÿæ•ˆè¯·ç»“åˆè‡ªå·±æ“ä½œç³»ç»Ÿ è‡ªè¡Œæ“ä½œï¼</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> openpyxl</span><br><span class="line"><span class="keyword">from</span> openpyxl.styles <span class="keyword">import</span> PatternFill</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> openai <span class="keyword">import</span> AzureOpenAI</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ ·å¼é…ç½®</span></span><br><span class="line">AUTO_TRANSLATE_FILL = PatternFill(</span><br><span class="line">    start_color=<span class="string">"FFD8E4BC"</span>,</span><br><span class="line">    end_color=<span class="string">"FFD8E4BC"</span>,</span><br><span class="line">    fill_type=<span class="string">"solid"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">LANGUAGE_MAPPING = &#123;</span><br><span class="line">    <span class="string">"ä¸­æ–‡ç®€ä½“"</span>: <span class="string">"Simplified Chinese"</span>,</span><br><span class="line">    <span class="string">"ä¸­æ–‡ç¹ä½“"</span>: <span class="string">"Traditional Chinese"</span>,</span><br><span class="line">    <span class="string">"Japanese"</span>: <span class="string">"Japanese"</span>,</span><br><span class="line">    <span class="string">"Spanish"</span>: <span class="string">"Spanish"</span>,</span><br><span class="line">    <span class="string">"Korean"</span>: <span class="string">"Korean"</span>,</span><br><span class="line">    <span class="string">"Thailand"</span>: <span class="string">"Thai"</span>,</span><br><span class="line">    <span class="string">"Indonesia"</span>: <span class="string">"Indonesian"</span>,</span><br><span class="line">    <span class="string">"German"</span>: <span class="string">"German"</span>,</span><br><span class="line">    <span class="string">"French"</span>: <span class="string">"French"</span>,</span><br><span class="line">    <span class="string">"Portuguese"</span>: <span class="string">"Portuguese"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># APIé…ç½®</span></span><br><span class="line">DEEPSEEK_API_URL = os.getenv(<span class="string">"DEEPSEEK_API_URL"</span>)</span><br><span class="line">DEEPSEEK_API_KEY = os.getenv(<span class="string">"DEEPSEEK_API_KEY"</span>)</span><br><span class="line"><span class="comment">#æŒ‡å®šæ¨¡å‹åç§° è’¸é¦æ¨¡å‹é€Ÿåº¦æ›´å¿« ä»·æ ¼ä¹Ÿä½</span></span><br><span class="line">DEEPSEEK_MODEL_NAME = <span class="string">"deepseek-ai/DeepSeek-R1-Distill-Qwen-14B"</span></span><br><span class="line">AZURE_OPENAI_ENDPOINT = os.getenv(<span class="string">"AZURE_OPENAI_ENDPOINT"</span>)</span><br><span class="line">AZURE_OPENAI_API_KEY = os.getenv(<span class="string">"AZURE_OPENAI_API_KEY"</span>)</span><br><span class="line">GPT_API_VERSION = <span class="string">"2024-06-01"</span></span><br><span class="line">BATCH_SIZE = <span class="number">8</span></span><br><span class="line">MAX_TOKENS = <span class="number">4096</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è§£æç¿»è¯‘ç»“æœ</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_translation_result</span><span class="params">(raw_text, texts)</span>:</span></span><br><span class="line">    translated = []</span><br><span class="line">    pattern = re.compile(<span class="string">r'^\d+\.\s*(.+)$'</span>, re.MULTILINE)</span><br><span class="line">    matches = pattern.findall(raw_text)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> len(matches) == len(texts):</span><br><span class="line">        translated = [m.strip() <span class="keyword">for</span> m <span class="keyword">in</span> matches]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># å¤‡ç”¨æ–¹æ¡ˆ</span></span><br><span class="line">        translated = [line.split(<span class="string">". "</span>, <span class="number">1</span>)[<span class="number">-1</span>].strip()</span><br><span class="line">                      <span class="keyword">for</span> line <span class="keyword">in</span> raw_text.split(<span class="string">"\n"</span>)</span><br><span class="line">                      <span class="keyword">if</span> line.strip() <span class="keyword">and</span> line[<span class="number">0</span>].isdigit()]</span><br><span class="line">    <span class="keyword">return</span> translated</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰¹é‡ç¿»è¯‘å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">batch_translate</span><span class="params">(texts, target_lang, model_choice)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> texts <span class="keyword">or</span> <span class="keyword">not</span> target_lang:</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ„å»ºprompt</span></span><br><span class="line">    numbered_texts = <span class="string">"\n"</span>.join([<span class="string">f"<span class="subst">&#123;i + <span class="number">1</span>&#125;</span>. <span class="subst">&#123;text&#125;</span>"</span> <span class="keyword">for</span> i, text <span class="keyword">in</span> enumerate(texts)])</span><br><span class="line">    <span class="comment"># é¿å…Pythonè§£æå ä½ç¬¦</span></span><br><span class="line">    system_prompt = <span class="string">f"""ä½ æ˜¯ä¸€ä½ä¸“ä¸šAppå†…æ–‡æ¡ˆç¿»è¯‘äººå‘˜ï¼Œè¯·å°†ä»¥ä¸‹è‹±æ–‡æ–‡æœ¬åˆ—è¡¨å‡†ç¡®ç¿»è¯‘ä¸º<span class="subst">&#123;LANGUAGE_MAPPING[target_lang]&#125;</span>ï¼š</span></span><br><span class="line"><span class="string"><span class="subst">&#123;numbered_texts&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">è¯·ä¸¥æ ¼éµå¾ªï¼š</span></span><br><span class="line"><span class="string">1. ä¿æŒä¸“ä¸šæœ¯è¯­ä¸€è‡´æ€§</span></span><br><span class="line"><span class="string">2. ä¿ç•™æ•°å­—å’Œç‰¹æ®Šç¬¦å·ï¼Œ$&#123;&#123;TT&#125;&#125;ã€$&#123;&#123;time&#125;&#125;ç­‰æ˜¯å ä½ç¬¦å‡ä¸ç¿»è¯‘ã€‚</span></span><br><span class="line"><span class="string">3. ä½¿ç”¨æ­£å¼ä¹¦é¢è¯­ä½“</span></span><br><span class="line"><span class="string">4. æŒ‰ä»¥ä¸‹æ ¼å¼è¿”å›ï¼š</span></span><br><span class="line"><span class="string">1. ç¿»è¯‘ç»“æœ</span></span><br><span class="line"><span class="string">2. ç¿»è¯‘ç»“æœ"""</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> model_choice == <span class="string">"deepseek"</span>:</span><br><span class="line">        payload = &#123;</span><br><span class="line">            <span class="string">"model"</span>: DEEPSEEK_MODEL_NAME,</span><br><span class="line">            <span class="string">"messages"</span>: [</span><br><span class="line">                &#123;<span class="string">"role"</span>: <span class="string">"system"</span>, <span class="string">"content"</span>: system_prompt&#125;,</span><br><span class="line">                &#123;<span class="string">"role"</span>: <span class="string">"user"</span>, <span class="string">"content"</span>: <span class="string">"è¯·å¼€å§‹ç¿»è¯‘"</span>&#125;</span><br><span class="line">            ],</span><br><span class="line">            <span class="string">"temperature"</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">"max_tokens"</span>: MAX_TOKENS</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        headers = &#123;</span><br><span class="line">            <span class="string">"Authorization"</span>: <span class="string">f"Bearer <span class="subst">&#123;DEEPSEEK_API_KEY&#125;</span>"</span>,</span><br><span class="line">            <span class="string">"Content-Type"</span>: <span class="string">"application/json"</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># æ·»åŠ è¶…æ—¶å’Œé‡è¯•æœºåˆ¶</span></span><br><span class="line">            print(system_prompt)</span><br><span class="line">            print(<span class="string">"ğŸš€ğŸš€ğŸš€å½“å‰DeepSeekæ¨¡å‹æ˜¯"</span> + DEEPSEEK_MODEL_NAME)</span><br><span class="line"></span><br><span class="line">            response = requests.post(DEEPSEEK_API_URL, json=payload, headers=headers, timeout=(<span class="number">10</span>, <span class="number">30</span>))</span><br><span class="line">            response.raise_for_status()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># status_code</span></span><br><span class="line">            print(<span class="string">f"APIå“åº”çŠ¶æ€ç : <span class="subst">&#123;response.status_code&#125;</span>"</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                response_data = response.json()</span><br><span class="line">                print(response_data)</span><br><span class="line">            <span class="keyword">except</span> ValueError:</span><br><span class="line">                <span class="keyword">raise</span> Exception(<span class="string">"æ— æ•ˆçš„JSONå“åº”"</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="string">'choices'</span> <span class="keyword">not</span> <span class="keyword">in</span> response_data <span class="keyword">or</span> <span class="keyword">not</span> response_data[<span class="string">'choices'</span>]:</span><br><span class="line">                <span class="keyword">raise</span> Exception(<span class="string">"APIè¿”å›ç»“æ„å¼‚å¸¸"</span>)</span><br><span class="line"></span><br><span class="line">            raw_text = response_data[<span class="string">'choices'</span>][<span class="number">0</span>][<span class="string">'message'</span>][<span class="string">'content'</span>]</span><br><span class="line">            translated = parse_translation_result(raw_text, texts)</span><br><span class="line">            print(translated)</span><br><span class="line">            <span class="keyword">return</span> translated</span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            print(<span class="string">f"APIè°ƒç”¨å¤±è´¥: <span class="subst">&#123;str(e)&#125;</span>"</span>)</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">    <span class="comment"># GPT</span></span><br><span class="line">    <span class="keyword">elif</span> model_choice == <span class="string">"gpt"</span>:</span><br><span class="line">        client = AzureOpenAI(</span><br><span class="line">            azure_endpoint=AZURE_OPENAI_ENDPOINT,</span><br><span class="line">            api_key=AZURE_OPENAI_API_KEY,</span><br><span class="line">            api_version=GPT_API_VERSION</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            response = client.chat.completions.create(</span><br><span class="line">                model=<span class="string">"gpt-4o-mini"</span>,</span><br><span class="line">                messages=[</span><br><span class="line">                    &#123;<span class="string">"role"</span>: <span class="string">"system"</span>, <span class="string">"content"</span>: system_prompt&#125;,</span><br><span class="line">                    &#123;<span class="string">"role"</span>: <span class="string">"user"</span>, <span class="string">"content"</span>: <span class="string">"è¯·å¼€å§‹ç¿»è¯‘"</span>&#125;</span><br><span class="line">                ]</span><br><span class="line">            )</span><br><span class="line">            raw_text = response.choices[<span class="number">0</span>].message.content</span><br><span class="line">            translated = parse_translation_result(raw_text, texts)</span><br><span class="line">            print(translated)</span><br><span class="line">            <span class="keyword">return</span> translated</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            print(<span class="string">f"APIè°ƒç”¨å¤±è´¥: <span class="subst">&#123;str(e)&#125;</span>"</span>)</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">process_excel</span><span class="params">(input_path, output_path, model_choice)</span>:</span></span><br><span class="line">    print(<span class="string">f"å¼€å§‹è¯»å–Excel <span class="subst">&#123;input_path&#125;</span>"</span>)</span><br><span class="line">    print(<span class="string">f"å½“å‰ä½¿ç”¨çš„å¤§æ¨¡å‹æ˜¯: <span class="subst">&#123;model_choice.upper()&#125;</span>"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        wb = openpyxl.load_workbook(input_path)</span><br><span class="line">        sheet = wb.active</span><br><span class="line"></span><br><span class="line">        source_col = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">for</span> idx, cell <span class="keyword">in</span> enumerate(sheet[<span class="number">1</span>], <span class="number">1</span>):</span><br><span class="line">            <span class="keyword">if</span> cell.value <span class="keyword">and</span> cell.value.strip() == <span class="string">"English"</span>:</span><br><span class="line">                source_col = idx</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> source_col:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">"å·¥ä½œè¡¨ä¸­æœªæ‰¾åˆ°'English'åˆ—ï¼Œè¯·æ£€æŸ¥ç¬¬ä¸€è¡Œæ ‡é¢˜"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># éå†æ‰€æœ‰ç›®æ ‡è¯­è¨€åˆ—</span></span><br><span class="line">        <span class="keyword">for</span> col_idx <span class="keyword">in</span> range(<span class="number">1</span>, sheet.max_column + <span class="number">1</span>):</span><br><span class="line">            header_cell = sheet.cell(row=<span class="number">1</span>, column=col_idx)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> header_cell.value:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            lang_name = header_cell.value.strip()</span><br><span class="line">            <span class="keyword">if</span> lang_name == <span class="string">"English"</span> <span class="keyword">or</span> lang_name <span class="keyword">not</span> <span class="keyword">in</span> LANGUAGE_MAPPING:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            print(<span class="string">f"\n=== æ­£åœ¨å¤„ç† <span class="subst">&#123;lang_name&#125;</span> ==="</span>)</span><br><span class="line">            process_language_column(sheet, source_col, col_idx, lang_name, model_choice)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ä¿å­˜ç»“æœ</span></span><br><span class="line">        wb.save(output_path)</span><br><span class="line">        print(<span class="string">f"\nå¤„ç†å®Œæˆï¼æ–‡ä»¶å·²ä¿å­˜è‡³ï¼š<span class="subst">&#123;output_path&#125;</span>"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        print(<span class="string">f"å¤„ç†è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: <span class="subst">&#123;str(e)&#125;</span>"</span>)</span><br><span class="line">        <span class="keyword">raise</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">process_language_column</span><span class="params">(sheet, source_col, target_col, lang_name, model_choice)</span>:</span></span><br><span class="line">    <span class="string">"""å¤„ç†å•ä¸ªè¯­è¨€åˆ—"""</span></span><br><span class="line">    batch_texts = []</span><br><span class="line">    batch_positions = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> row_idx <span class="keyword">in</span> range(<span class="number">2</span>, sheet.max_row + <span class="number">1</span>):</span><br><span class="line">        source_cell = sheet.cell(row=row_idx, column=source_col)</span><br><span class="line">        target_cell = sheet.cell(row=row_idx, column=target_col)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># è·³è¿‡ç©ºå€¼å’Œå·²ç¿»è¯‘å†…å®¹</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> source_cell.value <span class="keyword">or</span> (target_cell.value <span class="keyword">and</span> str(target_cell.value).strip()):</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># ç»„æˆæ‰¹æ¬¡</span></span><br><span class="line">        batch_texts.append(str(source_cell.value).strip())</span><br><span class="line">        batch_positions.append((row_idx, target_col))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> len(batch_texts) &gt;= BATCH_SIZE:</span><br><span class="line">            process_batch(sheet, batch_texts, batch_positions, lang_name, model_choice)</span><br><span class="line">            batch_texts.clear()</span><br><span class="line">            batch_positions.clear()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¤„ç†å‰©ä½™æ‰¹æ¬¡</span></span><br><span class="line">    <span class="keyword">if</span> batch_texts:</span><br><span class="line">        process_batch(sheet, batch_texts, batch_positions, lang_name, model_choice)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">process_batch</span><span class="params">(sheet, texts, positions, lang_name, model_choice)</span>:</span></span><br><span class="line">    print(<span class="string">f"æ­£åœ¨æ‰¹é‡ç¿»è¯‘ <span class="subst">&#123;len(texts)&#125;</span> æ¡æ–‡æœ¬åˆ° <span class="subst">&#123;lang_name&#125;</span>"</span>)</span><br><span class="line"></span><br><span class="line">    translated = []</span><br><span class="line">    <span class="keyword">for</span> retry <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            translated = batch_translate(texts, lang_name, model_choice)</span><br><span class="line">            <span class="keyword">if</span> len(translated) == len(texts):</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            print(<span class="string">f"ç¬¬<span class="subst">&#123;retry + <span class="number">1</span>&#125;</span>æ¬¡é‡è¯•..."</span>)</span><br><span class="line">            time.sleep(<span class="number">2</span> ** retry)  <span class="comment"># æŒ‡æ•°sleep</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            print(<span class="string">f"æ‰¹å¤„ç†å¤±è´¥: <span class="subst">&#123;str(e)&#125;</span>"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> len(translated) != len(texts):</span><br><span class="line">        print(<span class="string">f"æœªèƒ½è·å–å®Œæ•´ç¿»è¯‘ï¼Œé¢„æœŸ<span class="subst">&#123;len(texts)&#125;</span>æ¡ï¼Œå®é™…<span class="subst">&#123;len(translated)&#125;</span>æ¡"</span>)</span><br><span class="line">        translated += [<span class="string">f"[ç¿»è¯‘å¤±è´¥] <span class="subst">&#123;text&#125;</span>"</span> <span class="keyword">for</span> text <span class="keyword">in</span> texts[len(translated):]]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å†™å…¥ç»“æœ</span></span><br><span class="line">    <span class="keyword">for</span> (row, col), text <span class="keyword">in</span> zip(positions, translated):</span><br><span class="line">        cell = sheet.cell(row=row, column=col)</span><br><span class="line">        cell.value = text</span><br><span class="line">        cell.fill = AUTO_TRANSLATE_FILL</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">import</span> sys</span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span> <span class="keyword">and</span> sys.argv[<span class="number">1</span>] <span class="keyword">not</span> <span class="keyword">in</span> [<span class="string">"deepseek"</span>, <span class="string">"gpt"</span>]:</span><br><span class="line">        print(<span class="string">"è¯·æŒ‡å®šæœ‰æ•ˆçš„æ¨¡å‹ï¼Œå¯é€‰å€¼ä¸º [deepseek|gpt]ï¼Œé»˜è®¤ä½¿ç”¨gptã€‚"</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    model_choice = sys.argv[<span class="number">1</span>] <span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span> <span class="keyword">else</span> <span class="string">"gpt"</span></span><br><span class="line">    input_file = os.path.expanduser(<span class="string">'~/Desktop/test2.xlsx'</span>)</span><br><span class="line">    output_file = os.path.expanduser(<span class="string">'~/Desktop/translated_output.xlsx'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        process_excel(input_file, output_file, model_choice)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        print(<span class="string">f"è¿è¡Œå¤±è´¥: <span class="subst">&#123;str(e)&#125;</span>"</span>)</span><br><span class="line">        exit(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨æ–¹å¼</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line">#gpt</span><br><span class="line"><span class="keyword">python3</span> /Users/<span class="keyword">cc</span>/Desktop/ClassTranslate/autoTranslate.<span class="keyword">py</span></span><br><span class="line">#deepseek</span><br><span class="line"><span class="keyword">python3</span> /Users/<span class="keyword">cc</span>/Desktop/ClassTranslate/autoTranslate.<span class="keyword">py</span> deepseek</span><br></pre></td></tr></table></figure>

<p>è„šæœ¬é€»è¾‘ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œé…ç½®äº†æœ€å¤§tokenæ•°ï¼Œæ”¯æŒåˆ†æ‰¹æ¬¡æ‰¹é‡è¯·æ±‚ï¼Œä¹Ÿè€ƒè™‘äº†ç¿»è¯‘å¤±è´¥ç­‰æƒ…å†µã€‚ç¿»è¯‘å¡«å……åä¼šä¿®æ”¹Excelæ–‡æœ¬æ¡†é¢œè‰²ï¼Œæ–¹ä¾¿äººå·¥æ£€æµ‹ã€‚å¯ä»¥æ ¹æ®å„APPä¸åŒè¯·æ±‚ä¿®æ”¹system_promptä»‹ç»ï¼Œè®©ç¿»è¯‘æ›´å‡†ç¡®ã€‚</p>
<p>è„šæœ¬Gitåœ°å€ï¼š<a href="https://gitlab.corp.youdao.com/liwc/excelToXilff/-/blob/master/autoTranslate.py" target="_blank" rel="noopener">https://gitlab.corp.youdao.com/liwc/excelToXilff/-/blob/master/autoTranslate.py</a></p>
<p>æµ‹è¯•Excelåœ°å€ï¼š<a href="https://gitlab.corp.youdao.com/liwc/excelToXilff/-/blob/master/test1.xlsx" target="_blank" rel="noopener">https://gitlab.corp.youdao.com/liwc/excelToXilff/-/blob/master/test1.xlsx</a><br>3.æ•ˆæœæ¼”ç¤º</p>
<p>DeepSeekæ¼”ç¤ºï¼š</p>
<video src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/202507142008031.mp4" controls="controls">
</video>


<p>GPTæ•ˆæœæ¼”ç¤ºï¼š</p>
<video src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/202507142015187.mp4" controls="controls">

</video>

<p>è¿™ä¸ªè„šæœ¬ä¹Ÿå¯ä»¥å•ç‹¬ä½¿ç”¨ï¼Œåªåšæœ¬åœ°Excelæ‰¹é‡ç¿»è¯‘ï¼Œä¹Ÿå¯ä»¥ä¸²è”èµ·iOSå›½é™…åŒ–â€”xliffè‡ªåŠ¨å½•å…¥è„šæœ¬å®ç°Xcodeå›½é™…åŒ–æ–‡æ¡ˆå½•å…¥çº¯è‡ªåŠ¨åŒ–ã€‚å…·ä½“è¿‡ç¨‹ä¸å†é˜è¿°ã€‚</p>
<p>ä¸²è”æ•ˆæœæ¼”ç¤ºï¼šï¼ˆå¯ä»¥åšåˆ°å…¨è‡ªåŠ¨è°ƒç”¨ è¿™é‡Œæˆ‘åˆ†å¼€æ˜¯ä¸ºäº†æ£€æŸ¥ç¿»è¯‘æ–‡æœ¬è´¨é‡ åç»­è§‰å¾—ç¿»è¯‘ç¨³å®š å°±å¯ä»¥å…¨è‡ªåŠ¨åŒ–ï¼‰</p>
<video src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/202507142023894.mp4" controls="controls">
</video>
ä½¿ç”¨è¿‡ç¨‹æœ‰ä»»ä½•é—®é¢˜ æ¬¢è¿è”ç³»å’Œäº¤æµï¼š

<hr>
<p>æä¼Ÿç¿</p>
<p>ç½‘æ˜“æœ‰é“ å›½é™…APPäº§å“éƒ¨</p>
<p>liweican#corp.netease.com</p>
<p>æ„Ÿè°¢æ‚¨çš„é˜…è¯»~</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2023/01/02/iOS%E5%8E%9F%E7%94%9F%E6%96%87%E6%A1%A3%E6%89%AB%E6%8F%8F%E5%AE%9E%E7%8E%B0%E2%80%94%E2%80%94Vision-CoreImage/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img/avatar.png">
      <meta itemprop="name" content="weican Li">
      <meta itemprop="description" content="iOS Developer">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="licc">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/01/02/iOS%E5%8E%9F%E7%94%9F%E6%96%87%E6%A1%A3%E6%89%AB%E6%8F%8F%E5%AE%9E%E7%8E%B0%E2%80%94%E2%80%94Vision-CoreImage/" class="post-title-link" itemprop="url">iOSåŸç”Ÿæ–‡æ¡£æ‰«æå®ç°â€”â€”Vision&CoreImage</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-01-02 22:28:00" itemprop="dateCreated datePublished" datetime="2023-01-02T22:28:00+08:00">2023-01-02</time>
            </span>

          
            <span id="/2023/01/02/iOS%E5%8E%9F%E7%94%9F%E6%96%87%E6%A1%A3%E6%89%AB%E6%8F%8F%E5%AE%9E%E7%8E%B0%E2%80%94%E2%80%94Vision-CoreImage/" class="post-meta-item leancloud_visitors" data-flag-title="iOSåŸç”Ÿæ–‡æ¡£æ‰«æå®ç°â€”â€”Vision&CoreImage" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2023/01/02/iOS%E5%8E%9F%E7%94%9F%E6%96%87%E6%A1%A3%E6%89%AB%E6%8F%8F%E5%AE%9E%E7%8E%B0%E2%80%94%E2%80%94Vision-CoreImage/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2023/01/02/iOS%E5%8E%9F%E7%94%9F%E6%96%87%E6%A1%A3%E6%89%AB%E6%8F%8F%E5%AE%9E%E7%8E%B0%E2%80%94%E2%80%94Vision-CoreImage/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>å›½é™…è¯å…¸å›¢é˜Ÿè‡´åŠ›äºæ‰“é€ é«˜è´¨é‡å‡ºæµ·å·¥å…·ç±»Appäº§å“çŸ©é˜µï¼Œç›®å‰æ——ä¸‹æœ‰</p>
<ul>
<li>è¯å…¸ç¿»è¯‘ç±»ï¼š U-Dictionaryã€One Translate</li>
<li>è¯­éŸ³è½¬å†™ç±»ï¼šiRecordã€iTranscribe</li>
<li>ç”µè¯å½•éŸ³ç±»ï¼šiCall Record</li>
</ul>
<p>åœ¨2022å¹´åº•ï¼ŒiOSç«¯éœ€è¦å¼€å‘ä¸€ä¸ªæ–°çš„æ–‡æ¡£æ‰«æç±»äº§å“ï¼šiScannerï¼Œæ­¤ç±»äº§å“åœ¨å®‰å“ç«¯å·²ç»éªŒè¯äº†å•†ä¸šåŒ–å¯è¡Œæ€§ã€‚<br>å¼€å‘æ—¶é—´åªæœ‰çŸ­çŸ­å‡ å‘¨ï¼Œéœ€è¦å¿«é€Ÿè¿›è¡ŒæŠ€æœ¯è°ƒç ”å’Œæ–¹æ¡ˆç¡®å®šã€‚<br>æ ¸å¿ƒåŠŸèƒ½å°±æ˜¯ç”¨æˆ·ä½¿ç”¨ç›¸æœºæ‹æ‘„æˆ–ç›¸å†Œé€‰æ‹©å›¾ç‰‡ï¼Œè‡ªåŠ¨æ¡†é€‰å‡ºå›¾ç‰‡å†…çš„æ–‡æ¡£è½®å»“ï¼Œè£å‰ªåè¿›è¡Œæ–¹å‘çŸ«æ­£ã€‚<br>æ‹¿åˆ°çŸ«æ­£åçš„å›¾ç‰‡è°ƒç”¨æœ‰é“è‡ªç ”çš„æ–‡æ¡£å¢åŠ æ¥å£å’Œæ‰‹å†™æ“¦é™¤æ¥å£ã€‚</p>
<p>å…ˆçœ‹ä¸€ä¸‹æœ€ç»ˆå®ç°æ•ˆæœï¼š<br><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/202303132305737.gif" alt=""></p>
<h1 id="æŠ€æœ¯é€‰å‹-amp-å®ç°"><a href="#æŠ€æœ¯é€‰å‹-amp-å®ç°" class="headerlink" title="æŠ€æœ¯é€‰å‹&amp;å®ç°"></a>æŠ€æœ¯é€‰å‹&amp;å®ç°</h1><p>å®¢æˆ·ç«¯éœ€è¦å®ç°çš„æ ¸å¿ƒåŠŸèƒ½æœ‰2ä¸ªï¼š</p>
<ol>
<li>æ–‡æ¡£è§’ç‚¹æ£€æµ‹</li>
<li>å›¾ç‰‡æ–¹å‘çŸ«æ­£ï¼ˆé€è§†çŸ«æ­£ï¼‰</li>
</ol>
<h4 id="1-è§’ç‚¹æ£€æµ‹"><a href="#1-è§’ç‚¹æ£€æµ‹" class="headerlink" title="1.è§’ç‚¹æ£€æµ‹"></a>1.è§’ç‚¹æ£€æµ‹</h4><h5 id="è‡ªç ”SDK"><a href="#è‡ªç ”SDK" class="headerlink" title="è‡ªç ”SDK"></a>è‡ªç ”SDK</h5><p>å®‰å“ç«¯çš„æ–¹æ¡ˆ:</p>
<ol>
<li>æ–‡æ¡£è„šç‚¹ç›‘æµ‹ä½¿ç”¨ç®—æ³•ç«¯æä¾›çš„è‡ªç ”SDKï¼Œåº•å±‚æ¨¡å‹ä½¿ç”¨C++å®ç°ï¼Œæ¨ç†æ¡†æ¶ç”¨çš„MNNï¼ˆMobile Neural Networkï¼‰</li>
<li>å›¾ç‰‡çŸ«æ­£ä½¿ç”¨çš„æ˜¯opencvçš„é€è§†å˜æ¢</li>
</ol>
<p>ä¸å¹¸çš„æ˜¯è‡ªç ”æ¨¡å‹å¹¶æ²¡æœ‰æä¾›iOSç«¯çš„SDKï¼Œåº•å±‚ä½¿ç”¨C++éœ€è¦è‡ªå·±æ¡¥æ¥ä¸‹æä¾›ç›¸å…³çš„æ¥å£ã€‚<br>æœ‰é“è¿˜æœ‰ä¸€å¥—åœ¨çº¿çš„æ–‡æ¡£è§’ç‚¹æ£€æµ‹æœåŠ¡ï¼Œä½†æ˜¯è€ƒè™‘åˆ°æµ·å¤–ç½‘ç»œç¯å¢ƒå¤æ‚ï¼Œæœ€å¥½è¿˜æ˜¯ä½¿ç”¨ç¦»çº¿çš„ã€‚<br>å½“ç„¶opencvä¹Ÿæä¾›è§’ç‚¹æ£€æµ‹çš„èƒ½åŠ›ï¼Œä½†æ˜¯è¯†åˆ«ç‡å¤ªå·®ä¸åœ¨è€ƒè™‘èŒƒå›´å†…ã€‚</p>
<p>é‚£ä¹ˆiOSç«¯æœ‰åŸç”Ÿèƒ½åŠ›æ”¯æŒå—ï¼Ÿå…¶å®ç†Ÿæ‚‰iOSçš„åº”è¯¥éƒ½çŸ¥é“iOSç³»ç»Ÿå¤‡å¿˜å½•æ˜¯æä¾›æ–‡æ¡£æ‰«æçš„ï¼Œå¹¶ä¸”æ•ˆæœå¾ˆå¥½ã€‚<br>ç³»ç»Ÿå†…çš„å¤‡å¿˜å½•æ”¯æŒå¤šå¼ å›¾è¿ç»­æ‰«æï¼Œæ”¯æŒè„šç‚¹ç›‘æµ‹å’Œå›¾ç‰‡æ–¹å‘çŸ«æ­£ã€‚<br>Appleä¹Ÿå¼€æ”¾äº†æ¥å£ä¾›å¼€å‘è€…ä½¿ç”¨ï¼Œé‚£å°±æ˜¯<code>VisionKit</code>ä¸‹çš„<code>VNDocumentCameraViewController</code></p>
<h5 id="VisionKit"><a href="#VisionKit" class="headerlink" title="VisionKit"></a>VisionKit</h5><p>VisionKitæ˜¯iOS13æ¨å‡ºçš„ï¼Œä¸º iOS æä¾›äº†å›¾åƒå’Œå®æ—¶è§†é¢‘ä¸­çš„æ–‡æœ¬ã€ç»“æ„åŒ–æ•°æ®çš„æ£€æµ‹åŠŸèƒ½ã€‚<br>VisionKitæœ¬è´¨ä¸Šæ˜¯å¯¹Visionçš„å°è£…ï¼Œ<br>è€ŒVisionKitä¸‹<code>VNDocumentCameraViewController</code>æ˜¯å¯ä»¥ç›´æ¥ä½¿ç”¨çš„ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š<br><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/202303132304793.gif" alt=""><br>å…¶å†…ç½®äº†è„šç‚¹è‡ªåŠ¨æ£€æµ‹ï¼Œè„šç‚¹æ‹–æ‹½è°ƒæ•´ç­‰äº¤äº’ã€‚æ”¯æŒä»è§†é¢‘bufferæµä¸­ç›´æ¥æ£€æµ‹ã€‚<br>ä½†æ˜¯VNDocumentCameraViewControllerå°è£…çš„éå¸¸æ­»ï¼Œæ— æ³•ä¿®æ”¹å†…éƒ¨ä»»ä½•UIå’Œäº¤äº’æµç¨‹ï¼Œæ‰€ä»¥åªèƒ½pass</p>
<p>æ›´å¤šå…³äºVisionKitçš„ä¿¡æ¯å‚è€ƒï¼š<br><a href="https://developer.apple.com/documentation/visionkit" target="_blank" rel="noopener">Visionkit Documentation</a><br><a href="https://developer.apple.com/documentation/visionkit/vndocumentcameraviewcontroller" target="_blank" rel="noopener">VNDocumentCameraViewController</a></p>
<h5 id="Vision"><a href="#Vision" class="headerlink" title="Vision"></a>Vision</h5><p>æ—¢ç„¶<code>VisionKit</code>æ˜¯åŸºäº<code>Vision</code>çš„å°è£…ï¼Œé‚£ä¹ˆå®Œå…¨å¯ä»¥åŸºäºVisionè‡ªå·±æ¥å®ç°æ‰€æœ‰åŠŸèƒ½<br><code>VNDocumentCameraViewController</code>åˆšæ¨å‡ºæ—¶å€™å½“æ—¶çš„åº•å±‚æŠ€æœ¯æ˜¯åŸºäº<code>Vision</code>çš„<code>VNDetectRectanglesRequest</code><br><code>VNDetectRectanglesRequest</code>ä¼šç›‘æµ‹å›¾ç‰‡ä¸­æ‰€æœ‰çŸ©å½¢å¹¶è¿”å›ä¸€ä¸ªæ•°ç»„ï¼Œä¾èµ–<code>VNDetectRectanglesRequest</code>å†åŠ ä¸ŠåæœŸç®—æ³•ï¼Œæ˜¯å¯ä»¥è¿›è¡Œæ–‡æ¡£æ£€æµ‹çš„ã€‚</p>
<p>ä½†æ˜¯Appleåœ¨iOS15æ—¶å€™å‘å¸ƒäº†æ–°API<code>VNDetectDocumentSegmentationRequest</code><br>çœ‹APIçš„åå­—å°±èƒ½çŸ¥é“æ˜¯é’ˆå¯¹æ–‡æ¡£è¿›è¡Œäº†å•ç‹¬ä¼˜åŒ–çš„ï¼Œé‚£ä¹ˆ<code>VNDetectDocumentSegmentationRequest</code>æ¯”<code>VNDetectRectanglesRequest</code>å‰å®³åœ¨å“ªé‡Œå‘¢ï¼Ÿ</p>
<p><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/202303132301313.png" alt=""></p>
<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒåŒä¸€å¼ å›¾ç‰‡ï¼ŒVNDetectRectanglesRequestæ£€æµ‹å‡ºäº†æ‰€æœ‰çŸ©å½¢ï¼Œè€ŒVNDetectDocumentSegmentationRequestå‡†ç¡®çš„æ£€æµ‹å‡ºäº†æ–‡æ¡£ã€‚<br>åœ¨åº•å±‚æŠ€æœ¯ä¸Šï¼ŒåŒºåˆ«å¦‚ä¸‹ï¼š<br><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/202303132301486.png" alt=""></p>
<p><code>DocumentSegmentation</code>åŸºäºæœºå™¨å­¦ä¹ å¹¶ä¸”èƒ½å¤Ÿè¿è¡Œåœ¨NEï¼ˆç¥ç»ç½‘ç»œå¼•æ“ï¼‰,CPUæˆ–è€…GPUä¸Šé¢ï¼Œè€Œ<code>VNDetectRectanglesRequest</code>åªèƒ½åœ¨CPUä¸Šè¿è¡Œï¼Œè¿è¡Œé€Ÿåº¦ä¸Šå°±æ‹‰å¼€äº†å¾ˆå¤§å·®è·ã€‚<br><code>DocumentSegmentation</code>è¿˜èƒ½è¯†åˆ«å‡ºéçŸ©å½¢å½¢çŠ¶çš„æ–‡æ¡£ï¼Œè¿˜èƒ½æä¾›maskå’Œé¡¶è§’ç‚¹åæ ‡ã€‚<br>æ›´é‡è¦çš„æ˜¯<code>VNDetectDocumentSegmentationRequest</code>åªä¼šè¯†åˆ«å‡ºä¸€ä¸ªæ–‡æ¡£è€Œä¸ä¼šæ£€æµ‹å‡ºå¤šä¸ªçŸ©å½¢ï¼Œè¿™æ— ç–‘å‡è½»äº†å¾ˆå¤šå·¥ä½œé‡ï¼Œå¯ä»¥ç›´æ¥æ‹¿æ¥ä½¿ç”¨ã€‚</p>
<blockquote>
<p>å¦å¤–ï¼Œ<code>Visionkit</code>ä¸­çš„<code>VNDocumentCameraViewController</code>åº•å±‚æŠ€æœ¯ï¼Œåœ¨iOS15ä¹‹åä¹Ÿå·²ç»æ›¿æ¢æˆäº†<code>VNDetectDocumentSegmentationRequest</code></p>
</blockquote>
<h5 id="VNDetectDocumentSegmentationRequest"><a href="#VNDetectDocumentSegmentationRequest" class="headerlink" title="VNDetectDocumentSegmentationRequest"></a>VNDetectDocumentSegmentationRequest</h5><p>VNDetectDocumentSegmentationRequestçš„ä½¿ç”¨éå¸¸ç®€å•</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">recognize</span><span class="params">(image: UIImage)</span></span> -&gt; <span class="type">VNRectangleObservation?</span> &#123;</span><br><span class="line">      nextBtn.isEnabled = <span class="literal">true</span></span><br><span class="line">      <span class="keyword">guard</span> <span class="keyword">let</span> cgImage = image.cgImage <span class="keyword">else</span> &#123; <span class="keyword">return</span> <span class="literal">nil</span> &#125;</span><br><span class="line">      <span class="keyword">let</span> documentSegmentationHandler = <span class="type">VNImageRequestHandler</span>(cgImage: cgImage)</span><br><span class="line">      <span class="keyword">let</span> documentSegmentationRequest = <span class="type">VNDetectDocumentSegmentationRequest</span>()</span><br><span class="line">      documentSegmentationRequest.revision = <span class="type">VNDetectDocumentSegmentationRequestRevision1</span></span><br><span class="line">      <span class="keyword">try</span>? documentSegmentationHandler.perform([documentSegmentationRequest])</span><br><span class="line">      <span class="keyword">if</span> <span class="keyword">let</span> result = documentSegmentationRequest.results?.first &#123;</span><br><span class="line">          <span class="built_in">print</span>(result.confidence)</span><br><span class="line">          <span class="keyword">if</span> result.confidence &gt; <span class="number">0.7</span> &#123;</span><br><span class="line">              <span class="keyword">return</span> result</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">print</span>(<span class="string">"æœªæ£€æµ‹åˆ°æ–‡æ¡£"</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>æ³¨æ„ï¼š<br>åœ¨ä¼ å…¥å›¾ç‰‡å‰è¯·å¤„ç†å¥½å›¾ç‰‡çš„imageOrientation<br>VNImageRequestHandlerä¹Ÿæ”¯æŒciImageçš„åˆå§‹åŒ–ï¼Œå¯ä»¥åˆç†é€‰æ‹©ä½¿ç”¨æ–¹å¼</p>
</blockquote>
<p>åœ¨resultä¸­ä¼šè¿”å›ä¸€ä¸ªç½®ä¿¡åº¦ï¼Œä¸€èˆ¬è®¾ç½®å¤§äº0.7å°±è®¤ä¸ºè¯†åˆ«æœ‰æ•ˆï¼Œå…·ä½“å‚æ•°å¯ä»¥åŠ¨æ€è°ƒæ•´ã€‚<br>è¿”å›ç»“æœæ˜¯<code>VNRectangleObservation</code>ç±»å‹</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="meta">@available(iOS 11.0, *)</span></span><br><span class="line"><span class="keyword">open</span> <span class="class"><span class="keyword">class</span> <span class="title">VNRectangleObservation</span> : <span class="type">VNDetectedObjectObservation &#123;</span></span></span><br><span class="line">    <span class="meta">@available(iOS 13.0, *)</span></span><br><span class="line">    <span class="keyword">public</span> convenience <span class="keyword">init</span>(requestRevision: <span class="built_in">Int</span>, topLeft: CGPoint, bottomLeft: CGPoint, bottomRight: CGPoint, topRight: CGPoint)</span><br><span class="line">    <span class="keyword">open</span> <span class="keyword">var</span> topLeft: CGPoint &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">    <span class="keyword">open</span> <span class="keyword">var</span> topRight: CGPoint &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">    <span class="keyword">open</span> <span class="keyword">var</span> bottomLeft: CGPoint &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">    <span class="keyword">open</span> <span class="keyword">var</span> bottomRight: CGPoint &#123; <span class="keyword">get</span> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¹‹å‰ç”¨è¿‡Visionçš„åŒå­¦è‚¯å®šå¾ˆç†Ÿæ‚‰çˆ¶ç±»<code>VNDetectedObjectObservation</code>,åœ¨<code>VNDetectedObjectObservation</code>ä¸­æœ‰ä¸€ä¸ª<code>boundingBox</code>ç†Ÿæ‚‰</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*!</span></span><br><span class="line"><span class="comment">    @brief The bounding box of the detected object. The coordinates are normalized to the dimensions of the processed image, with the origin at the image's lower-left corner.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>, <span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">CGRect</span> boundingBox;</span><br></pre></td></tr></table></figure>
<p><code>boundingBox</code> ä¸­çš„åæ ‡è¢«å½’ä¸€åŒ–ï¼Œæ„å‘³ç€ xã€yã€å®½åº¦å’Œé«˜åº¦éƒ½æ˜¯ 0.0 åˆ° 1.0 ä¹‹é—´çš„å°æ•°ï¼ŒåŒæ—¶åŸç‚¹ (0,0) åœ¨å·¦ä¸‹è§’ï¼Œè¿™äº›éƒ½éœ€è¦æˆ‘ä»¬è‡ªå·±æ¥è½¬æ¢ã€‚<br><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/202303132301074.png" alt=""><br>åŒæ ·åœ¨æ–‡æ¡£è§’ç‚¹æ£€æµ‹ä¸­è¿”å›çš„å››ä¸ªè„šç‚¹<code>topLeft</code>,<code>topRight</code>,<code>bottomLeft</code>,<code>bottomRight</code>,ä¹Ÿæ˜¯å½’ä¸€åŒ–çš„ï¼Œèµ·ç‚¹åœ¨å·¦ä¸‹è§’ï¼Œéœ€è¦è¿›è¡Œåæ ‡è½¬æ¢åæ‰èƒ½åœ¨å›¾ç‰‡ä¸Šå±•ç¤ºè¯†åˆ«æ¡†ã€‚</p>
<p>è¿™é‡Œæœ‰ä¸€ä¸ªå°æŠ€å·§ï¼Œå…ˆæŠŠåŸå›¾è¿›è¡Œ<code>imageOrientation</code>å¤„ç†å’Œå°ºå¯¸å‹ç¼©ï¼Œå±•ç¤ºåœ¨å±å¹•ä¸Šåå»ºç«‹ä¸€ä¸ªå’Œå±•ç¤ºimageå¤§å°ä¸€è‡´çš„CALayerå›¾å±‚ï¼Œåç»­æ¡†ä½“å±•ç¤ºã€æ‹–æ‹½ã€æ—‹è½¬ç­‰éƒ½æ–¹ä¾¿å¤„ç†ã€‚<br><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/202303132302468.png" alt=""><br>åæ ‡è½¬æ¢ä»£ç </p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> size = self.pathLayer!.bounds</span><br><span class="line">var transform: CGAffineTransform</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="module-access"><span class="module"><span class="identifier">UIApplication</span>.</span></span>shared.statusBarOrientation.isLandscape &#123;</span><br><span class="line">    transform = <span class="module-access"><span class="module"><span class="identifier">CGAffineTransform</span>.</span></span>identity</span><br><span class="line">        .scaled<span class="constructor">By(<span class="params">x</span>: -1, <span class="params">y</span>: 1)</span></span><br><span class="line">        .translated<span class="constructor">By(<span class="params">x</span>: -<span class="params">size</span>.<span class="params">width</span>, <span class="params">y</span>: 0)</span></span><br><span class="line">        .scaled<span class="constructor">By(<span class="params">x</span>: <span class="params">size</span>.<span class="params">width</span>, <span class="params">y</span>: <span class="params">size</span>.<span class="params">height</span>)</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    transform = <span class="module-access"><span class="module"><span class="identifier">CGAffineTransform</span>.</span></span>identity</span><br><span class="line">        .scaled<span class="constructor">By(<span class="params">x</span>: 1, <span class="params">y</span>: -1)</span></span><br><span class="line">        .translated<span class="constructor">By(<span class="params">x</span>: 0, <span class="params">y</span>: -<span class="params">size</span>.<span class="params">height</span>)</span></span><br><span class="line">        .scaled<span class="constructor">By(<span class="params">x</span>: <span class="params">size</span>.<span class="params">width</span>, <span class="params">y</span>: <span class="params">size</span>.<span class="params">height</span>)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è½¬æ¢ä¸ºUIKitåæ ‡ç³»</span></span><br><span class="line">convertedTopLeft = result.topLeft.applying(transform)</span><br><span class="line">convertedTopRight = result.topRight.applying(transform)</span><br><span class="line">convertedBottomLeft = result.bottomLeft.applying(transform)</span><br><span class="line">convertedBottomRight = result.bottomRight.applying(transform)</span><br></pre></td></tr></table></figure>

<p>å½“ç„¶åªæ˜¯æ¡†é€‰å‡ºæ¥æ–‡æ¡£æ¡†æ¶æ‰æ˜¯ç¬¬ä¸€æ­¥ï¼Œç”¨æˆ·è¿˜èƒ½æ‹–æ‹½è„šç‚¹ç¼–è¾‘æ¡†é€‰åŒºåŸŸã€‚æ‰€ä»¥åæ ‡ç‚¹è¿˜éœ€è¦åå‘è½¬æ¢ã€‚<br>åšæ¡†é€‰ä¸­ï¼Œè¿˜éœ€è¦åˆ¤æ–­çŸ©å½¢æ˜¯å¦æœ‰æ•ˆï¼ˆå†…è§’æ˜¯å¦å¤§äº180åº¦ï¼‰ï¼Œå¯ä»¥æ ¹æ®å¯¹è§’çº¿ <code>ac</code> å’Œ <code>bd</code> å¯¹è§’çº¿æ˜¯å¦äº¤å‰ æ ¹æ®å‰ç§¯(å‘é‡ç§¯)è®¡ç®—<br><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/202303132305134.gif" alt=""></p>
<p>å·®ç§¯ç®—æ³•</p>
<figure class="highlight llvm"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> func checkInnerAngleAvailable() -&gt; Bool &#123;</span><br><span class="line">       let <span class="keyword">x</span><span class="number">1</span> = self.topLeftPoint.<span class="keyword">x</span></span><br><span class="line">       let y<span class="number">1</span> = self.topLeftPoint.y</span><br><span class="line">       let <span class="keyword">x</span><span class="number">2</span> = self.bottomRightPoint.<span class="keyword">x</span></span><br><span class="line">       let y<span class="number">2</span> = self.bottomRightPoint.y</span><br><span class="line">       let <span class="keyword">x</span><span class="number">3</span> = self.bottomLeftPoint.<span class="keyword">x</span></span><br><span class="line">       let y<span class="number">3</span> = self.bottomLeftPoint.y</span><br><span class="line">       let <span class="keyword">x</span><span class="number">4</span> = self.topRightPoint.<span class="keyword">x</span></span><br><span class="line">       let y<span class="number">4</span> = self.topRightPoint.y</span><br><span class="line">       </span><br><span class="line">       if <span class="keyword">max</span>(<span class="keyword">x</span><span class="number">1</span>, <span class="keyword">x</span><span class="number">2</span>) &lt; <span class="keyword">min</span>(<span class="keyword">x</span><span class="number">3</span>, <span class="keyword">x</span><span class="number">4</span>) || <span class="keyword">max</span>(y<span class="number">1</span>, y<span class="number">2</span>) &lt; <span class="keyword">min</span>(y<span class="number">3</span>, y<span class="number">4</span>) || <span class="keyword">min</span>(<span class="keyword">x</span><span class="number">1</span>, <span class="keyword">x</span><span class="number">2</span>) &gt; <span class="keyword">max</span>(<span class="keyword">x</span><span class="number">3</span>, <span class="keyword">x</span><span class="number">4</span>) || <span class="keyword">min</span>(y<span class="number">1</span>, y<span class="number">2</span>) &gt; <span class="keyword">max</span>(y<span class="number">3</span>, y<span class="number">4</span>) &#123;</span><br><span class="line">           return <span class="keyword">false</span></span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">       if ((<span class="keyword">x</span><span class="number">3</span> - <span class="keyword">x</span><span class="number">1</span>) * (y<span class="number">3</span> - y<span class="number">4</span>) - (y<span class="number">3</span> - y<span class="number">1</span>) * (<span class="keyword">x</span><span class="number">3</span> - <span class="keyword">x</span><span class="number">4</span>)) * (</span><br><span class="line">                  (<span class="keyword">x</span><span class="number">3</span> - <span class="keyword">x</span><span class="number">2</span>) * (y<span class="number">3</span> - y<span class="number">4</span>) - (y<span class="number">3</span> - y<span class="number">2</span>) * (<span class="keyword">x</span><span class="number">3</span> - <span class="keyword">x</span><span class="number">4</span>)) &lt;= <span class="number">0</span> &amp;&amp; (</span><br><span class="line">                  (<span class="keyword">x</span><span class="number">1</span> - <span class="keyword">x</span><span class="number">3</span>) * (y<span class="number">1</span> - y<span class="number">2</span>) - (y<span class="number">1</span> - y<span class="number">3</span>) * (<span class="keyword">x</span><span class="number">1</span> - <span class="keyword">x</span><span class="number">2</span>)) * (</span><br><span class="line">                   (<span class="keyword">x</span><span class="number">1</span> - <span class="keyword">x</span><span class="number">4</span>) * (y<span class="number">1</span> - y<span class="number">2</span>) - (y<span class="number">1</span> - y<span class="number">4</span>) * (<span class="keyword">x</span><span class="number">1</span> - <span class="keyword">x</span><span class="number">2</span>)) &lt;= <span class="number">0</span> &#123;</span><br><span class="line">           return <span class="keyword">true</span></span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">       return <span class="keyword">false</span></span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆè„šç‚¹ç›‘æµ‹çš„æœ€ç»ˆæ–¹æ¡ˆä¹Ÿå®šä¸‹æ¥äº†ï¼Œä¸‹é¢æ¥çœ‹ä¸€ä¸‹å„ä¸ªæ–¹æ³•çš„è¯†åˆ«å¯¹æ¯”<br><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/202303132307587.png;%20charset=binary" alt=""><br><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/202303132307167.png;%20charset=binary" alt=""><br><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/202303132308623.png;%20charset=binary" alt=""></p>
<blockquote>
<p>å¯ä»¥çœ‹åˆ°Apple Visionä¸‹çš„<code>VNDetectDocumentSegmentationRequest</code>æ£€æµ‹æ•ˆæœæ˜¯ä¼˜äºè‡ªç ”æ¨¡å‹çš„ï¼Œéƒ¨åˆ†badcaseæ•ˆæœè¿˜è¶…è¿‡ä¹Ÿç«å“ã€‚<br>å½“ç„¶å”¯ä¸€çš„é™åˆ¶å°±æ˜¯iOS15+æ‰èƒ½ä½¿ç”¨ï¼Œä½†æ˜¯å‚è€ƒAppleæä¾›çš„ç³»ç»Ÿå æ¯”æ•°æ®ï¼Œæˆªæ­¢åˆ°2022å¹´5æœˆ iOS15ä»¥ä¸Šå æ¯”89%<br><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/202303132308674.png" alt=""><br>update:<br>Appleåœ¨<code>2023å¹´2æœˆ14æ—¥å…¬å¸ƒäº†æœ€æ–°æ•°æ®ï¼ŒiOS15ä»¥ä¸Šå æ¯”96%</code><br><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/202303132308595.png" alt=""></p>
</blockquote>
<p>åˆ°æ­¤å·²ç»å®Œæˆäº†æ–‡æ¡£è§’ç‚¹æ£€æµ‹ï¼Œæ¥ä¸‹æ¥è¦è§£å†³å›¾ç‰‡è§†è§‰çŸ«æ­£ã€‚</p>
<h4 id="2-é€è§†çŸ«æ­£"><a href="#2-é€è§†çŸ«æ­£" class="headerlink" title="2.é€è§†çŸ«æ­£"></a>2.é€è§†çŸ«æ­£</h4><p>å›¾ç‰‡çŸ«æ­£(é€è§†çŸ«æ­£)åœ¨OCRä¸­å¹¿æ³›ä½¿ç”¨ï¼Œä¸»æµåšæ³•å°±æ˜¯ä½¿ç”¨opencvè¿›è¡Œå¤„ç†ã€‚<br>åŸç†æœ‰å¾ˆå¤šï¼Œä¸€èˆ¬æ˜¯è¾¹ç¼˜æŠ•å½±çš„ã€Houghå˜æ¢ã€çº¿æ€§æ‹Ÿåˆï¼Œå‚…é‡Œå¶å˜æ¢å›¾åƒé¢‘åŸŸç­‰æ–¹æ³•ã€‚è¿™é‡Œä¸å†å±•å¼€è®²äº†ã€‚</p>
<p>å¹¶ä¸”opencvé‡Œé¢å¸¸ç”¨çš„æ˜¯çŸ©å½¢ç›‘æµ‹å’ŒçŸ«æ­£ä¸€èµ·ï¼Œæˆ‘ä»¬åœ¨ç¬¬ä¸€éƒ¨åˆ†å·²ç»å®Œæˆäº†è§’ç‚¹æ£€æµ‹ï¼Œåªæ˜¯åšçŸ©å½¢çŸ«æ­£å°±æ²¡å¿…è¦å†ç”¨opencväº†ã€‚</p>
<p>Apple VisionKitä¸­çš„<code>VNDocumentCameraViewController</code>æ˜¯æ”¯æŒæ–¹å‘çŸ«æ­£çš„ï¼Œé‚£ä¹ˆAppleè‡ªèº«æä¾›çš„APIåº”è¯¥æ˜¯å¯ä»¥å®ç°çš„ã€‚</p>
<p>é‚£æåˆ°Appleå†…ç½®çš„å›¾åƒå¤„ç†ï¼Œè‚¯å®šå°±ç»•ä¸å¼€<code>CoreImage</code>äº†</p>
<p><code>CoreImage</code>å¯ä»¥å®ç°å¤šç§å¤šæ ·çš„æ»¤é•œæ•ˆæœï¼Œæ»¤é•œä¸€èˆ¬åŸºäº<code>CIFilter</code>,åœ¨<code>CIFilter</code>ä¸­å°±æœ‰ç°æˆçš„çŸ©å½¢çŸ«æ­£ç®—æ³•ã€‚</p>
<p>æ›´å¤šå…³äºCoreImageçš„ä¿¡æ¯å‚è€ƒï¼š<br><a href="https://developer.apple.com/documentation/coreimage" target="_blank" rel="noopener">Core Image</a><br><a href="https://developer.apple.com/documentation/coreimage/cifilter" target="_blank" rel="noopener">CIFilter</a></p>
<h5 id="CIFilter"><a href="#CIFilter" class="headerlink" title="CIFilter"></a>CIFilter</h5><p>è¦å®ç°çŸ«æ­£ï¼Œé¦–å…ˆè¦æŠŠè§’ç‚¹æ£€æµ‹å4ä¸ªç‚¹å½¢æˆçš„å›¾ç‰‡è£å‰ªå‡ºæ¥ã€‚4ä¸ªç‚¹æ˜¯å½’ä¸€åŒ–åçš„ï¼Œå…ˆæŠŠå›¾ç‰‡è¿›è¡ŒCIImageè½¬æ¢,è°ƒç”¨croppedæ–¹æ³•è¿›è¡Œè£å‰ªã€‚</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"> <span class="meta">@objc</span> <span class="function"><span class="keyword">func</span> <span class="title">clipAction</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">var</span> image = <span class="keyword">self</span>.cleanImage</span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> ciImage = <span class="keyword">self</span>.cleanImage.ciImage ?? <span class="type">CIImage</span>(image: <span class="keyword">self</span>.imageView.image!) <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">                </span><br><span class="line">        <span class="comment">//é‡æ–°è®¡ç®—resultObservation</span></span><br><span class="line">        <span class="comment">//self.updateResultObservation()</span></span><br><span class="line">        </span><br><span class="line">        <span class="type">DispatchQueue</span>.global().async &#123;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> result = <span class="keyword">self</span>.resultObservation &#123;</span><br><span class="line">                <span class="keyword">let</span> imageSize = ciImage.extent.size</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">let</span> boundingBox = result.boundingBox.scaled(to: imageSize)</span><br><span class="line">                <span class="keyword">let</span> tmpImage = ciImage</span><br><span class="line">                    .cropped(to: boundingBox)</span><br><span class="line">                &#125;</span><br><span class="line">             &#125;</span><br><span class="line">                ......</span><br><span class="line">                ......</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//scaledæ˜¯ä¸€ä¸ªextension</span></span><br><span class="line">    <span class="class"><span class="keyword">extension</span> <span class="title">CGRect</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">scaled</span><span class="params">(to size: CGSize)</span></span> -&gt; <span class="type">CGRect</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">CGRect</span>(</span><br><span class="line">            x: <span class="keyword">self</span>.origin.x * size.width,</span><br><span class="line">            y: <span class="keyword">self</span>.origin.y * size.height,</span><br><span class="line">            width: <span class="keyword">self</span>.size.width * size.width,</span><br><span class="line">            height: <span class="keyword">self</span>.size.height * size.height</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‹¿åˆ°è£å‰ªåçš„å›¾ç‰‡ï¼Œå°±å¯ä»¥è¿›è¡Œé€è§†çŸ«æ­£äº†ï¼ŒiOSä¸­é€è§†çŸ«æ­£ä½¿ç”¨<code>CIVector</code><br><code>CIVector</code>éœ€è¦æ­é…<code>CIFilter</code>ä½¿ç”¨ï¼Œå¯ä»¥äº§ç”Ÿä¸°å¯Œçš„æ•ˆæœ</p>
<p>åœ†å½¢ç¼ ç»•è¿‡æ»¤å™¨</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> newImage = applying<span class="constructor">Filter(CICircularWrap, <span class="params">parameters</span>: [<span class="params">kCIInputImageKey</span>: <span class="params">image</span>, <span class="params">kCIInputCenterKey</span> : CIVector.<span class="params">init</span>(<span class="params">x</span>: 100, <span class="params">y</span>: 200)</span>, kCIInputRadiusKey : <span class="number">20</span>, kCIInputAngleKey : <span class="number">3</span>])</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/202303132308858.png" alt=""><br>è¾¹ç¼˜é‡‡æ ·è¿‡æ»¤å™¨</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">applying<span class="constructor">Filter(<span class="string">"CIEdgePreserveUpsampleFilter"</span>, <span class="params">parameters</span>: [<span class="params">kCIInputImageKey</span>: <span class="params">image</span>, <span class="params">inputLumaSigma</span> : 0.15, <span class="params">inputSpatialSigma</span> : 3, <span class="params">inputSmallImage</span> : <span class="params">image2</span>])</span></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/202303132309709.png" alt=""></p>
<p>è€Œæˆ‘ä»¬è¦ä½¿ç”¨çš„å°±æ˜¯çŸ©å½¢çŸ«æ­£è¿‡æ»¤å™¨<code>CIPerspectiveCorrection</code></p>
<p>ä¸‹é¢æ˜¯åšçš„ä¸€ä¸ªExtension,åªéœ€è¦ä¼ é€’å››ä¸ªè¿˜åŸåçš„åæ ‡å³å¯å®ŒæˆçŸ«æ­£</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">CIImage</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">perspectiveCorrect</span><span class="params">(by observation: VNRectangleObservation, imageSize: CGSize?)</span></span> -&gt; <span class="type">CIImage</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> imageSize = imageSize ?? <span class="keyword">self</span>.extent.size</span><br><span class="line">        <span class="keyword">let</span> newImage =</span><br><span class="line">        applyingFilter(<span class="string">"CIPerspectiveCorrection"</span>, parameters: [</span><br><span class="line">            <span class="string">"inputTopLeft"</span>: <span class="type">CIVector</span>(cgPoint: observation.topLeft.scaled(to: imageSize)),</span><br><span class="line">            <span class="string">"inputTopRight"</span>: <span class="type">CIVector</span>(cgPoint: observation.topRight.scaled(to: imageSize)),</span><br><span class="line">            <span class="string">"inputBottomLeft"</span>: <span class="type">CIVector</span>(cgPoint: observation.bottomLeft.scaled(to: imageSize)),</span><br><span class="line">            <span class="string">"inputBottomRight"</span>: <span class="type">CIVector</span>(cgPoint: observation.bottomRight.scaled(to: imageSize))</span><br><span class="line">        ])</span><br><span class="line">        <span class="keyword">return</span> newImage</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">CGPoint</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">scaled</span><span class="params">(to size: CGSize)</span></span> -&gt; <span class="type">CGPoint</span> &#123;</span><br><span class="line">        <span class="type">CGPoint</span>(x: x * size.width,</span><br><span class="line">                y: y * size.height)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>çœ‹ä¸€ä¸‹çŸ«æ­£æ•ˆæœ<br><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/202303132309782.gif" alt=""></p>
<hr>
<p>è‡³äºå…¶ä½™åŠŸèƒ½æ¯”å¦‚æœ€å°è£å‰ªå¤§å°ï¼Œæ—‹è½¬ï¼Œé•œåƒç­‰åŠŸèƒ½å°±ä¸å†è®¨è®ºäº†ã€‚è‡³æ­¤å·²ç»å®Œæˆäº†æ–‡æ¡£æ‰«æçš„æ ¸å¿ƒåŠŸèƒ½ã€‚</p>
<p>ä¼˜ç‚¹æœ‰å¾ˆå¤š</p>
<ul>
<li>çº¯ç¦»çº¿ï¼Œæ— ç½‘ç»œè¦æ±‚</li>
<li>è§’ç‚¹æ£€æµ‹é€Ÿåº¦å¿«ï¼Œèƒ½è¿è¡Œåœ¨GPUä¸Š</li>
<li>çº¯åŸç”Ÿæ”¯æŒï¼Œä¸ä¾èµ–ä¸‰æ–¹åº“</li>
<li>æ•ˆæœä¼˜äºè‡ªç ”SDK</li>
</ul>
<p>iScannerç›®å‰å·²ç»ä¸Šçº¿ï¼Œæ¬¢è¿å¤§å®¶å»ä½“éªŒï¼Œå¦‚æœæœ‰å…¶ä»–ç–‘é—®ä¹Ÿå¯ä»¥å’Œæˆ‘è”ç³»</p>
<blockquote>
<p>æä¼Ÿç¿<br>ç½‘æ˜“æœ‰é“-å›½é™…App<br>liweican#corp.netease.com</p>
</blockquote>
<p>æ„Ÿè°¢é˜…è¯»~</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/08/19/iOS%E6%8A%95%E6%94%BE%E5%BD%92%E5%9B%A0%E2%80%94SKAN3-0%E5%AE%9E%E6%88%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img/avatar.png">
      <meta itemprop="name" content="weican Li">
      <meta itemprop="description" content="iOS Developer">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="licc">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/08/19/iOS%E6%8A%95%E6%94%BE%E5%BD%92%E5%9B%A0%E2%80%94SKAN3-0%E5%AE%9E%E6%88%98/" class="post-title-link" itemprop="url">iOSæŠ•æ”¾å½’å› â€”SKAN3.0å®æˆ˜</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-08-19 22:34:00" itemprop="dateCreated datePublished" datetime="2022-08-19T22:34:00+08:00">2022-08-19</time>
            </span>

          
            <span id="/2022/08/19/iOS%E6%8A%95%E6%94%BE%E5%BD%92%E5%9B%A0%E2%80%94SKAN3-0%E5%AE%9E%E6%88%98/" class="post-meta-item leancloud_visitors" data-flag-title="iOSæŠ•æ”¾å½’å› â€”SKAN3.0å®æˆ˜" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2022/08/19/iOS%E6%8A%95%E6%94%BE%E5%BD%92%E5%9B%A0%E2%80%94SKAN3-0%E5%AE%9E%E6%88%98/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2022/08/19/iOS%E6%8A%95%E6%94%BE%E5%BD%92%E5%9B%A0%E2%80%94SKAN3-0%E5%AE%9E%E6%88%98/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>èƒŒæ™¯</p>
<p>åœ¨iOS14.5ä»¥åAppleå¯ç”¨ATTï¼ˆAppTransparencyTrackingï¼‰ã€‚ATT æ„å‘³ç€ï¼Œå¦‚æœä½ çš„åº”ç”¨ç¨‹åºæ”¶é›†æœ‰å…³æœ€ç»ˆç”¨æˆ·çš„æ•°æ®å¹¶ä¸å…¶ä»–å…¬å¸å…±äº«ä»¥è·¨åº”ç”¨ç¨‹åºå’Œç½‘ç«™è¿›è¡Œè·Ÿè¸ªï¼ˆIDFAï¼‰ï¼Œåˆ™å¿…é¡»ä½¿ç”¨ ATT åŒæ„æç¤ºå¹¶åœ¨å‘å¸ƒå•†å’Œå¹¿å‘Šå•†åº”ç”¨ç¨‹åºä¸­è·å¾—ç”¨æˆ·åŒæ„ã€‚å¦‚æœä¸è·Ÿè¸ªï¼Œåˆ™æ— éœ€æ˜¾ç¤ºæç¤ºã€‚<br><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/202303132252093.png" alt=""></p>
<p>ATTæ”¿ç­–æ­£åœ¨åŠ é€Ÿç§»åŠ¨å¹¿å‘Šè¡Œä¸šè·ƒå˜ï¼Œç”¨äºå¹¿å‘Šè¿½è¸ªçš„ IDFA æˆ–å°†é€æ¸æ·¡å‡ºå†å²èˆå°ï¼Œè‡³æ­¤iOSè¿›å…¥åIDFAæ—¶ä»£ã€‚</p>
<p>Appleç»™å‡ºçš„è§£å†³æ–¹æ¡ˆæ­£æ˜¯SKAdNetWork(SKAN),ä½†æ˜¯SKANå¹¶ä¸æ˜¯iOS14.5ä¹‹åæ‰å‘å¸ƒçš„ï¼ŒSKAN 1.0æ˜¯Appleäº2018å¹´æ¨å‡ºçš„APIï¼Œåœ¨iOS14.5æ¨å‡ºATTåæ¨å‡º2.0ã€‚åç»­æ›´æ–°åˆ°äº†3.0ç‰ˆæœ¬ï¼Œåœ¨iOS16.1åæ¨å‡ºäº†å…¨æ–°çš„SKAN 4.0ç‰ˆæœ¬ã€‚</p>
<p>å¤§è§„æ¨¡çš„ä½¿ç”¨æ˜¯åœ¨SKAN 3.0ç‰ˆæœ¬ï¼Œæˆ‘ä»¬ä¹Ÿæ˜¯åœ¨3.0ç‰ˆæœ¬å¼€å§‹æ¥å…¥ã€‚ä¸‹é¢å…ˆç®€å•ä»‹ç»ä¸‹SKANå½’å› çš„åŸç†ã€‚</p>
<p>SKAN3.0å½’å› æµç¨‹</p>
<p>ä¸‹é¢æ˜¯å½’å› çš„æµç¨‹å›¾ï¼Œçœ‹ä¸æ‡‚æ²¡å…³ç³»ï¼Œå…ˆææ˜ç™½å‡ ä¸ªæ¦‚å¿µã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/202303132254060.png" alt=""></p>
<p>1.Conversion value (CV)</p>
<p>ä¸Šå›¾æœ‰2ä¸ªæ–¹æ³•registerAppforAdNetworkattribution()å’ŒupdateConversionValue(:_)</p>
<p>updateConversionValue(:_)æåˆ°äº†ConversionValueå°±æ˜¯å½’å› çš„é‡ç‚¹ã€‚</p>
<p>ä½ å¯ä»¥ç†è§£æˆAppleæœ€åå›ä¼ ç»™å¹¿å‘Šä¸»çš„å°±æ˜¯è¿™ä¸ªCVå€¼ï¼Œå–å€¼èŒƒå›´åœ¨0-63ä¹‹é—´ã€‚</p>
<p>ä¸ºä»€ä¹ˆæ˜¯0-63å‘¢ï¼Œå› ä¸ºè¿™ä¸ªCVæ˜¯ä¸€ä¸ª6bitçš„å€¼ï¼Œåœ¨äºŒè¿›åˆ¶ä¸­å–å€¼èŒƒå›´ä¸­å°±æ˜¯0-63ä¹‹é—´ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/202303132254389.png" alt=""></p>
<p>SKANçš„é‡ç‚¹å°±æ˜¯åˆç†åˆ©ç”¨è¿™ä¸ª64ä¸ªæ•°</p>
<p>CVå€¼æ˜¯å¯ä»¥æ›´æ–°çš„ï¼Œè°ƒç”¨updateConversionValueå³å¯æ›´æ–°ã€‚ä½†æ˜¯æ–°çš„å€¼å¿…é¡»æ¯”æ—§çš„å¤§ï¼Œå¦åˆ™ä¸ç”Ÿæ•ˆã€‚</p>
<p>2.è®¡æ—¶å™¨æŒ‘æˆ˜</p>
<p><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/202303132255621.png" alt=""></p>
<p>Appleåœ¨SKANä¸­è®¾è®¡äº†ä¸€ä¸ªè®¡æ—¶å™¨åŠŸèƒ½ï¼ŒAppé¦–æ¬¡å®‰è£…æ—¶å€™é¦–å…ˆè°ƒç”¨registerAppforAdNetworkattribution()</p>
<p>å¼€å‘è€…å¯ä»¥åœ¨24å°æ—¶çš„å¾ªç¯å‘¨æœŸå†…åå¤è°ƒç”¨updateConversionValueï¼š å»æ›´æ–°è½¬åŒ–æ•°å€¼ã€‚</p>
<p>è°ƒç”¨æ­¤æ–¹æ³•æœ‰ä¸¤ä¸ªç›®çš„ï¼š </p>
<p>äº§ç”Ÿä¸€ä¸ªå®‰è£…é€šçŸ¥,æ˜¯ä¸€ä¸ªåŠ å¯†ç­¾åçš„æ•°æ®åŒ…,ç”¨äºéªŒè¯æ˜¯å¦æ¥è‡ªå¹¿å‘Š</p>
<p>åº”ç”¨æä¾›æˆ–æ›´æ–°ä¸€ä¸ªè½¬åŒ–æ•°å€¼</p>
<p>æ¯æ¬¡æ›´æ–°CVå€¼æˆåŠŸï¼Œè®¡æ—¶å™¨å»¶è¿Ÿ24ä¸ªå°æ—¶ã€‚</p>
<p>å¦‚æœ24å°æ—¶å†…CVéƒ½æ²¡æ›´æ–°ï¼Œåˆ™ç¡®å®šäº†æœ€ç»ˆçš„CVå€¼ï¼Œæœ€ç»ˆå€¼ç¡®å®šåï¼Œåˆä¼šåœ¨24å°æ—¶ä¹‹å†…æŠŠCVå€¼å›ä¼ ç»™å¹¿å‘Šå¹³å°ã€‚</p>
<p>ä¹Ÿå°±æ˜¯è¯´å®‰è£…æ¿€æ´»è½¬åŒ–å€¼åœ¨æœ€å¿«ä¼šåœ¨24-48å°æ—¶å†…å›ä¼ ç»™å¹¿å‘Šä¸»ã€‚</p>
<p>å¦‚ä½•ç†è§£ï¼Ÿå®‰è£…çš„CVå€¼éƒ½æ˜¯0ï¼Œç”¨æˆ·å®‰è£…24å°æ—¶éƒ½æ²¡æœ‰è§¦å‘CVå€¼æ›´æ–°ï¼Œ24å°æ—¶åè®¡æ—¶å™¨åœæ­¢ï¼Œæœ€ç»ˆCVå€¼å°±æ˜¯0ï¼Œè€ŒAppleåˆä¼šåœ¨24å°æ—¶å†…postbackï¼Œä¹Ÿå°±æ˜¯å†åŠ 0-24å°æ—¶ä¹‹é—´çš„æ—¶é—´ï¼Œé‚£å°±æ˜¯24-48å°æ—¶ã€‚</p>
<p>è¿™åœ¨ç”¨ä¹ æƒ¯IDFAå½’å› çœ‹æ¥ç®€ç›´æ•ˆç‡ä½ä¸‹ï¼Œä¹‹å‰IDFAå½’å› å¹¿å‘ŠæŠ•æ”¾åç”¨æˆ·å®‰è£…åç«‹åˆ»å°±èƒ½çŸ¥é“ï¼Œè€Œä½¿ç”¨SKANæœ€å¿«ä¹Ÿè¦24-48å°æ—¶ä¹‹åæ‰çŸ¥é“å®‰è£…æ•°ï¼ˆè¿˜ä¸åŒ…æ‹¬åç»­CVæ›´æ–°ï¼Œåªçœ‹æ¿€æ´»æ•°ï¼‰</p>
<p>ä¸¾ä¸ªæç«¯ä¾‹å­ï¼Œå¦‚æœCVå€¼å¯¹åº”çš„è½¬æ¢äº‹ä»¶è®¾ç½®ä¸æ°å½“ï¼Œç”¨æˆ·ä»0ä¸€ç›´æ›´æ–°åˆ°63ï¼Œé‚£ä¹ˆä½ è¦åœ¨60å¤šå¤©åæ‰æ‹¿åˆ°è¿™ä¸ªç”¨æˆ·æœ€ç»ˆçš„CVå€¼ã€‚</p>
<p>3.éšç§é˜ˆå€¼</p>
<p>çœ‹äº†ä¸Šé¢çš„è®¡æ—¶å™¨è§‰å¾—SKANå·²ç»å¾ˆéš¾ç”¨äº†å§ï¼Œåˆ«æ…Œï¼Œè¿˜æœ‰ä¸€ä¸ªæ›´åçš„æ¶ˆæ¯ã€‚CVå€¼æœ€ç»ˆæ˜¯å¦ä¼ é€’ç»™å¹¿å‘Šä¸»è¿˜è¦çœ‹ç”¨æˆ·çš„è¡Œä¸ºæ˜¯å¦æ»¡è¶³Appleçš„éšç§é˜ˆå€¼ã€‚</p>
<p>è¿™æ˜¯é˜ˆå€¼å…·ä½“æ˜¯ä»€ä¹ˆå‘¢ï¼ŸæŠ±æ­‰ï¼ŒAppleæ²¡è¯´ï¼Œä¸€åˆ‡éƒ½æ˜¯é»‘ç›’ã€‚</p>
<p>ï¼ˆåœ¨æˆ‘ä»¬æ¥å…¥è¿‡ç¨‹ä¸­æœ‰å¹¿å‘Šä¸»è¯•äº†ä¸‹ï¼Œå¾—å‡ºçš„å¤§æ¦‚ç»“è®ºæ˜¯æ¯ä¸ªå¹¿å‘Šç³»åˆ—å¹³å‡æ¯å¤©å®‰è£…120ä¸ªä»¥ä¸Šæ‰ç¬¦åˆï¼Œä½†æ˜¯å¾ˆå¿«Appleåˆè°ƒæ•´äº†éšç§é˜ˆå€¼ï¼‰</p>
<p>å¦‚æœä¸ç¬¦åˆé˜ˆå€¼å‘¢ï¼Œé‚£Appleä¼šå›ä¼ ç»™ä½ ä¸€ä¸ªNullã€‚</p>
<p>è€Œç»è¿‡æˆ‘ä»¬æµ‹è¯•ï¼Œæ–°å¼€çš„å¹¿å‘Šç³»åˆ—æˆ–è€…æ•ˆæœä¸€èˆ¬çš„å¹¿å‘Šï¼Œä¸ç¬¦åˆéšç§é˜ˆå€¼æ‹¿åˆ°CVå€¼ä¸ºnullçš„å æ¯”é«˜è¾¾90%</p>
<p><img src="/images/pasted-4.png" alt="upload successful"></p>
<p>SKANæŠ€å·§åŠå‘</p>
<p>äº†è§£äº†SKANçš„åŸç†ï¼Œé‚£ä¹ˆè¯´ä¸€ä¸‹SKNAçš„ä¼˜ç¼ºç‚¹ã€‚</p>
<p>Appleè¯´ä¼˜ç‚¹æœ‰å¾ˆå¤šï¼Œæˆ‘éƒ½æ”¾ä¸‹é¢è¿™ä¸ªå›¾é‡Œäº†ï¼Œåœ¨éšç§è¶Šæ¥è¶Šä¸¥æ ¼çš„èƒŒæ™¯ä¸‹ï¼Œå¯ä»¥é¢„è§SKANåœ¨å¾ˆä¹…ä¸€æ®µæ—¶é—´éƒ½ä¼šæ˜¯å¸¸æ€ã€‚<br><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/202303132255620.png" alt=""></p>
<p>ç¼ºç‚¹å‘¢ï¼Œæœ‰å¾ˆå¤šï¼Œæœ€é‡è¦çš„ä¸€æ¡å°±æ˜¯æ—¶æ•ˆæ€§å¤ªå·®å¤ªå·®ã€‚</p>
<p>è¿™å¯¹æ•´ä¸ªå›¢é˜Ÿä¹Ÿæ˜¯ä¸€ç§è€ƒéªŒï¼Œä½œä¸ºç ”å‘äººå‘˜ï¼Œä½ ä¸ä½†è¦æ·±å…¥äº†è§£SKNAåŸç†ï¼Œè¿˜éœ€è¦äº†è§£å„ä¸ªå¹¿å‘Šå¹³å°ï¼ŒMMPå¹³å°çš„SKNAè§£å†³æ–¹æ¡ˆï¼ˆæ¯ä¸ªå¹³å°æ–¹æ¡ˆéƒ½ä¸åŒï¼‰ï¼Œè¿˜è¦è®©æŠ•æ”¾ã€äº§å“ã€å¸‚åœºéƒ½äº†è§£å’Œä½¿ç”¨SKAN,åˆç†åˆ©ç”¨64ä¸ªCVå€¼çš„æ˜ å°„ï¼Œè¿™æ— ç–‘ä¹Ÿæ˜¯ä¸ªæŒ‘æˆ˜ã€‚</p>
<p>1.ä½¿ç”¨MMPå¹³å°</p>
<p>å¹¿å‘Šå½’å› å¹³å°(Mobile Measurement Partner,ç®€ç§°MMP)ï¼ŒSKANå½’å› ç‰¹åˆ«å¤æ‚ï¼Œæ‰€ä»¥ä¸€èˆ¬éƒ½ä½¿ç”¨MMPå¹³å°æ¥é›†æˆï¼ŒMMPå¹³å°å»å¯¹æ¥å„å¤§å¹¿å‘Šå¹³å°ï¼Œå’Œå„å¤§å¹¿å‘Šå¹³å°çš„SKANæ–¹æ¡ˆåšæ¡¥æ¥å¯ä»¥åšåˆ°åªè®¾ç½®ä¸€ä¸ªCVæ˜ å°„è¡¨å¯¹åº”æ‰€æœ‰å¹¿å‘Šå¹³å°ã€‚</p>
<p>æ‹¿æˆ‘ä»¬ä½¿ç”¨çš„AppsFlyerå¹³å°ä¸¾ä¾‹ï¼Œä»–ä»¬çš„CVæ˜ å°„æ–¹æ¡ˆå¦‚ä¸‹ï¼š<br><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/202303132255755.png" alt=""></p>
<p>å…·ä½“æ¥è®²æœ‰åˆ†ä¸ºå‡ ä¸ªå¤§çš„ç»´åº¦<br><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/202303132256914.png" alt=""></p>
<p>æ›´å¤šä¿¡æ¯å¯ä»¥å»å¯¹åº”çš„MMPå¹³å°æŸ¥çœ‹ã€‚</p>
<p>ä¸‹é¢æ˜¯æ•´ä¸ªMMPå¹³å°å’Œå¹¿å‘Šå¹³å°å½’å› æµç¨‹ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/202303132256514.png" alt=""></p>
<p>2.åˆç†è®¾ç½®CVå€¼</p>
<p>åœ¨MMPå¹³å°ï¼Œå¯ä»¥è®¾ç½®CVæ˜ å°„è¡¨ï¼Œä¸€èˆ¬å°±æ˜¯åº”ç”¨å†…äº‹ä»¶ã€è®¢é˜…æ”¶å…¥ç­‰ã€‚</p>
<p>é‚£ä¹ˆå¦‚ä½•ç†è§£CVå€¼çš„ï¼Œæ‹¿ä¸‹å›¾æ¥è¯´ï¼Œæˆ‘ä»¬ç»Ÿè®¡äº†</p>
<p>1.æ”¶å…¥ä»·å€¼ï¼Œåˆ†äº†4ä¸ªèŒƒå›´ï¼ˆå¯¹æ¥FBè¦æ±‚å¿…é¡»4ä¸ªèŒƒå›´ï¼Œå®é™…å¯èƒ½ç”¨ä¸åˆ°è¿™ä¹ˆå¤šï¼‰</p>
<p>2.åº”ç”¨å†…äº‹ä»¶subs_success</p>
<p>3.å½’å› çª—å£æœŸ<br><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/202303132256726.png" alt=""><br><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/202303132257744.png" alt=""></p>
<p>æˆ‘ä»¬ä¼šåœ¨subs_successäº‹ä»¶ä¸ŠæŠ¥ä¸€ä¸ªäº‹ä»¶ä»·å€¼ï¼ˆä»·å€¼æ˜¯å–å¹³å‡å€¼ï¼Œæ¯”å¦‚ä½ ä¸ŠæŠ¥çš„ä»·å€¼è½åœ¨0-20ä¹‹é—´ï¼ŒMMPå¹³å°ç»Ÿä¸€ç»Ÿè®¡ä¸º10ç¾é‡‘ï¼‰ï¼Œé‚£ä¹ˆCVå€¼=6å°±ä»£è¡¨ï¼šç”¨æˆ·åœ¨æ¿€æ´»å0-12å°æ—¶ä¹‹å†…è®¢é˜…äº†ï¼Œäº§ç”Ÿäº†subs_successäº‹ä»¶ï¼Œäº‹ä»¶ä»·å€¼10ç¾é‡‘ã€‚<br><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/202303132257355.png" alt=""></p>
<p>é‚£ä¹ˆ7å°±ä»£è¡¨ç”¨æˆ·åœ¨æ¿€æ´»å0-12å°æ—¶ä¹‹å†…è®¢é˜…äº†ï¼Œäº§ç”Ÿäº†subs_successäº‹ä»¶ï¼Œäº§ç”Ÿäº†ï¼ˆ20+40ï¼‰/ 2 = 30ç¾é‡‘çš„ä»·å€¼ã€‚</p>
<p>3.å„å¹¿å‘Šå¹³å°äº‹ä»¶æ˜ å°„</p>
<p>MMPå’Œå„ä¸ªå¹¿å‘Šå¹³å°å¯¹æ¥æ–¹å¼éƒ½ä¸ä¸€æ ·ï¼Œè¿™é‡Œä¸å†å±•å¼€è®²ï¼Œéœ€è¦æ³¨æ„çš„å°±æ˜¯CVæ˜ å°„å€¼çš„è°ƒæ•´ï¼Œåœ¨éƒ¨åˆ†å¹³å°åŒæ­¥ç”Ÿæ•ˆéœ€è¦36-48å°æ—¶ä¸ç­‰ï¼Œæ›´æ”¹CVæ˜ å°„è¡¨æœŸé—´åº”è¯¥æš‚åœå¹¿å‘Šå¹¶ä¸”æ–°æ—§æ˜ å°„è¡¨äº¤æ›¿æ—¶å€™æ•°æ®ä¼šæœ‰éƒ¨åˆ†æ··ä¹±ã€‚</p>
<p>å…·ä½“çœ‹MMPå¹³å°æ–‡æ¡£ã€‚</p>
<p>å¦å¤–è¿˜é…åˆ°ä¸€äº›æ˜ å°„ä¸ä¸Šï¼Œæ— æ³•æ‹‰å–æˆæœ¬ç­‰ç­‰é—®é¢˜ï¼Œæœ‰äº›æ˜¯å¹¿å‘Šå¹³å°çš„é—®é¢˜ï¼Œéœ€è¦ç£ä¿ƒMMPå¹³å°æ‰¾å¹¿å‘Šå¹³å°è§£å†³ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/202303132257738.png" alt=""></p>
<p>è¿™é‡Œè¡¥å……ä¸‹ï¼ŒMMPå¹³å°å’Œå¹¿å‘Šå¹³å°CVå€¼æ€ä¹ˆåŒæ­¥çš„é—®é¢˜ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/202303132257413.png" alt=""></p>
<p>é‡ç‚¹å°±æ˜¯ä½ åœ¨GoogleæŠ•æ”¾çš„å¹¿å‘Šï¼ŒAppleä¼šæŠŠæœ€ç»ˆCVå€¼ç»™Googleï¼Œæ¯”å¦‚CV=6,Googleè¦ä¹ˆä¼šä»MMPæ‹‰å–ä¸€ä»½ä½ é…ç½®çš„CVæ˜ å°„è¡¨ï¼Œè¦ä¹ˆå›å»MMPé—®CV=6ä»£è¡¨ä»€ä¹ˆã€‚åŒæ—¶æŠŠCV=6å‘é€ç»™MMP,MMPå†åœ¨é¢æ¿ä¸Šå±•ç¤ºæ•°æ®ã€‚</p>
<p>è¿˜æœ‰æé†’ä¸€ä¸‹ï¼ŒMMPå¹³å°çš„SKANç­–ç•¥å’Œå¹¿å‘Šå¹³å°çš„ä¼šä¸ä¸€è‡´ï¼Œæ‹¿Googleæ¥è¯´ï¼ŒGoogleåå°å¯ä»¥Appleç»™çš„CVå€¼ï¼Œä½†æ˜¯Googleè¿˜æœ‰è‡ªå½’å› é€»è¾‘ï¼Œå­˜åœ¨nullçš„æƒ…å†µä¸‹GGä¼šè‡ªå½’å› åˆ¤æ–­æ˜¯å¦æ¿€æ´»ã€‚CVå€¼å’ŒMMPæœ€ç»ˆå¯¹ä¸ä¸Šã€‚</p>
<p>é‚£ä¹ˆæœ‰çš„åŒå­¦å°±å‘ç°è¿™é‡Œå­˜åœ¨æ¼æ´ï¼Œæ—¢ç„¶æ˜¯Appleç»™å¹¿å‘Šå¹³å°ï¼Œå¹¿å‘Šå¹³å°å†ç»™MMPï¼Œå¹¿å‘Šå¹³å°ä¼šä¸ä¼šç¯¡æ”¹CVå€¼å‘¢ã€‚</p>
<p>å› ä¸ºæœ‰äº›å¹³å°ç»“ç®—æ˜¯æŒ‰æ¿€æ´»é‡çš„ã€‚è¿™ä¸ªå°±æ˜¯ä¸‹é¢è¦æçš„äº¤å‰éªŒè¯äº†ã€‚</p>
<p>4.MMPäº¤å‰éªŒè¯</p>
<p>Appleåœ¨iOS15æ¨å‡ºäº†æ–°åŠŸèƒ½ï¼Œå¯ä»¥åœ¨å‘é€CVå€¼ç»™å¹¿å‘Šå¹³å°æ—¶å€™ï¼ŒåŒæ­¥å‘é€ç»™å¦å¤–ä¸€ä¸ªåœ°å€ã€‚è¿™æ ·å°±æœç»äº†å¹¿å‘Šå¹³å°æ¬ºè¯ˆçš„æƒ…å†µã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/202303132257160.png" alt=""></p>
<p>4.æˆç»©</p>
<p>å…¶å®å¯¹SKANçš„ä»‹ç»è¦æƒ³è¯´é€å½»å¿…é¡»å•å¼€ä¸€ç¯‡æ–‡ç« æ¥è®²äº†ã€‚</p>
<p>ä¸‹é¢è¯´ä¸‹æˆ‘ä»¬çš„æˆç»©ï¼Œæˆªæ­¢åˆ°SKAN4.0ä¹‹å‰ï¼ŒSKANçš„å½’å› æ•°æ®è‚¯å®šä¸çœŸå®çš„ï¼Œä¸ºä»€ä¹ˆ?å› ä¸ºéšç§é˜ˆå€¼çš„å­˜åœ¨ï¼Œæ•°æ®ç›¸å½“äºæŠ½æ ·ã€‚</p>
<p>ä½†æ˜¯æ¯ä¸ªå¹³å°éƒ½æŠ½æ ·ï¼Œåªçœ‹ç»å¯¹å€¼è¿˜æ˜¯èƒ½å¯¹æ¯”é‚£ä¸ªå¹¿å‘Šæ¸ é“è½¬æ¢å’Œæ”¶ç›Šå¥½çš„ã€‚</p>
<p>æœŸé—´ä¹Ÿç»å†äº†MMPå¹³å°CVå€¼æ··ä¹±bugç­‰ç­‰ï¼Œä½†æ˜¯æ€»ä½“æ¥è¯´SKANæ˜¯ç›®å‰æœ€ä¼˜è§£å†³æ–¹æ¡ˆã€‚</p>
<p>ç›®å‰æˆ‘ä»¬ä¸€ä¸ªè®¢é˜…ä¸ŠæŠ¥10ç¾é‡‘ä»·å€¼ï¼Œæ•°æ®å»é™¤éšç§é˜ˆå€¼çš„æŸè€—ï¼Œçœ‹æ•´ä½“è¶‹åŠ¿ä¹Ÿèƒ½å’ŒAppleåå°æ•°æ®å¯¹å¾—ä¸Šã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/202303132257124.png" alt=""></p>
<p>é™¤äº†SKANï¼Œè¿˜å¯ä»¥ä½¿ç”¨Appleå®˜æ–¹çš„ASM(App Store Search Marketing )åˆå ASA(Apple Search Ads)ã€‚ASMå¹¶ä¸ä½¿ç”¨SKANï¼Œè€Œæ˜¯ä¼ ç»Ÿçš„å½’å› ï¼ˆæœç„¶å¥½ä¸œè¥¿è¿˜æ˜¯ç•™ç»™è‡ªå·±å¹³å°ï¼‰ã€‚</p>
<p>å…³äºæ›´å¤šSKAN4.0çš„ä¿¡æ¯ï¼Œæˆ‘ä¼šå•ç‹¬å¼€ä¸€ç¯‡æ¥è®²ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/10/15/iOS-XCTest%E5%AE%9E%E6%88%98%E2%80%94%E8%A7%A3%E5%86%B3%E5%9B%BD%E9%99%85%E5%8C%96%E5%BC%80%E5%8F%91%E6%B5%8B%E8%AF%95%E7%97%9B%E7%82%B9%EF%BC%88%E4%B8%8B%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img/avatar.png">
      <meta itemprop="name" content="weican Li">
      <meta itemprop="description" content="iOS Developer">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="licc">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/10/15/iOS-XCTest%E5%AE%9E%E6%88%98%E2%80%94%E8%A7%A3%E5%86%B3%E5%9B%BD%E9%99%85%E5%8C%96%E5%BC%80%E5%8F%91%E6%B5%8B%E8%AF%95%E7%97%9B%E7%82%B9%EF%BC%88%E4%B8%8B%EF%BC%89/" class="post-title-link" itemprop="url">iOS XCTestå®æˆ˜â€”è§£å†³å›½é™…åŒ–å¼€å‘æµ‹è¯•ç—›ç‚¹ï¼ˆä¸‹ï¼‰</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-10-15 12:11:00" itemprop="dateCreated datePublished" datetime="2021-10-15T12:11:00+08:00">2021-10-15</time>
            </span>

          
            <span id="/2021/10/15/iOS-XCTest%E5%AE%9E%E6%88%98%E2%80%94%E8%A7%A3%E5%86%B3%E5%9B%BD%E9%99%85%E5%8C%96%E5%BC%80%E5%8F%91%E6%B5%8B%E8%AF%95%E7%97%9B%E7%82%B9%EF%BC%88%E4%B8%8B%EF%BC%89/" class="post-meta-item leancloud_visitors" data-flag-title="iOS XCTestå®æˆ˜â€”è§£å†³å›½é™…åŒ–å¼€å‘æµ‹è¯•ç—›ç‚¹ï¼ˆä¸‹ï¼‰" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2021/10/15/iOS-XCTest%E5%AE%9E%E6%88%98%E2%80%94%E8%A7%A3%E5%86%B3%E5%9B%BD%E9%99%85%E5%8C%96%E5%BC%80%E5%8F%91%E6%B5%8B%E8%AF%95%E7%97%9B%E7%82%B9%EF%BC%88%E4%B8%8B%EF%BC%89/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/10/15/iOS-XCTest%E5%AE%9E%E6%88%98%E2%80%94%E8%A7%A3%E5%86%B3%E5%9B%BD%E9%99%85%E5%8C%96%E5%BC%80%E5%8F%91%E6%B5%8B%E8%AF%95%E7%97%9B%E7%82%B9%EF%BC%88%E4%B8%8B%EF%BC%89/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>ä¸Šç¯‡è¯¦è§ï¼š<a href="http://leevcan.com/2021/10/11/iOS-XCTest%E5%AE%9E%E6%88%98%E2%80%94%E8%A7%A3%E5%86%B3%E5%9B%BD%E9%99%85%E5%8C%96%E5%BC%80%E5%8F%91%E6%B5%8B%E8%AF%95%E7%97%9B%E7%82%B9/" target="_blank" rel="noopener">iOS XCTestå®æˆ˜â€”è§£å†³å›½é™…åŒ–å¼€å‘æµ‹è¯•ç—›ç‚¹ï¼ˆä¸Šï¼‰</a></p>
</blockquote>
<h1 id="4-StoreKit-Configuration-Fileï¼ˆæ— è®¢é˜…éœ€æ±‚å¯ç•¥è¿‡ï¼‰"><a href="#4-StoreKit-Configuration-Fileï¼ˆæ— è®¢é˜…éœ€æ±‚å¯ç•¥è¿‡ï¼‰" class="headerlink" title="4. StoreKit Configuration Fileï¼ˆæ— è®¢é˜…éœ€æ±‚å¯ç•¥è¿‡ï¼‰"></a>4. StoreKit Configuration Fileï¼ˆæ— è®¢é˜…éœ€æ±‚å¯ç•¥è¿‡ï¼‰</h1><p>å› ä¸ºæˆ‘ä»¬æ˜¯æµ·å¤–è®¢é˜…ç±»Appï¼Œè¿™ä¸ªæµ‹è¯•è„šæœ¬æœ€åˆçš„ç›®çš„å°±æ˜¯ä¸ºäº†æµ‹è¯•è®¢é˜…é¡µä»¥åŠæ•´ä¸ªè´­ä¹°æµç¨‹ï¼Œå› æ­¤è¦å¯¹ä¸»è¦å›½å®¶çš„è´§å¸å’Œä»·æ ¼è¿›è¡Œæµ‹è¯•ã€‚<br>ä½†æ˜¯åœ¨Xcode12ä¸­ï¼Œæ¨¡æ‹Ÿå™¨å¹¶ä¸èƒ½è¯»å–çº¿ä¸Šçš„<code>SKProuduct</code>ä¿¡æ¯ï¼ˆXcode13å·²ç»ä¿®å¤ï¼‰ã€‚è€ŒçœŸæœºæµ‹è¯•ä¹Ÿåªèƒ½æ¯æ¬¡æ‰‹åŠ¨åˆ‡æ¢æ²™ç›’è´¦æˆ·æ¥åˆ‡æ¢å›½é™…å’Œè´§å¸å¸ç§ã€‚<br>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œè®¢é˜…é¡µéœ€è¦é€‚é…ä¸€äº›è¶…é•¿çš„è´§å¸ï¼ˆä¸€èˆ¬å¦æ¡‘å°¼äºšè´§å¸æœ€é•¿ï¼‰ã€‚<br><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/20211215163909.png" alt=""><br>é€šè¿‡<code>StoreKit</code>å¯ä»¥å¾ˆæ–¹ä¾¿çš„è§£å†³è¿™ä¸ªé—®é¢˜ã€‚<br>Apple åœ¨ Xcode12 ä¸­å¼•å…¥äº†æœ¬åœ° StoreKit æµ‹è¯•ï¼Œæ— éœ€è¿æ¥åˆ° App Store æœåŠ¡å™¨å³å¯æµ‹è¯•ä¸åŒçš„ IAP åœºæ™¯ã€‚<br>æ›´å¤šä¿¡æ¯è¯¦è§ï¼š<a href="https://developer.apple.com/documentation/xcode/setting-up-storekit-testing-in-xcode#Overview" target="_blank" rel="noopener">ã€ŠSetting Up StoreKit Testing in Xcodeã€‹</a></p>
<h2 id="i-åˆ›å»ºStoreKit-Configuration-File"><a href="#i-åˆ›å»ºStoreKit-Configuration-File" class="headerlink" title="i.åˆ›å»ºStoreKit Configuration File"></a>i.åˆ›å»ºStoreKit Configuration File</h2><p>åˆ›å»ºæ–¹å¼å¾ˆç®€å•ï¼Œåœ¨æ–°å»ºæ–‡ä»¶ä¸­æ‰¾åˆ°<code>StoreKit Configuration File</code><br><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/20211215163923.png" alt=""><br>ç‚¹å‡»åŠ å·ï¼Œæ–°å¢ä¸€ä¸ªè‡ªåŠ¨ç»­æœŸSKU,å½“ç„¶ä¹Ÿå¯ä»¥ç”¨æ¥æµ‹è¯•æ¶ˆè€—ç±»å†…è´­ã€‚<br><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/20211215163934.png" alt=""></p>
<p>æŒ‰ç€çœŸå®çš„çº¿ä¸ŠSKUè¿›è¡Œé…ç½®ï¼Œè¿˜èƒ½é…ç½®æ¨ä»‹ä¿ƒé”€ä¼˜æƒ ã€ä¿ƒé”€ä¼˜æƒ ã€å®¶åº­å…±äº«ç­‰åŠŸèƒ½ã€‚ä»·æ ¼è¿™é‡Œåªéœ€è¦å¡«å†™é‡‘é¢<br><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/20211215163946.png" alt=""><br>åœ¨Schemesè®¾ç½®ä¸­ï¼Œæ·»åŠ åˆšåˆšé…ç½®çš„StoreKit Configuration<br><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/20211215164022.png" alt=""></p>
<p>é‡æ–°è¿è¡Œé¡¹ç›®ï¼Œå°±èƒ½åœ¨è·å–<code>SKProductsRequestDelegate</code>çš„<code>productsRequest</code>æ–¹æ³•ä¸­æ‹¿åˆ°æ¨¡æ‹Ÿçš„SKUäº†ï¼Œé‡‘é¢é»˜è®¤æ˜¯ç¾å…ƒã€‚</p>
<p>è€Œæ›´æ”¹è´§å¸ä¹Ÿå¾ˆæ–¹ä¾¿ï¼Œåœ¨é¡¹ç›®ä¸­é€‰ä¸­StoreKit Configurationæ–‡ä»¶ï¼Œåœ¨Xcodeä¸­çš„<code>Editor</code>â€”&gt;<code>Default Storefront</code>ä¸­è¿›è¡Œé€‰æ‹©ç›¸åº”çš„å¸ç§ã€‚<br><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/20211215164039.png" alt=""><br>åªéœ€è¦åœ¨StoreKit Configurationä¸­æ›´æ”¹ä»·æ ¼å°±è¡Œäº†ï¼Œä¼šè‡ªåŠ¨è¯»å–è®¾ç½®çš„Storefrontå¸ç§ã€‚<br><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/20211215164057.png" alt=""></p>
<p>æ›´æ”¹Storefrontæœ¬è´¨ä¸Šå°±æ˜¯æ›´æ”¹<code>SKProduct</code>çš„<code>priceLocale</code>,æ³¨æ„æœ€ç»ˆä»·æ ¼çš„å‘ˆç°æ–¹å¼è¦ç”¨ç³»ç»Ÿæä¾›çš„<code>NumberFormatter</code>æ¥è®¡ç®—</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> formatter = <span class="module-access"><span class="module"><span class="identifier">NumberFormatter</span>.</span></span>init<span class="literal">()</span></span><br><span class="line">formatter.formatterBehavior = <span class="module-access"><span class="module"><span class="identifier">NumberFormatter</span>.</span><span class="module"><span class="identifier">Behavior</span>.</span></span>behavior10_4</span><br><span class="line">formatter.numberStyle = <span class="module-access"><span class="module"><span class="identifier">NumberFormatter</span>.</span><span class="module"><span class="identifier">Style</span>.</span></span>currency</span><br><span class="line">formatter.locale = product.priceLocale</span><br><span class="line">self.price = formatter.<span class="built_in">string</span>(from: product.price) ?? <span class="string">""</span></span><br></pre></td></tr></table></figure>
<h2 id="ii-åœ¨XCTestä¸­ä½¿ç”¨StoreKit-Configuration-File"><a href="#ii-åœ¨XCTestä¸­ä½¿ç”¨StoreKit-Configuration-File" class="headerlink" title="ii. åœ¨XCTestä¸­ä½¿ç”¨StoreKit Configuration File"></a>ii. åœ¨XCTestä¸­ä½¿ç”¨StoreKit Configuration File</h2><p>åˆšåˆšçš„é…ç½®åªæ˜¯åœ¨<code>Schemes</code>çš„<code>Run</code>ç¯å¢ƒä¸‹é…ç½®äº†StoreKit Configuration<br><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/20211215164137.png" alt=""><br>è€Œåœ¨æˆ‘ä»¬éœ€è¦çš„<code>Test</code>ç¯å¢ƒä¸‹å¹¶æ²¡æœ‰é…ç½®å…¥å£<br><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/20211215164204.png" alt=""></p>
<p>å› æ­¤éœ€è¦ç”¨ä»£ç æ¥è§£å†³</p>
<p>é¦–å…ˆæ‰¾åˆ°StoreKit Configurationï¼ŒæŠŠæ–‡ä»¶å…±äº«ç»™UITests Target<br><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/20211215164212.png" alt=""></p>
<p>ç„¶ååœ¨éœ€è¦ç”¨åˆ°StoreKit Configurationçš„testæ–¹æ³•ä¸­ï¼Œæ ¹æ®æ–°å»ºnameæ–°å»º<code>SKTestSession</code><br>æ›´å¤šä¿¡æ¯è¯·å‚è€ƒï¼š<a href="https://developer.apple.com/documentation/storekittest/sktestsession" target="_blank" rel="noopener">ã€ŠSKTestSession | Apple Developer Documentationã€‹</a></p>
<blockquote>
<p>æ³¨æ„ï¼šæƒ³è¦åœ¨è‡ªåŠ¨åŒ–æµ‹è¯•ä¸­ä½¿ç”¨StoreKit Configurationï¼Œéœ€è¦ç”¨åˆ°SKTestSessionï¼Œåªæœ‰iOS14ä»¥ä¸Šæ‰æ”¯æŒã€‚</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">testSubscribePage</span><span class="params">()</span></span> <span class="keyword">throws</span> &#123;</span><br><span class="line">       <span class="keyword">if</span> #available(iOS <span class="number">14.0</span>, *) &#123;</span><br><span class="line">           <span class="keyword">let</span> session = <span class="keyword">try</span>? <span class="type">SKTestSession</span>.<span class="keyword">init</span>(configurationFileNamed: <span class="string">"Configuration"</span>)</span><br><span class="line">           session?.disableDialogs = <span class="literal">true</span></span><br><span class="line">           session?.clearTransactions()</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           ....</span><br><span class="line">       &#125;</span><br><span class="line">       .....</span><br></pre></td></tr></table></figure>

<h1 id="5-xcodebuild"><a href="#5-xcodebuild" class="headerlink" title="5. xcodebuild"></a>5. xcodebuild</h1><p>æ‰§è¡Œå®Œä¸Šè¿°æ­¥éª¤ï¼Œå·²ç»å¯ä»¥å¯¹å•ä¸ªæ¨¡æ‹Ÿå™¨æˆ–çœŸæœºæ‰§è¡ŒTest Plansã€‚å¦‚æœæƒ³ä¸€æ¬¡æ‰§è¡Œå¤šä¸ªæœºå‹ï¼Œå°±éœ€è¦ç”¨åˆ°<code>xcodebuild</code>å‘½ä»¤äº†ã€‚<br>ç†Ÿæ‚‰Jenkinsæ‰“åŒ…çš„åŒå­¦åº”è¯¥å¯¹<code>xcodebuild</code>å¾ˆç†Ÿæ‚‰ï¼Œå…¶å®æˆ‘ä»¬æ¯æ¬¡åœ¨Xcodeè¿›è¡Œçš„<code>Run</code>ã€<code>Build</code>ã€<code>Archive</code>ç­‰æ“ä½œæœ¬è´¨ä¸Šéƒ½æ˜¯æ‰§è¡Œç›¸åº”çš„<code>xcodebuild</code>å‘½ä»¤ã€‚<br>ä½¿ç”¨<code>xcodebuild</code>å‘½ä»¤è¿è¡ŒTest Planså‘½ä»¤å¦‚ä¸‹</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">//ä½¿ç”¨äº†podçš„è¯å°±éœ€è¦æ‰§è¡Œxxx.xcworkspace</span></span><br><span class="line"><span class="comment">//scheme é€‰æ‹©UITest</span></span><br><span class="line">xcodebuild test -workspace <span class="built_in">UITestDemo</span>.xcworkspace -scheme <span class="built_in">UITestDemoUITests</span> -destination <span class="string">'platform=iOS Simulator,name=iPhone 12 Pro Max,OS=14.5'</span></span><br></pre></td></tr></table></figure>

<h2 id="i-åŒæ—¶è¿è¡Œå¤šä¸ªæ¨¡æ‹Ÿå™¨å’ŒçœŸæœº"><a href="#i-åŒæ—¶è¿è¡Œå¤šä¸ªæ¨¡æ‹Ÿå™¨å’ŒçœŸæœº" class="headerlink" title="i. åŒæ—¶è¿è¡Œå¤šä¸ªæ¨¡æ‹Ÿå™¨å’ŒçœŸæœº"></a>i. åŒæ—¶è¿è¡Œå¤šä¸ªæ¨¡æ‹Ÿå™¨å’ŒçœŸæœº</h2><p>ä¸€æ¬¡è¿è¡Œå¤šä¸ªæ¨¡æ‹Ÿå™¨ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œè¿˜å¯ä»¥çœŸæœºæ¨¡æ‹Ÿå™¨ä¸€èµ·è¿è¡Œï¼Œæ”¯æŒä¸åŒiOSç‰ˆæœ¬çš„æ¨¡æ‹Ÿå™¨åŒæ—¶è¿è¡Œã€‚</p>
<figure class="highlight nix"><table><tr><td class="code"><pre><span class="line">xcodebuild test -workspace UITestDemo.xcworkspace -scheme UITestDemoUITests </span><br><span class="line">-destination '<span class="attr">platform=iOS</span> Simulator,<span class="attr">name=iPhone</span> <span class="number">12</span> Pro Max,<span class="attr">OS=14.5'</span> </span><br><span class="line">-destination '<span class="attr">platform=iOS</span> Simulator,<span class="attr">name=iPhone</span> <span class="number">12</span>,<span class="attr">OS=14.5'</span></span><br><span class="line"> -destination '<span class="attr">platform=iOS</span> Simulator,<span class="attr">name=iPhone</span> <span class="number">8</span> Plus,<span class="attr">OS=14.5'</span> </span><br><span class="line">-destination '<span class="attr">platform=iOS</span> Simulator,<span class="attr">name=iPhone</span> <span class="number">8</span>,<span class="attr">OS=14.5'</span> </span><br><span class="line">-destination '<span class="attr">platform=iOS</span> Simulator,<span class="attr">name=iPhone</span> SE (<span class="number">2</span>nd generation),<span class="attr">OS=14.5'</span></span><br><span class="line">-destination '<span class="attr">platform=iOS,name=caniPhone'</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>æ³¨æ„æ¨¡æ‹Ÿå™¨å’ŒçœŸæœºçš„Nameå¿…é¡»å‡†ç¡®ï¼ŒæŸ¥çœ‹æ‰€æœ‰å¯æ‰§è¡Œçš„æ¨¡æ‹Ÿå™¨å’ŒçœŸæœºå¯ä»¥ä½¿ç”¨<code>xcrun xctrace list devices</code></p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/20211215164226.png" alt=""></p>
<h2 id="ii-æŒ‡å®šderivedDataPath"><a href="#ii-æŒ‡å®šderivedDataPath" class="headerlink" title="ii. æŒ‡å®šderivedDataPath"></a>ii. æŒ‡å®šderivedDataPath</h2><p>æ­£å¸¸è¿è¡ŒTest Plansï¼Œè¿è¡Œç»“æœåªèƒ½åœ¨Xcodeä¸­æŸ¥çœ‹å¹¶ä¸”è·¯å¾„å¾ˆæ·±ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨<code>derivedDataPath</code>æŒ‡å®šç»“æœçš„è¾“å‡ºè·¯å¾„</p>
<figure class="highlight nix"><table><tr><td class="code"><pre><span class="line">xcodebuild test -workspace UITestDemo.xcworkspace -scheme UITestDemoUITests -derivedDataPath '/Users/cc/Desktop/outData'</span><br><span class="line">-destination '<span class="attr">platform=iOS</span> Simulator,<span class="attr">name=iPhone</span> <span class="number">12</span> Pro Max,<span class="attr">OS=14.5'</span> </span><br><span class="line">-destination '<span class="attr">platform=iOS</span> Simulator,<span class="attr">name=iPhone</span> <span class="number">12</span>,<span class="attr">OS=14.5'</span></span><br><span class="line"> -destination '<span class="attr">platform=iOS</span> Simulator,<span class="attr">name=iPhone</span> <span class="number">8</span> Plus,<span class="attr">OS=14.5'</span> </span><br><span class="line">-destination '<span class="attr">platform=iOS</span> Simulator,<span class="attr">name=iPhone</span> <span class="number">8</span>,<span class="attr">OS=14.5'</span> </span><br><span class="line">-destination '<span class="attr">platform=iOS</span> Simulator,<span class="attr">name=iPhone</span> SE (<span class="number">2</span>nd generation),<span class="attr">OS=14.5'</span></span><br><span class="line">-destination '<span class="attr">platform=iOS,name=caniPhone'</span></span><br></pre></td></tr></table></figure>
<h2 id="iii-å¼€å¯parallel"><a href="#iii-å¼€å¯parallel" class="headerlink" title="iii. å¼€å¯parallel"></a>iii. å¼€å¯parallel</h2><p>åœ¨<a href="https://kms.netease.com/article/45514" target="_blank" rel="noopener">iOS XCTestå®æˆ˜â€”è§£å†³å›½é™…åŒ–å¼€å‘æµ‹è¯•ç—›ç‚¹ï¼ˆä¸Šï¼‰</a>ä¸­Test Plansæ ç›®ä»‹ç»äº†ä¸ºè®¾å¤‡å¼€å¯parallel testingã€‚åœ¨xcode buildä¸­åŒæ ·å¯ä»¥ä½¿ç”¨<code>-parallel-testing-enabled YES -parallelize-tests-among-destinations</code>å¼€å¯ï¼ˆä¸è¿‡åŒæ—¶è¿è¡Œå¤šä¸ªä¸åŒçš„æ¨¡æ‹Ÿå™¨ï¼Œä¸€èˆ¬æ²¡æœ‰é¢å¤–èµ„æºå¯¹åŒä¸€ä¸ªæ¨¡æ‹Ÿå™¨å†å¼€å¯parallel testingï¼‰</p>
<figure class="highlight nix"><table><tr><td class="code"><pre><span class="line">xcodebuild test -workspace UITestDemo.xcworkspace -scheme UITestDemoUITests -derivedDataPath '/Users/cc/Desktop/outData'</span><br><span class="line">-parallel-testing-enabled YES -parallelize-tests-among-destinations</span><br><span class="line">-destination '<span class="attr">platform=iOS</span> Simulator,<span class="attr">name=iPhone</span> <span class="number">12</span> Pro Max,<span class="attr">OS=14.5'</span> </span><br><span class="line">-destination '<span class="attr">platform=iOS</span> Simulator,<span class="attr">name=iPhone</span> <span class="number">12</span>,<span class="attr">OS=14.5'</span></span><br><span class="line"> -destination '<span class="attr">platform=iOS</span> Simulator,<span class="attr">name=iPhone</span> <span class="number">8</span> Plus,<span class="attr">OS=14.5'</span> </span><br><span class="line">-destination '<span class="attr">platform=iOS</span> Simulator,<span class="attr">name=iPhone</span> <span class="number">8</span>,<span class="attr">OS=14.5'</span> </span><br><span class="line">-destination '<span class="attr">platform=iOS</span> Simulator,<span class="attr">name=iPhone</span> SE (<span class="number">2</span>nd generation),<span class="attr">OS=14.5'</span></span><br><span class="line">-destination '<span class="attr">platform=iOS,name=caniPhone'</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>ç³»ç»Ÿä¼šæŒ‰ç…§å¯ç”¨èµ„æºåŒæ—¶å¹¶è¡Œè¿è¡Œå¤šä¸ªæ¨¡æ‹Ÿå™¨(ä¸€èˆ¬æ˜¯5ä¸ª)ï¼Œå½“ä½ æŒ‡å®šè¶…è¿‡5ä¸ªï¼Œæœ€å¼€å§‹è¿è¡Œç»“æŸçš„æ¨¡æ‹Ÿå™¨ä¼šè‡ªåŠ¨å…³é—­ç„¶åè¿è¡Œä¸‹ä¸€ä¸ªã€‚</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/20211215164352.png" alt=""></p>
<p>æ›´å¤šçš„xcodebuildè¯¦è§:</p>
<figure class="highlight ebnf"><table><tr><td class="code"><pre><span class="line"><span class="attribute">man xcodebuild</span></span><br></pre></td></tr></table></figure>
<h1 id="6-ä»xcresultä¸­æå–æˆªå›¾"><a href="#6-ä»xcresultä¸­æå–æˆªå›¾" class="headerlink" title="6. ä»xcresultä¸­æå–æˆªå›¾"></a>6. ä»xcresultä¸­æå–æˆªå›¾</h1><p>ä¸Šé¢æåˆ°è¿‡è¦çœ‹Test Plansè¿è¡Œå®Œåçš„æˆªå›¾ï¼Œåªèƒ½åœ¨Xcodeä¸­æŸ¥çœ‹ï¼Œå¹¶ä¸”æ¯æ¬¡åªèƒ½æŸ¥çœ‹ä¸€ä¸ªé…ç½®ï¼Œå›¾ç‰‡ä¹Ÿåªèƒ½ä¸€æ¬¡æŸ¥çœ‹ä¸€å¼ ã€‚<br>åœ¨Xcodeä¸­æ‰¾åˆ°æµ‹è¯•ç»“æœï¼Œåœ¨Finderä¸­æ˜¾ç¤ºå¯ä»¥çœ‹åˆ°ç»“æœæ˜¯ä»¥<code>.xcresult</code>ç»“å°¾çš„æ–‡ä»¶<br><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/20211215164427.png" alt=""><br>ç‚¹å‡»æ˜¾ç¤ºåŒ…å†…å®¹åå‘ç°ç»“æœä¹Ÿæ— æ³•è¯»å–ã€‚<br><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/20211215164442.png" alt=""></p>
<p>é€šè¿‡æŸ¥é˜…å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://help.apple.com/xcode/mac/current/#/devc38fc7392" target="_blank" rel="noopener">ã€ŠView and share test resultsã€‹</a>å¾—çŸ¥ï¼Œå¯ä»¥ä½¿ç”¨<code>xcrun xcresulttool</code>å‘½ä»¤æ¥å¯¼å‡ºç»“æœã€‚<br>æ›´å¤šå‘½ä»¤è¯·æŸ¥çœ‹</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line">xcrun xcresulttool --<span class="keyword">help</span> </span><br><span class="line"><span class="comment">//or</span></span><br><span class="line"><span class="keyword">man</span> xcresulttool</span><br></pre></td></tr></table></figure>
<h2 id="i-xcparse"><a href="#i-xcparse" class="headerlink" title="i.xcparse"></a>i.xcparse</h2><p>ä½†æ˜¯å…¶å®ä¸ç”¨è¿™ä¹ˆéº»çƒ¦ï¼Œå› ä¸ºåœ¨Githubä¸Šæœ‰å¾ˆå¥½ç”¨çš„å¼€æºåº“ï¼š<a href="https://github.com/ChargePoint/xcparse" target="_blank" rel="noopener">xcparse</a></p>
<p>é€šè¿‡<code>brew</code>å®‰è£…åï¼Œè¿è¡Œxcparseå‘½ä»¤å³å¯</p>
<figure class="highlight jboss-cli"><table><tr><td class="code"><pre><span class="line"><span class="string">//install</span>  xcparse</span><br><span class="line">brew install chargepoint/xcparse/xcparse</span><br><span class="line"></span><br><span class="line"><span class="string">//run</span> xcparse</span><br><span class="line">xcparse screenshots <span class="params">--os</span> <span class="params">--model</span> <span class="params">--test-plan-config</span> <span class="string">/path/to/Test.xcresult</span> <span class="string">/path/to/outputDirectory</span></span><br></pre></td></tr></table></figure>
<p>å¾—åˆ°çš„ç»“æœå°±ä¼šæŒ‰æœºå‹ã€è¯­è¨€åˆ†ç»„å±•ç¤ºï¼Œæ¸…æ™°æ˜äº†ã€‚<br><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/20211215164459.png" alt=""></p>
<h1 id="7-æœ€ç»ˆæ–¹æ¡ˆShellè„šæœ¬"><a href="#7-æœ€ç»ˆæ–¹æ¡ˆShellè„šæœ¬" class="headerlink" title="7. æœ€ç»ˆæ–¹æ¡ˆShellè„šæœ¬"></a>7. æœ€ç»ˆæ–¹æ¡ˆShellè„šæœ¬</h1><p>åšå®Œä¸Šè¿°æ‰€æœ‰æ“ä½œï¼Œå°±å·²ç»åŸºæœ¬æ»¡è¶³éœ€æ±‚äº†ã€‚ä½†æ˜¯è¿˜æ˜¯å·®é‚£ä¹ˆç‚¹æ„æ€ï¼Œç›®å‰è¿˜å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š</p>
<ul>
<li>æ¯æ¬¡æ”¹æ¨¡æ‹Ÿå™¨ï¼Œéƒ½éœ€è¦ä¿®æ”¹xcodebuildå‘½ä»¤</li>
<li>è¾“å‡ºpathè¦æ‰‹åŠ¨æŒ‡å®šï¼Œå¦‚æœå­˜åœ¨ä¹Ÿä¸ä¼šè¦†ç›–ä¼šä¸€ç›´å¢åŠ </li>
<li>è¿è¡Œå®Œxcodebuildå‘½ä»¤åï¼Œè¦å¯¼å‡ºå›¾ç‰‡è¿˜è¦æ‰‹åŠ¨æ‰§è¡Œxcparseå‘½ä»¤</li>
<li>æ— æ³•éƒ¨ç½²åˆ°Jenkinsç­‰è®©éå¼€å‘äººå‘˜å»æµ‹è¯•<br>â€¦.</li>
</ul>
<p>æ‰€ä»¥æˆ‘ç”¨äº†ä¸€æ®µæ—¶é—´åï¼Œå†³å®šè¦shellè„šæœ¬å°è£…ä¸€ä¸‹ï¼Œåšåˆ°ä¸€é”®æ“ä½œã€‚åªéœ€è¦ä¸€ä¸ªå‘½ä»¤ï¼Œå°±å¯ä»¥è‡ªåŠ¨æ‰§è¡Œ<code>Test Plans</code>,æ‹¿åˆ°<code>xcresult</code>åè‡ªåŠ¨æ‰§è¡Œ<code>xcparse</code>å‘½ä»¤å¯¼å‡ºåˆ°æŒ‡å®šè·¯å¾„ã€‚</p>
<p>å› ä¸ºæ‰€æœ‰çš„éš¾é¢˜ä¹‹å‰å·²ç»è§£å†³äº†ï¼Œè„šæœ¬ä¹Ÿæ˜¯æ°´åˆ°æ¸ æˆã€‚é€»è¾‘ä¹Ÿå¾ˆç®€å•</p>
<h2 id="i-è„šæœ¬"><a href="#i-è„šæœ¬" class="headerlink" title="i.è„šæœ¬"></a>i.è„šæœ¬</h2><ul>
<li><p>å…ˆæŒ‡å®šschemeåå­—</p>
</li>
<li><p>æŒ‡å®šxcresultè¾“å‡ºç›®å½•å’Œxcparseå›¾ç‰‡è¾“å‡ºç›®å½•ï¼Œä¹‹å‰å­˜åœ¨å°±è¦†ç›–</p>
</li>
<li><p>é…ç½®æ¨¡æ‹Ÿå™¨å’ŒçœŸæœºList</p>
</li>
<li><p>test plansè¿è¡Œå®Œæ¯•åæ‹¿åˆ°xcresultï¼Œç”¨xcparseå¯¼å‡ºå›¾ç‰‡</p>
</li>
</ul>
<p>ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  UITest.sh</span></span><br><span class="line"><span class="comment">#  UDictionary</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  Created by æä¼Ÿç¿ on 2021/8/24.</span></span><br><span class="line"><span class="comment">#  Copyright Â© 2021 com.youdao. All rights reserved.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#chmod +x UITest.sh</span></span><br><span class="line"><span class="comment">#./UITest.sh</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"=========å¼€å§‹æ‰§è¡Œ========="</span></span><br><span class="line"></span><br><span class="line">path=$(<span class="built_in">pwd</span>)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"path is <span class="variable">$path</span>"</span></span><br><span class="line"></span><br><span class="line">scheme=<span class="string">"UDictionary"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#è¾“å‡ºç›®å½•</span></span><br><span class="line">outPath=<span class="string">"<span class="variable">$HOME</span>/Desktop/outData"</span></span><br><span class="line">resultPath=<span class="string">"<span class="variable">$HOME</span>/Desktop/outResult"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#XCUITest function</span></span><br><span class="line"><span class="function"><span class="title">xcUITestFunc</span></span>()&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">test</span> -e <span class="variable">$scheme</span>.xcodeproj</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">'=========Xcode Projectå­˜åœ¨'</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">'=========Xcode Projectä¸å­˜åœ¨ è¯·æ£€æŸ¥æ‰§è¡Œè·¯å¾„'</span></span><br><span class="line">        <span class="built_in">exit</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">test</span> -e <span class="variable">$outPath</span></span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"=========outPath existed, clean outPath"</span></span><br><span class="line">        rm -rf <span class="variable">$outPath</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    mkdir <span class="variable">$outPath</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"=========outPath mkdir"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#Get All Devices</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#xcrun xctrace list devices</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#å…¼å®¹çœŸæœºå’Œæ¨¡æ‹Ÿå™¨ ä¸è¿‡æœ€å¥½æ¨¡æ‹Ÿå™¨ä¸€èµ·è·‘ çœŸæœºä¸€èµ·è·‘</span></span><br><span class="line">    simulators=(</span><br><span class="line">                <span class="comment">#iPhone</span></span><br><span class="line">                <span class="string">"platform=iOS Simulator,name=iPhone 12 Pro Max,OS=15.0"</span></span><br><span class="line">                <span class="string">"platform=iOS Simulator,name=iPhone 12,OS=15.0"</span></span><br><span class="line">                <span class="string">"platform=iOS Simulator,name=iPhone 8 Plus,OS=15.0"</span></span><br><span class="line">                <span class="string">"platform=iOS Simulator,name=iPhone 8,OS=15.0"</span></span><br><span class="line">                <span class="string">"platform=iOS Simulator,name=iPhone SE (2nd generation),OS=15.0"</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment">#iPad</span></span><br><span class="line">                <span class="string">"platform=iOS Simulator,name=iPad (9th generation),OS=15.0"</span></span><br><span class="line">                <span class="string">"platform=iOS Simulator,name=iPad mini (6th generation),OS=15.0"</span></span><br><span class="line">                <span class="string">"platform=iOS Simulator,name=iPad Air (4th generation),OS=15.0"</span></span><br><span class="line">                <span class="string">"platform=iOS Simulator,name=iPad Pro (9.7-inch),OS=15.0"</span></span><br><span class="line">                <span class="string">"platform=iOS Simulator,name=iPad Pro (11-inch) (3rd generation),OS=15.0"</span></span><br><span class="line">                <span class="string">"platform=iOS Simulator,name=iPad Pro (12.9-inch) (5th generation),OS=15.0"</span></span><br><span class="line">                )</span><br><span class="line"></span><br><span class="line">    destinationStr=<span class="string">""</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> subSimulator <span class="keyword">in</span> <span class="string">"<span class="variable">$&#123;simulators[@]&#125;</span>"</span></span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">        tmpStr=<span class="string">"-destination '<span class="variable">$subSimulator</span>' "</span></span><br><span class="line">        destinationStr=<span class="variable">$destinationStr</span><span class="variable">$tmpStr</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$destinationStr</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#æ‹¼æ¥å‘½ä»¤</span></span><br><span class="line">    commandStr=<span class="string">"xcodebuild test -workspace <span class="variable">$scheme</span>.xcworkspace -scheme <span class="variable">$scheme</span> -derivedDataPath '<span class="variable">$outPath</span>' <span class="variable">$destinationStr</span>"</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$commandStr</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#æ‰§è¡Œå‘½ä»¤</span></span><br><span class="line">    <span class="built_in">eval</span> <span class="variable">$commandStr</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"=========XCTestPlanæ‰§è¡Œç»“æŸ========="</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"----------------------------------"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"----------------------------------"</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">getAllScreenShots</span></span>()&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">test</span> -e <span class="variable">$resultPath</span></span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"=========resultPath existed, clean resultPath"</span></span><br><span class="line">        rm -rf <span class="variable">$resultPath</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#find xcresult</span></span><br><span class="line">    xcresultpath=$(find <span class="variable">$outPath</span>/Logs/Test -name <span class="string">"*.xcresult"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"=========å³å°†è¾“å‡ºå›¾ç‰‡åˆ°<span class="variable">$resultPath</span>"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#Install xcparse</span></span><br><span class="line">    <span class="comment">#brew install chargepoint/xcparse/xcparse</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#æ‰§è¡Œxcparse</span></span><br><span class="line">    commandStr=<span class="string">"xcparse screenshots --os --model --test-plan-config <span class="variable">$xcresultpath</span> <span class="variable">$resultPath</span>"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$commandStr</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#æ‰§è¡Œå‘½ä»¤</span></span><br><span class="line">    <span class="built_in">eval</span> <span class="variable">$commandStr</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"=========xcparseæ‰§è¡Œç»“æŸ========="</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">xcUITestFunc</span><br><span class="line"></span><br><span class="line">getAllScreenShots</span><br></pre></td></tr></table></figure>
<h2 id="ii-è¿è¡Œè„šæœ¬"><a href="#ii-è¿è¡Œè„šæœ¬" class="headerlink" title="ii.è¿è¡Œè„šæœ¬"></a>ii.è¿è¡Œè„šæœ¬</h2><p>è¿è¡Œæ–¹å¼ä¹Ÿå¾ˆç®€å•ï¼Œåœ¨Terminalä¸­æ‰¾åˆ°å·¥ç¨‹ç›®å½•ï¼Œæ‰§è¡ŒShellè„šæœ¬ï¼Œæ¯”å¦‚æˆ‘ä»¬Shellè„šæœ¬ä¸ºUITest.sh</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">chmod +x <span class="module-access"><span class="module"><span class="identifier">UITest</span>.</span></span>sh</span><br><span class="line">./<span class="module-access"><span class="module"><span class="identifier">UITest</span>.</span></span>sh</span><br></pre></td></tr></table></figure>

<h1 id="8-ç»“è¯­"><a href="#8-ç»“è¯­" class="headerlink" title="8.ç»“è¯­"></a>8.ç»“è¯­</h1><p>è‡³æ­¤ï¼ŒUIè‡ªåŠ¨èµ°æŸ¥æ–¹æ¡ˆå·²ç»å…¨éƒ¨å®Œæˆäº†ã€‚æœ‰äº†è¿™ä¸ªè„šæœ¬åï¼Œæˆ‘ä»¬å·¥ç¨‹æ¯ä¸ªç‰ˆæœ¬å¼€å‘è‡ªæµ‹å’Œæµ‹è¯•å¹³å‡èŠ‚çœäº†<code>5/äºº/å¤©</code>çš„å·¥ä½œé‡ã€‚ç‰¹åˆ«æ˜¯åæ¥æˆ‘ä»¬å¼€å¯äº†iPadé€‚é…åã€‚è€ŒUIèµ°æŸ¥ä¹Ÿèƒ½çœ‹åˆ°æœ€ç»ˆç»“æœçš„çœŸå®å‘ˆç°ã€‚ç›®å‰å·²ç»ç¨³å®šè¿è¡Œäº†4ä¸ªå¤šæœˆï¼Œåç»­è¿˜ä¼šæ ¹æ®éœ€æ±‚ç»§ç»­ä¼˜åŒ–ã€‚<br>æœ¬æ–¹æ¡ˆè®¾è®¡åˆ°å¾ˆå¤šæŠ€æœ¯ç‚¹ï¼Œæ¯”å¦‚<code>XCTest</code>ã€<code>Test Plans</code>ã€<code>xcodebuild</code>ã€<code>StoreKit Configuration</code>ç­‰ç­‰ï¼Œæ¯ä¸€éƒ¨åˆ†å•ç‹¬æ‹å‡ºæ¥è¯´éƒ½å¯ä»¥å•ç‹¬å†™ä¸€ç¯‡ã€‚<br>æ‰€ä»¥æœ¬æ–‡å¾ˆå¤šåœ°æ–¹éƒ½ä¸€ç¬”å¸¦è¿‡ï¼Œä¸»è¦è®²æ–¹æ¡ˆçš„é€‰æ‹©å’Œèåˆã€‚å¦‚æœå“ªæ–¹é¢æœ‰ç–‘é—®æ¬¢è¿å¤§å®¶è”ç³»æˆ‘è¿›è¡Œè®¨è®ºå’Œäº¤æµã€‚</p>
<h2 id="è”ç³»æ–¹å¼ï¼š"><a href="#è”ç³»æ–¹å¼ï¼š" class="headerlink" title="è”ç³»æ–¹å¼ï¼š"></a>è”ç³»æ–¹å¼ï¼š</h2><blockquote>
<p>æä¼Ÿç¿<br>ç½‘æ˜“æœ‰é“ å›½é™…App<br><a href="https://github.com/liweican1992" target="_blank" rel="noopener">Github</a><br>liweican#corp.netease.com<br>liweican1992#163.com</p>
</blockquote>
<p>æ„Ÿè°¢æ‚¨çš„é˜…è¯»~</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/10/11/iOS-XCTest%E5%AE%9E%E6%88%98%E2%80%94%E8%A7%A3%E5%86%B3%E5%9B%BD%E9%99%85%E5%8C%96%E5%BC%80%E5%8F%91%E6%B5%8B%E8%AF%95%E7%97%9B%E7%82%B9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img/avatar.png">
      <meta itemprop="name" content="weican Li">
      <meta itemprop="description" content="iOS Developer">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="licc">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/10/11/iOS-XCTest%E5%AE%9E%E6%88%98%E2%80%94%E8%A7%A3%E5%86%B3%E5%9B%BD%E9%99%85%E5%8C%96%E5%BC%80%E5%8F%91%E6%B5%8B%E8%AF%95%E7%97%9B%E7%82%B9/" class="post-title-link" itemprop="url">iOS XCTestå®æˆ˜â€”è§£å†³å›½é™…åŒ–å¼€å‘æµ‹è¯•ç—›ç‚¹ï¼ˆä¸Šï¼‰</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-10-11 15:34:00" itemprop="dateCreated datePublished" datetime="2021-10-11T15:34:00+08:00">2021-10-11</time>
            </span>

          
            <span id="/2021/10/11/iOS-XCTest%E5%AE%9E%E6%88%98%E2%80%94%E8%A7%A3%E5%86%B3%E5%9B%BD%E9%99%85%E5%8C%96%E5%BC%80%E5%8F%91%E6%B5%8B%E8%AF%95%E7%97%9B%E7%82%B9/" class="post-meta-item leancloud_visitors" data-flag-title="iOS XCTestå®æˆ˜â€”è§£å†³å›½é™…åŒ–å¼€å‘æµ‹è¯•ç—›ç‚¹ï¼ˆä¸Šï¼‰" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2021/10/11/iOS-XCTest%E5%AE%9E%E6%88%98%E2%80%94%E8%A7%A3%E5%86%B3%E5%9B%BD%E9%99%85%E5%8C%96%E5%BC%80%E5%8F%91%E6%B5%8B%E8%AF%95%E7%97%9B%E7%82%B9/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/10/11/iOS-XCTest%E5%AE%9E%E6%88%98%E2%80%94%E8%A7%A3%E5%86%B3%E5%9B%BD%E9%99%85%E5%8C%96%E5%BC%80%E5%8F%91%E6%B5%8B%E8%AF%95%E7%97%9B%E7%82%B9/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>æµ·å¤–é¡¹ç›®ä¸€å®šç¦»ä¸å¼€å›½é™…åŒ–é€‚é…ï¼Œè€Œå›½é™…åŒ–æ–‡æ¡ˆçš„å±•ç¤º&amp;æœºå‹é€‚é…ä¸€ç›´æ˜¯å¼€å‘å’Œæµ‹è¯•ä¸­çš„ç—›ç‚¹ã€‚<br>æœ¬äººè´Ÿè´£çš„é¡¹ç›®ä¸€ç›´æ·±è€•æµ·å¤–ï¼Œç›®å‰æ”¯æŒ13ç§å›½é™…åŒ–è¯­è¨€åŒ…æ‹¬R2Lçš„é˜¿æ‹‰ä¼¯è¯­ã€‚ä½œä¸ºè®¢é˜…ç±»Appï¼Œéœ€è¦è¿›è¡Œå¤§é‡çš„è®¢é˜…é¡µABæµ‹è¯•ã€‚æœ¬æ–‡ä¸»è¦ä»‹ç»äº†åœ¨é¡¹ç›®ä¸­å¦‚ä½•åˆ©ç”¨<code>XCTest</code>ã€<code>Test Plan</code>ã€<code>StoreKit Configuration</code>ã€<code>xcodebuild</code>å‘½ä»¤ã€<code>Shell</code>è„šæœ¬è¿›è¡Œå¿«é€ŸUIèµ°æŸ¥çš„ã€‚</p>
</blockquote>
<h1 id="0-å›½é™…åŒ–ç—›ç‚¹"><a href="#0-å›½é™…åŒ–ç—›ç‚¹" class="headerlink" title="0.å›½é™…åŒ–ç—›ç‚¹"></a>0.å›½é™…åŒ–ç—›ç‚¹</h1><p>åœ¨å›½é™…åŒ–æ—¥å¸¸å¼€å‘ä¸­ï¼Œå›½é™…åŒ–æ–‡æ¡ˆé€‚é…æ˜¯ä¸€ä¸ªéš¾é¢˜ï¼Œé™¤äº†å¼€å‘éœ€è¦è€ƒè™‘å„ç§æ¢è¡Œå’Œè¾¹ç•Œé—®é¢˜ç­‰ï¼Œæµ‹è¯•åŒå­¦ä¹Ÿè¦èŠ±ç²¾åŠ›æŒ¨ä¸ªè¯­ç§å’Œæœºå‹è¿›è¡Œèµ°æŸ¥ã€‚å°¤å…¶æ˜¯è®¢é˜…é¡µé¢å„ä¸ªå›½å®¶çš„è´§å¸å±•ç¤ºé¡µä¸ç›¸åŒã€‚<br>ä¸‹å›¾åˆ—ä¸¾äº†ä¸€äº›å›½é™…åŒ–å¸¸è§çš„é—®é¢˜ï¼š<br><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/20211215160447.png" alt=""><br>â¬†ï¸æ¢è¡Œåä¾æ—§æ— æ³•å±•ç¤º<br><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/20211215165931.png" alt=""><br>â¬†ï¸æ–‡æ¡ˆè¿‡é•¿ï¼Œå°å±å¹•æœºå‹å±•ç¤ºé—®é¢˜<br><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/20211215160349.png" alt=""><br>â¬†ï¸è´§å¸ä»·æ ¼è¿‡é•¿ï¼Œéœ€è¦é¢å¤–é€‚é…</p>
<hr>
<p>è¿™äº›é—®é¢˜éƒ½éœ€è¦å¼€å‘è‡ªæµ‹æˆ–UIèµ°æŸ¥æ‰èƒ½å‘ç°ï¼Œä¸‹é¢æˆ‘ä»¬ä¸€èµ·æ¥è§£å†³è¿™äº›ç—›ç‚¹ã€‚</p>
<h1 id="1-éœ€æ±‚æ¢³ç†"><a href="#1-éœ€æ±‚æ¢³ç†" class="headerlink" title="1.éœ€æ±‚æ¢³ç†"></a>1.éœ€æ±‚æ¢³ç†</h1><p>å¼€å§‹ä¹‹å‰å…ˆæ¢³ç†ä¸€ä¸‹éœ€æ±‚ï¼Œé€šè¿‡å¹³æ—¶æˆ‘è‡ªæµ‹çš„ç—›ç‚¹ä»¥åŠå’Œæµ‹è¯•åŒå­¦çš„æ²Ÿé€šï¼Œå¦‚æœç”¨è„šæœ¬è¿›è¡Œæµ‹è¯•éœ€è¦è¾¾åˆ°ä»¥ä¸‹æ•ˆæœï¼š</p>
<ol>
<li>æ‰€æœ‰å›½é™…åŒ–æ–‡æ¡ˆå’Œä¸»è¦æœºå‹éƒ½è¦è¦†ç›–</li>
<li>ä»¥é¡µé¢æˆªå›¾ä¸ºå‡†ï¼Œäººå·¥è¿‡ä¸€ä¸‹ï¼Œæ–¹ä¾¿å‘ç°é—®é¢˜å’ŒæŠ¥bugï¼Œæœ€é‡è¦çš„æ˜¯æ–¹ä¾¿åæœŸUI Debugã€‚</li>
<li>å¯¹è®¢é˜…åŠŸèƒ½ï¼Œå¯ä»¥æ–¹ä¾¿åˆ‡æ¢ä¸åŒå›½å®¶å±•ç¤ºä¸åŒçš„è´§å¸</li>
<li>è„šæœ¬è¦æ–¹ä¾¿ä½¿ç”¨ï¼Œå¯ä»¥æ–¹ä¾¿é…ç½®ä¸åŒçš„æœºå‹ã€å›½é™…åŒ–è¯­è¨€å’Œè´§å¸å¸ç§ï¼ŒåæœŸæ–¹ä¾¿éƒ¨ç½²åˆ°Jenkins</li>
<li>ç»“æœå‘ˆç°è¦åˆ†æœºå‹ã€iOSç³»ç»Ÿï¼Œé€šè¿‡æˆªå›¾åç§°å¯ä»¥çŸ¥é“æ˜¯å“ªä¸ªé¡µé¢</li>
</ol>
<h1 id="2-XCTest"><a href="#2-XCTest" class="headerlink" title="2.XCTest"></a>2.XCTest</h1><p><code>XCTest</code>æ˜¯Xocdeçš„åŸç”Ÿæµ‹è¯•æ¡†æ¶ã€‚ç›¸å¯¹äº<a href="https://github.com/kiwi-bdd/Kiwi" target="_blank" rel="noopener">Kiwi</a>ã€<a href="https://github.com/specta/specta" target="_blank" rel="noopener">Specta</a>ã€<a href="https://github.com/specta/expecta" target="_blank" rel="noopener">Expecta</a>ç­‰ç¬¬ä¸‰æ–¹æ¡†æ¶æ›´å®¹æ˜“ä¸Šæ‰‹ã€‚è€Œé€‰æ‹©<code>XCTest</code>è¿˜æœ‰ä¸€ä¸ªé‡è¦çš„åŸå› æ˜¯Appleåœ¨2019 WWDCæ¨å‡ºçš„<code>Test Plans</code>å¯¹å›½é™…åŒ–æµ‹è¯•éå¸¸å‹å¥½ã€‚</p>
<p>(è¯¦è§ï¼š<a href="https://developer.apple.com/videos/play/wwdc2019/413/" target="_blank" rel="noopener">Testing in Xcode</a>ï¼Œä¸‹æ–‡ä¹Ÿä¼šè¯¦ç»†ä»‹ç»ï¼‰</p>
<p>Xcodeåœ¨åˆ›å»ºé¡¹ç›®æ—¶å€™ä¸€èˆ¬ä¼šè‡ªåŠ¨åˆ›å»ºTestå’ŒUITestå·¥ç¨‹ï¼Œå› ä¸ºåªéœ€è¦æµ‹è¯•UIï¼Œä½¿ç”¨UITestå³å¯ã€‚<br><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/20211215160550.png" alt=""><br>å…·ä½“çš„XCTestæ–‡æ¡£è¯¦è§<a href="https://developer.apple.com/documentation/xctest/user_interface_tests" target="_blank" rel="noopener">User Interface Tests</a>ï¼Œè¿™é‡Œå°±ä¸å±•å¼€è®²äº†ã€‚</p>
<p>åœ¨å¼€å§‹å†™æµ‹è¯•è„šæœ¬ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦è§£å†³ä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š</p>
<h2 id="i-å¯¹é¡µé¢è¿›è¡Œæˆªå›¾"><a href="#i-å¯¹é¡µé¢è¿›è¡Œæˆªå›¾" class="headerlink" title="i.å¯¹é¡µé¢è¿›è¡Œæˆªå›¾"></a>i.å¯¹é¡µé¢è¿›è¡Œæˆªå›¾</h2><p>æˆªå›¾æ–¹æ³•å¾ˆç®€å•ï¼Œå°è£…æˆä¸€ä¸ªæ–¹æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">takeAScreenshot</span><span class="params">(<span class="number">_</span> name: String)</span></span> &#123;</span><br><span class="line">      <span class="keyword">let</span> screenshot = <span class="type">XCUIScreen</span>.main.screenshot()</span><br><span class="line">      <span class="keyword">let</span> screenshotAttachment = <span class="type">XCTAttachment</span>(</span><br><span class="line">          uniformTypeIdentifier: <span class="string">"public.png"</span>,</span><br><span class="line">          name: <span class="string">"Screenshot-\(UIDevice.current.name)-\(name).png"</span>,</span><br><span class="line">          payload: screenshot.pngRepresentation,</span><br><span class="line">          userInfo: <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">      screenshotAttachment.lifetime = .keepAlways</span><br><span class="line">      add(screenshotAttachment)</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>è¿˜å¯ä»¥æŒ‡å®šæˆªå›¾çš„è´¨é‡ï¼Œæ¯”å¦‚æˆ‘ä»¬å·¥ç¨‹è¿è¡Œä¸€æ¬¡è„šæœ¬éœ€è¦æˆªå›¾500+ï¼Œå°±éœ€è¦æŒ‡å®šä½è´¨é‡äº†ã€‚ç»è¿‡æµ‹è¯•ä½è´¨é‡çš„å›¾ç‰‡å ç”¨å¤§å°æ¯”é«˜è´¨é‡èƒ½å‹ç¼©è¿‘20å€å·¦å³ã€‚ä½†æ˜¯éœ€è¦æ³¨æ„ï¼Œåœ¨M1èŠ¯ç‰‡çš„Macä¸Šï¼ŒæŒ‡å®šè´¨é‡çš„æˆªå›¾æ–¹æ³•ä¼šæŠ¥é”™ï¼Œåº”è¯¥æ˜¯Xcodeçš„é€‚é…é—®é¢˜ã€‚</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">func take<span class="constructor">AScreenshot(<span class="params">_</span> <span class="params">name</span>: String)</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> screenshot = <span class="module-access"><span class="module"><span class="identifier">XCUIScreen</span>.</span></span>main.screenshot<span class="literal">()</span></span><br><span class="line">      <span class="keyword">let</span> screenshotAttachment = <span class="module-access"><span class="module"><span class="identifier">XCTAttachment</span>.</span></span>init(screenshot: screenshot, quality: .low)</span><br><span class="line">      screenshotAttachment.name = <span class="string">"\(UIDevice.current.name)-\(name).jpeg"</span></span><br><span class="line">      screenshotAttachment.lifetime = .keepAlways</span><br><span class="line">      add(screenshotAttachment)</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>æµ‹è¯•å®Œæˆåï¼Œæˆªå›¾å¯ä»¥åœ¨Xcodeä¸­æŸ¥çœ‹<br><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/20211215160607.png" alt=""></p>
<h2 id="ii-å›½é™…åŒ–é€‚é…"><a href="#ii-å›½é™…åŒ–é€‚é…" class="headerlink" title="ii. å›½é™…åŒ–é€‚é…"></a>ii. å›½é™…åŒ–é€‚é…</h2><p>åœ¨XCTestä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ¨¡æ‹Ÿç”¨æˆ·çš„æ“ä½œï¼Œæ¯”å¦‚ç‚¹å‡»ä¸€ä¸ªæŒ‰é’®ï¼Œç‚¹å‡»ä¸€ä¸ªLabelç­‰ï¼Œè€Œæ‰¾åˆ°æ§ä»¶çš„æ–¹å¼ä¸€èˆ¬æ˜¯æŒ‰Buttonæ–‡æœ¬æˆ–è€…Labelçš„Text.<br>æ¯”å¦‚æˆ‘é¡µé¢æœ‰ä¸€ä¸ªButtonï¼Œtitleæ˜¯â€œtestButtonâ€</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">func test<span class="constructor">Example()</span> throws &#123;</span><br><span class="line">     <span class="comment">// UI tests must launch the application that they test.</span></span><br><span class="line">     <span class="keyword">let</span> btn = app.buttons<span class="literal">["<span class="identifier">testButton</span>"]</span></span><br><span class="line">     <span class="constructor">XCTAssertTrue(<span class="params">btn</span>.<span class="params">exists</span>)</span></span><br><span class="line">     <span class="comment">//tap btn</span></span><br><span class="line">     btn.tap<span class="literal">()</span></span><br><span class="line">     sleep(<span class="number">2</span>)</span><br><span class="line">     take<span class="constructor">AScreenshot(<span class="string">"button"</span>)</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯å½“æˆ‘å¼€å¯å›½é™…åŒ–åï¼ŒæŒ‰é’®æ–‡æ¡ˆæ˜¯è·Ÿéšç³»ç»Ÿè¯­è¨€å˜åŒ–çš„ï¼Œé‚£ä¸Šè¿°ä»£ç å°±ä¼šæ‰§è¡Œå¤±è´¥ã€‚<br><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/20211215160630.png" alt=""></p>
<p>è§£å†³åŠæ³•æ˜¯ä¸ºæ§ä»¶è®¾ç½®<code>accessibilityIdentifier</code>å±æ€§ã€‚<code>accessibilityIdentifier</code>æ˜¯ä¸“ä¸ºUITestè®¾è®¡çš„ã€‚å¯ä»¥æ–¹ä¾¿çš„æ‰¾åˆ°éœ€è¦çš„å…ƒç´ ã€‚</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="comment">//ä¸ºbtnè®¾ç½®accessibilityIdentifier</span></span><br><span class="line">btn<span class="selector-class">.accessibilityIdentifier</span> = <span class="string">"myTestButton"</span></span><br><span class="line">        </span><br><span class="line"><span class="comment">//åœ¨XCTestä¸­ æŒ‰accessibilityIdentifieræŸ¥æ‰¾</span></span><br><span class="line">let btn = app<span class="selector-class">.buttons</span>[<span class="string">"myTestButton"</span>]</span><br></pre></td></tr></table></figure>

<h2 id="iii-ä¸»Appå¼€å¯æµ‹è¯•ç¯å¢ƒ"><a href="#iii-ä¸»Appå¼€å¯æµ‹è¯•ç¯å¢ƒ" class="headerlink" title="iii. ä¸»Appå¼€å¯æµ‹è¯•ç¯å¢ƒ"></a>iii. ä¸»Appå¼€å¯æµ‹è¯•ç¯å¢ƒ</h2><p>XCTestæ¯æ¬¡è¿è¡Œéƒ½ä¼šé‡æ–°è¿è¡ŒAppï¼Œä¸€èˆ¬ä¸»Appå¯åŠ¨å…¥å£ä¼šæœ‰å¾ˆå¤šä¸šåŠ¡é€»è¾‘ï¼Œå¯¹æµ‹è¯•ä¼šé€ æˆå½±å“ã€‚æˆ‘ä»¬éœ€è¦åˆ¤æ–­æœ¬æ¬¡å¯åŠ¨æ˜¯ä»XCTestå¯åŠ¨çš„ï¼Œè¿™æ ·å¯ä»¥å¼€å¯æµ‹è¯•ç¯å¢ƒï¼Œå»æ‰ä¸€äº›æ— å…³çš„é€»è¾‘ã€‚<br>åœ¨UITestä¸­å¯ä»¥å‘<code>launchArguments</code>ä¸­åŠ å…¥è‡ªå®šä¹‰å‚æ•°ã€‚</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UITestDemoUITests</span>: <span class="title">XCTestCase</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> app: <span class="type">XCUIApplication!</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">setUpWithError</span><span class="params">()</span></span> <span class="keyword">throws</span> &#123;</span><br><span class="line"></span><br><span class="line">        continueAfterFailure = <span class="literal">false</span></span><br><span class="line">        app = <span class="type">XCUIApplication</span>()</span><br><span class="line">        <span class="comment">//å‘ä¸»Appä¼ é€’å‚æ•° ä¹Ÿå¯ä»¥å†™åœ¨æµ‹è¯•æ–¹æ³•ä¸­</span></span><br><span class="line">        app.launchArguments.append(<span class="string">"UDUIXCTestConfig#SubscribePage"</span>)</span><br><span class="line">        app.launch()</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨<code>Appdelegate</code>çš„<code>didFinishLaunchingWithOptions</code>ä¸­åˆ¤æ–­ï¼Œå¯ä»¥æŒ‡å®šæ ¹æ®å­—ç¬¦ä¸²æŒ‡å®šéœ€è¦æµ‹è¯•çš„åœºæ™¯ã€‚</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">    func application(_ application: UIApplication, didFinishLaunchingWithOptions launchOptions: <span class="literal">[UIA<span class="identifier">pplication</span>.L<span class="identifier">aunchOptionsKey</span>: A<span class="identifier">ny</span>]</span>?) -&gt; Bool &#123;</span><br><span class="line">    ...</span><br><span class="line">      for subArgue: String <span class="keyword">in</span> <span class="module-access"><span class="module"><span class="identifier">CommandLine</span>.</span></span>arguments &#123;</span><br><span class="line">            <span class="keyword">if</span> subArgue.has<span class="constructor">Prefix(<span class="string">"UDUIXCTestConfig"</span>)</span> &#123;</span><br><span class="line">                <span class="comment">//å¼€å¯æµ‹è¯•æ¨¡å¼</span></span><br><span class="line">                <span class="module-access"><span class="module"><span class="identifier">UDXCTestManager</span>.</span></span>share<span class="constructor">Instance()</span>.argument = subArgue</span><br><span class="line">                <span class="module-access"><span class="module"><span class="identifier">UDXCTestManager</span>.</span></span>share<span class="constructor">Instance()</span>.testModeOn = <span class="literal">true</span></span><br><span class="line">                break</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="iv-Demo"><a href="#iv-Demo" class="headerlink" title="iv. Demo"></a>iv. Demo</h2><blockquote>
<p>å¼€å¯ä¸Šè¿°æ­¥éª¤åï¼Œå·²ç»å¯ä»¥åˆæ­¥è¿›è¡ŒUIæµ‹è¯•äº†ï¼Œé€šè¿‡è®¾ç½®æµ‹è¯•ç¯å¢ƒï¼Œç¡®ä¿å¯åŠ¨åè¿›å…¥å¾…æµ‹è¯•é¡µé¢ã€‚åˆç†åˆ©ç”¨forå¾ªç¯ä»¥åŠæˆªå›¾ã€‚éœ€è¦æ³¨æ„æ¥å…¥å‰å¦‚æœæ¶‰åŠé¡µé¢è·³è½¬ç­‰ï¼Œè¦ç”¨sleep()å‡½æ•°ç­‰å¾…é¡µé¢æ¸²æŸ“å®Œåå†æˆªå›¾</p>
</blockquote>
<p>æ¯”å¦‚æˆ‘ä»¬å·¥ç¨‹ä¸­ä¸€ä¸ªæµ‹è¯•æ–¹æ³•</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">func test<span class="constructor">SubscribePage()</span> throws &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> #available(iOS <span class="number">14.0</span>, *) &#123;</span><br><span class="line">          <span class="keyword">let</span> session = <span class="keyword">try</span>? <span class="module-access"><span class="module"><span class="identifier">SKTestSession</span>.</span></span>init(configurationFileNamed: <span class="string">"Configuration"</span>)</span><br><span class="line">          session?.disableDialogs = <span class="literal">true</span></span><br><span class="line">          session?.clear<span class="constructor">Transactions()</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      app.launchArguments.append(<span class="string">"UDUIXCTestConfig#SubscribePage"</span>)</span><br><span class="line">      app.launch<span class="literal">()</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> TypeList = <span class="literal">["S", "T", "U", "V", "V3"]</span></span><br><span class="line">      for sub <span class="keyword">in</span> TypeList &#123;</span><br><span class="line">          <span class="keyword">let</span> typeElement = app.tables.staticTexts<span class="literal">[<span class="identifier">sub</span>]</span></span><br><span class="line">          <span class="constructor">XCTAssertTrue(<span class="params">typeElement</span>.<span class="params">exists</span>)</span></span><br><span class="line">          typeElement.tap<span class="literal">()</span></span><br><span class="line">          sleep(<span class="number">2</span>)</span><br><span class="line">          self.take<span class="constructor">AScreenshot(<span class="string">"\(sub) List"</span>)</span></span><br><span class="line"></span><br><span class="line">          <span class="comment">//æµ‹è¯•å­é¡µé¢</span></span><br><span class="line">          <span class="keyword">let</span> <span class="built_in">list</span> = <span class="literal">["<span class="identifier">weekly_free</span>", "<span class="identifier">monthly_free</span>", "<span class="identifier">yearly_free</span>"]</span></span><br><span class="line">          for sublist <span class="keyword">in</span> <span class="built_in">list</span> &#123;</span><br><span class="line">              sleep(<span class="number">2</span>)</span><br><span class="line">              <span class="keyword">let</span> subtypeElement = app.tables.staticTexts<span class="literal">[<span class="identifier">sublist</span>]</span></span><br><span class="line">              <span class="constructor">XCTAssertTrue(<span class="params">subtypeElement</span>.<span class="params">exists</span>)</span></span><br><span class="line">              <span class="comment">//è¿›å…¥å¾…æµ‹è¯•é¡µ</span></span><br><span class="line">              subtypeElement.tap<span class="literal">()</span></span><br><span class="line">              sleep(<span class="number">2</span>)</span><br><span class="line">              self.take<span class="constructor">AScreenshot(<span class="string">"\(sub)-\(sublist)-1"</span>)</span></span><br><span class="line">              sleep(<span class="number">1</span>)</span><br><span class="line">              <span class="keyword">if</span> sub<span class="operator"> == </span><span class="string">"S"</span><span class="operator"> || </span>sub<span class="operator"> == </span><span class="string">"T"</span> &#123;</span><br><span class="line">                  <span class="comment">//æ»šåŠ¨åˆ°åº•éƒ¨</span></span><br><span class="line">                  app.swipe<span class="constructor">Up()</span></span><br><span class="line">                  sleep(<span class="number">1</span>)</span><br><span class="line">                  <span class="comment">//å¯¹åº•éƒ¨æˆªå›¾ æ— æ³•æ»šåŠ¨çš„é¡µé¢å¯ä»¥è€ƒè™‘è¿‡æ»¤æ‰</span></span><br><span class="line">                  self.take<span class="constructor">AScreenshot(<span class="string">"\(sub)-\(sublist)-2"</span>)</span></span><br><span class="line">                  sleep(<span class="number">3</span>)</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  sleep(<span class="number">4</span>)</span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">//è¿”å›ä¸Šä¸€é¡µé¢</span></span><br><span class="line">          <span class="keyword">let</span> backButton = <span class="constructor">XCUIApplication()</span>.navigationBars.buttons<span class="literal">["<span class="identifier">backButton</span>"]</span></span><br><span class="line">          <span class="constructor">XCTAssert(<span class="params">backButton</span>.<span class="params">exists</span>)</span></span><br><span class="line">          backButton.tap<span class="literal">()</span></span><br><span class="line">          sleep(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h1 id="3-TestPlans"><a href="#3-TestPlans" class="headerlink" title="3.TestPlans"></a>3.TestPlans</h1><p>ä¸Šè¿°æ–¹æ¡ˆæ¯æ¬¡åªèƒ½æµ‹è¯•ä¸€ä¸ªå›½é™…åŒ–è¯­è¨€ï¼Œæ¯æ¬¡åˆ‡æ¢è¯­è¨€åéœ€è¦é‡æ–°è¿è¡Œã€‚åœ¨<code>TestPlans</code>æ¨å‡ºä¹‹å‰éœ€è¦æˆ‘ä»¬è‡ªå·±å†™<code>xcodebuild</code>å‘½ä»¤æ¥æŒ‡å®šå›½é™…åŒ–è¯­è¨€æˆ–è€…åœ¨Schemesä¸­é…ç½®App Langauge<br><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/20211215160655.png" alt=""></p>
<p><code>TestPlans</code>æ˜¯Appleåœ¨2019å¹´WWDCæ¨å‡ºçš„æµ‹è¯•å·¥å…·ï¼Œè¯¦ç»†ä¿¡æ¯è¯¦è§<a href="https://developer.apple.com/videos/play/wwdc2019/413/" target="_blank" rel="noopener">ã€ŠTesting in Xcodeã€‹</a>, æ¨å‡ºåå¯ä»¥æ›´æ–¹ä¾¿çš„è¿›è¡Œå›½é™…åŒ–è¯­è¨€ä»¥åŠå…¶ä½™é…ç½®çš„åˆ‡æ¢ã€‚</p>
<p>å¼€å¯æ–¹å¼ä¹Ÿå¾ˆç®€å•ï¼Œåœ¨â€œEdit Scheme..â€â€”&gt; â€œTestâ€ â€”&gt; â€œCovert to use Test Plansâ€<br><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/20211215160726.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/20211215160746.png" alt=""><br>é€‰æ‹©æ”¾åˆ°ä¸»å·¥ç¨‹ä¸­ï¼Œè®¾ç½®æˆDefault<br><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/20211215160807.png" alt=""></p>
<h2 id="i-é…ç½®Configuration"><a href="#i-é…ç½®Configuration" class="headerlink" title="i. é…ç½®Configuration"></a>i. é…ç½®Configuration</h2><p>åœ¨ä¸»å·¥ç¨‹ä¸­æ‰¾åˆ°<code>.xctestplan</code>åç¼€çš„æ–‡ä»¶ã€‚<br><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/20211215161029.png" alt=""><br>å¯ä»¥å‘ç°åœ¨Configurationä¸­å¯ä»¥è®¾ç½®è¯­è¨€ã€åœ°åŒºã€å¼€å¯<code>Code Coverage</code>ç­‰åŠŸèƒ½ã€‚</p>
<p>å¯ä»¥ç‚¹å‡»åŠ å·åŠ æ–°çš„é…ç½®æ–‡ä»¶ï¼Œé»˜è®¤çš„é…ç½®æ˜¯è¯»å–Share Settingsçš„é…ç½®ã€‚<br><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/20211215161044.png" alt=""><br>æ¯”å¦‚æˆ‘ä»¬çš„å·¥ç¨‹ï¼Œé…ç½®äº†ä¸»è¦é€‚é…çš„è¯­è¨€ã€‚<br><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/20211215161113.png" alt=""></p>
<h2 id="ii-é€‰æ‹©æµ‹è¯•æ–¹æ³•ã€å¼€å¯å¹¶è¡Œ"><a href="#ii-é€‰æ‹©æµ‹è¯•æ–¹æ³•ã€å¼€å¯å¹¶è¡Œ" class="headerlink" title="ii. é€‰æ‹©æµ‹è¯•æ–¹æ³•ã€å¼€å¯å¹¶è¡Œ"></a>ii. é€‰æ‹©æµ‹è¯•æ–¹æ³•ã€å¼€å¯å¹¶è¡Œ</h2><p>åœ¨Testé¢æ¿ï¼Œå¯ä»¥çœ‹åˆ°æ‰€æœ‰æµ‹è¯•æ–¹æ³•ï¼Œå¯ä»¥å‹¾é€‰éœ€è¦æµ‹è¯•çš„æ–¹æ³•ï¼Œå‹¾é€‰å¤šä¸ªä¼šæŒ‰ç€ä»ä¸Šåˆ°ä¸‹çš„é¡ºåºæ‰§è¡Œã€‚åœ¨Optionsä¸­æ‰“å¼€<code>Execute in parallel</code>ã€‚æ‰“å¼€åå¯ä»¥åœ¨èµ„æºå…è®¸çš„æƒ…å†µä¸‹ï¼Œå¼€å¯å¤šä¸ªå…‹éš†çš„æ¨¡æ‹Ÿå™¨ï¼Œæé«˜æµ‹è¯•é€Ÿåº¦ã€‚</p>
<blockquote>
<p>æ¯”å¦‚æ‰§è¡ŒPhone Xæœºå‹çš„ä¸€ä¸ªæµ‹è¯•æ–¹æ³•ï¼Œåœ¨Configurationä¸­é…ç½®äº†6ä¸ªé…ç½®æ–‡ä»¶ï¼Œèµ„æºå…è®¸æƒ…å†µä¸‹ä¼šå¼€å¯3ä¸ªiPhone Xæ¨¡æ‹Ÿå™¨ï¼Œæ¯ä¸ªæ¨¡æ‹Ÿå™¨è·‘2ä¸ªé…ç½®ï¼Œé€Ÿåº¦æé«˜äº†3å€ã€‚</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/20211215161123.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/20211215161136.png" alt=""></p>
<h2 id="iii-è¿è¡ŒTest-Plans"><a href="#iii-è¿è¡ŒTest-Plans" class="headerlink" title="iii.  è¿è¡ŒTest Plans"></a>iii.  è¿è¡ŒTest Plans</h2><p><code>Test Plans</code>çš„è¿è¡Œæ–¹å¼å’Œä¹‹å‰ä¸€æ ·ï¼Œæ‰¾åˆ°ä¹‹å‰çš„æ–¹æ³•å…¥å£ï¼Œç‚¹å‡»è¿è¡Œæˆ–è€…æŒ‰å³é”®åªè¿è¡Œéƒ¨åˆ†é…ç½®<br><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/20211215161152.png" alt=""></p>
<h2 id="iv-æŸ¥çœ‹ç»“æœ"><a href="#iv-æŸ¥çœ‹ç»“æœ" class="headerlink" title="iv. æŸ¥çœ‹ç»“æœ"></a>iv. æŸ¥çœ‹ç»“æœ</h2><p>Test Plansè¿è¡Œå®Œåå¯ä»¥åœ¨Xcodeä¸­æŸ¥çœ‹ç»“æœï¼Œå¦‚æœè¿è¡Œå¤šä¸ªé…ç½®ï¼Œæ¯ä¸ªé…ç½®çš„ç»“æœéƒ½ä¼šå•ç‹¬å‘ˆç°<br><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/20211215161209.png" alt=""></p>
<blockquote>
<p>å›½é™…åŒ–æµ‹è¯•éœ€è¦æ³¨æ„ï¼Œåœ¨Configurationä¸­æœ‰<code>Localization Screenshots</code>é€‰å‹ï¼Œé»˜è®¤æ˜¯<code>On</code>ï¼Œåªè¦æœ¬é¡µé¢æ–‡ä»¶è¿›è¡Œäº†å›½é™…åŒ–ï¼ˆä½¿ç”¨<code>NSLocalizedString</code>ï¼‰éƒ½ä¼šè‡ªåŠ¨æˆªå›¾ï¼Œå¦‚ä¸éœ€è¦å¯ä»¥å…³é—­ã€‚</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/20211215161224.png" alt=""></p>
<blockquote>
<p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ªåˆæ­¥çš„æµ‹è¯•æ–¹æ¡ˆï¼Œå¯ä»¥ç”¨XCTestå†™å®Œé¡µé¢æˆªå›¾é€»è¾‘åï¼Œä½¿ç”¨Test Plansæ‰¹é‡è¿è¡Œå¤šä¸ªè¯­è¨€ã€‚ä¸‹ä¸€ç« ä¼šä»‹ç»å¦‚ä½•è§£å†³è®¢é˜…ä¸­å¤šå¸ç§çš„é€‚é…ã€å¦‚ä½•å¿«é€Ÿå¯¼å‡ºæµ‹è¯•æˆªå›¾ä»¥åŠæœ€ç»ˆç”¨xcodebuildå’Œshellè„šæœ¬è‡ªåŠ¨åŒ–æ‰€æœ‰æ“ä½œã€‚</p>
</blockquote>
<h1 id="4-iOS-XCTestå®æˆ˜â€”è§£å†³å›½é™…åŒ–å¼€å‘æµ‹è¯•ç—›ç‚¹ï¼ˆä¸‹ï¼‰"><a href="#4-iOS-XCTestå®æˆ˜â€”è§£å†³å›½é™…åŒ–å¼€å‘æµ‹è¯•ç—›ç‚¹ï¼ˆä¸‹ï¼‰" class="headerlink" title="4.iOS XCTestå®æˆ˜â€”è§£å†³å›½é™…åŒ–å¼€å‘æµ‹è¯•ç—›ç‚¹ï¼ˆä¸‹ï¼‰"></a>4.iOS XCTestå®æˆ˜â€”è§£å†³å›½é™…åŒ–å¼€å‘æµ‹è¯•ç—›ç‚¹ï¼ˆä¸‹ï¼‰</h1><p>ä¸‹ç¯‡è¯¦è§ï¼š<a href="http://leevcan.com/2021/10/15/iOS-XCTest%E5%AE%9E%E6%88%98%E2%80%94%E8%A7%A3%E5%86%B3%E5%9B%BD%E9%99%85%E5%8C%96%E5%BC%80%E5%8F%91%E6%B5%8B%E8%AF%95%E7%97%9B%E7%82%B9%EF%BC%88%E4%B8%8B%EF%BC%89/" target="_blank" rel="noopener">iOS XCTestå®æˆ˜â€”è§£å†³å›½é™…åŒ–å¼€å‘æµ‹è¯•ç—›ç‚¹ï¼ˆä¸‹ï¼‰</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/10/12/iOS%E5%9B%BD%E9%99%85%E5%8C%96%E2%80%94Xliff%E5%BD%95%E5%85%A5%E8%84%9A%E6%9C%AC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img/avatar.png">
      <meta itemprop="name" content="weican Li">
      <meta itemprop="description" content="iOS Developer">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="licc">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/10/12/iOS%E5%9B%BD%E9%99%85%E5%8C%96%E2%80%94Xliff%E5%BD%95%E5%85%A5%E8%84%9A%E6%9C%AC/" class="post-title-link" itemprop="url">iOSå›½é™…åŒ–â€”XLIFFæ‰¹é‡å½•å…¥è„šæœ¬(ä¸€é”®æ“ä½œ)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-10-12 16:19:00" itemprop="dateCreated datePublished" datetime="2020-10-12T16:19:00+08:00">2020-10-12</time>
            </span>

          
            <span id="/2020/10/12/iOS%E5%9B%BD%E9%99%85%E5%8C%96%E2%80%94Xliff%E5%BD%95%E5%85%A5%E8%84%9A%E6%9C%AC/" class="post-meta-item leancloud_visitors" data-flag-title="iOSå›½é™…åŒ–â€”XLIFFæ‰¹é‡å½•å…¥è„šæœ¬(ä¸€é”®æ“ä½œ)" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2020/10/12/iOS%E5%9B%BD%E9%99%85%E5%8C%96%E2%80%94Xliff%E5%BD%95%E5%85%A5%E8%84%9A%E6%9C%AC/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/10/12/iOS%E5%9B%BD%E9%99%85%E5%8C%96%E2%80%94Xliff%E5%BD%95%E5%85%A5%E8%84%9A%E6%9C%AC/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>XLIFFï¼ˆXML Localisation Interchange File Formatï¼Œå³XMLæœ¬åœ°åŒ–äº¤æ¢æ–‡ä»¶æ ¼å¼ï¼‰æ˜¯ä¸€ç§åŸºäºXMLçš„äº¤æ¢æ ¼å¼ï¼Œæ—¨åœ¨æ ‡å‡†åŒ–æœ¬åœ°åŒ–è¿‡ç¨‹ä¸­åœ¨å·¥å…·ä¹‹é—´ä¼ é€’å¯æœ¬åœ°åŒ–æ•°æ®çš„æ–¹å¼ï¼Œæ˜¯CATå·¥å…·ä¸­å¸¸ç”¨çš„ä¸€ç§æ–‡ä»¶æ ¼å¼ã€‚XLIFFç”±ç»“æ„åŒ–ä¿¡æ¯æ ‡å‡†ä¿ƒè¿›ç»„ç»‡ï¼ˆOASISï¼‰äº2002å¹´æ ‡å‡†åŒ–ï¼Œç›®å‰è§„èŒƒä¸º2014å¹´8æœˆ5æ—¥å‘å¸ƒçš„v2.0<br>ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ â€”â€”Wiki</p>
</blockquote>
<hr>
<p>update:å‡çº§åˆ°Xcode13ä»¥åï¼ŒExport Localizationns ä¼šæŠ¥é”™ï¼Œéœ€è¦åœ¨<code>Build Setting</code>ä¸­è®¾ç½®<code>Use Compiler to Extract Swift Strings</code>ä¸º<code>NO</code>ã€‚å¤šä¸ªtargertçš„è¯æ¯ä¸ªtargetéƒ½è®¾ç½®å³å¯ã€‚</p>
<hr>
<p>Appleå¯¹å›½é™…åŒ–æ–‡æ¡ˆçš„ç®¡ç†ä¹Ÿæ˜¯åŸºäº<code>XLIFF</code>çš„ï¼Œè¿™å‡ å¹´ä¸€ç›´è´Ÿè´£æµ·å¤–é¡¹ç›®ã€‚å›½é™…åŒ–æ–‡æ¡ˆç¿»è¯‘å’Œå½•å…¥æ˜¯å¿…ä¸å¯å…çš„ã€‚XLIFFæ˜¯ä¸šå†…çš„é€šç”¨åšæ³•ã€‚</p>
<p>å¦‚æœä½ å¯¹XLIFFä¸äº†è§£ï¼Œå¯ä»¥å‚è€ƒWWDC Session 401:<br><a href="https://developer.apple.com/videos/play/wwdc2017/401" target="_blank" rel="noopener">ã€ŠLocalizing with Xcode 9ã€‹</a></p>
<p>Appleåœ¨2018å¹´å‡çº§äº†å›½é™…åŒ–æ–‡æ¡ˆç®¡ç†æ–¹å¼ï¼Œä»<code>XLIFF</code>å‡çº§åˆ°äº†<code>Localization Catalog</code>ã€‚ä¸è¿‡æœ¬è´¨ä¸Šæ–‡æ¡ˆç®¡ç†è¿˜æ˜¯XLIFFã€‚<br><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/20201012164605.png" alt=""></p>
<p>å…·ä½“å‚è€ƒWWDC Session404:<br><a href="https://developer.apple.com/videos/play/wwdc2018/404/" target="_blank" rel="noopener">ã€ŠNew Localization Workflows in Xcode 10ã€‹</a></p>
<p><code>Localization Catalog</code> è§£å†³äº†XLIFFçš„å•ä¸€æ€§ï¼Œå¯ä»¥è®©ç¿»è¯‘äººå‘˜æ ¹æ®ä¸Šä¸‹æ–‡è¯­å¢ƒæ›´å‡†ç¡®çš„ç¿»è¯‘ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/20201012165247.png" alt=""><br><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img2/20201012164625.png" alt=""></p>
<hr>
<p><strong>ä¸€èˆ¬æ¥è¯´ï¼Œæ­£ç¡®çš„æ–¹æ³•æ˜¯ä»Xcodeä¸­ç”Ÿæˆ<code>Localization Catalog</code>ï¼Œç›´æ¥æŠŠ<code>Localization Catalog</code>ç»™åˆ°ç¿»è¯‘äººå‘˜ï¼Œç¿»è¯‘äººå‘˜æ ¹æ®storyboardæˆ–è€…å›¾ç‰‡ç»“åˆä¸Šä¸‹æ–‡ï¼Œå¯¹æ–‡æ¡ˆè¿›è¡Œç¿»è¯‘ï¼Œå¹¶ä¸”å½•å…¥åˆ°<code>XLIFF</code>ä¸­ã€‚ç„¶åæˆ‘ä»¬åªéœ€è¦å¯¼å…¥åˆ°Xcodeä¸­å°±å¯ä»¥äº†ã€‚</strong></p>
<hr>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2020/10/12/iOS%E5%9B%BD%E9%99%85%E5%8C%96%E2%80%94Xliff%E5%BD%95%E5%85%A5%E8%84%9A%E6%9C%AC/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/06/23/IAP%E2%80%94%E5%88%A4%E6%96%AD%E7%94%A8%E6%88%B7App-Store%E6%89%80%E5%9C%A8%E5%9C%B0%E5%8C%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img/avatar.png">
      <meta itemprop="name" content="weican Li">
      <meta itemprop="description" content="iOS Developer">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="licc">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/06/23/IAP%E2%80%94%E5%88%A4%E6%96%AD%E7%94%A8%E6%88%B7App-Store%E6%89%80%E5%9C%A8%E5%9C%B0%E5%8C%BA/" class="post-title-link" itemprop="url">SKStorefrontâ€”åˆ¤æ–­ç”¨æˆ·App Storeæ‰€åœ¨åœ°åŒº</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-06-23 20:53:36" itemprop="dateCreated datePublished" datetime="2020-06-23T20:53:36+08:00">2020-06-23</time>
            </span>

          
            <span id="/2020/06/23/IAP%E2%80%94%E5%88%A4%E6%96%AD%E7%94%A8%E6%88%B7App-Store%E6%89%80%E5%9C%A8%E5%9C%B0%E5%8C%BA/" class="post-meta-item leancloud_visitors" data-flag-title="SKStorefrontâ€”åˆ¤æ–­ç”¨æˆ·App Storeæ‰€åœ¨åœ°åŒº" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2020/06/23/IAP%E2%80%94%E5%88%A4%E6%96%AD%E7%94%A8%E6%88%B7App-Store%E6%89%80%E5%9C%A8%E5%9C%B0%E5%8C%BA/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/06/23/IAP%E2%80%94%E5%88%A4%E6%96%AD%E7%94%A8%E6%88%B7App-Store%E6%89%80%E5%9C%A8%E5%9C%B0%E5%8C%BA/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>æœ€è¿‘ä¸€å¹´çš„å·¥ä½œé‡å¿ƒéƒ½åœ¨æµ·å¤–è®¢é˜…é¡¹ç›®ä¸Šã€‚ROIæ•°æ®è¿˜ä¸é”™ï¼Œæ‰€ä»¥ABæµ‹è¯•è¶Šåšè¶Šå¤šã€‚<br>è¿‘æœŸè¦å®ç°ä¸€ä¸ªæ ¹æ®å›½å®¶å’Œåœ°åŒºæ¥ä¸‹å‘ä¸åŒçš„SKUçš„éœ€æ±‚ã€‚è®°å½•ä¸€ä¸‹ã€‚</p>
</blockquote>
<p>åˆ¤æ–­ç”¨æˆ·çš„å›½å®¶å’Œåœ°åŒºå¯ä»¥ç®€åŒ–ä¸ºåˆ¤æ–­ç”¨æˆ·Apple IDçš„åœ°åŒºï¼Œä¹Ÿå°±æ˜¯App Storeåœ°åŒºã€‚</p>
<p>ä¸Šæ¬¡å’ŒAppleäº¤æµï¼Œé—®äº†è¿™ä¸ªä¸ºé—®é¢˜ã€‚å‘ŠçŸ¥å¹¶æ²¡æœ‰æä¾›ç›¸å…³APIï¼ŒåŸå› æ˜¯ä½ Appæ‰€é€‰çš„é”€å”®åœ°åŒºå°±æ˜¯ä½ å†…è´­æä¾›çš„åœ°åŒºï¼Œç”¨æˆ·å¯ä»¥è½¬åŒºï¼Œè½¬åŒºåæ‰€è®¢é˜…çš„é¡¹ç›®ä¹Ÿèƒ½åœ¨æ–°åœ°åŒºæä¾›ã€‚</p>
<p><strong>ä½†æ˜¯æˆ‘è®°å¾—WWDC 2019ä¸­ï¼Œä»‹ç»äº†ä¸€ä¸ªiOS13æ–°å¢çš„APIï¼Œå¯ä»¥ç›‘å¬App Storeåœ°åŒºçš„å˜åŒ–ã€‚</strong></p>
<p>WWDCè¯¦è§ï¼š</p>
<p><a href="https://developer.apple.com/videos/play/wwdc2019/302/?time=129" target="_blank" rel="noopener">ã€ŠIn-App Purchases and Using Server-to-Server Notificationsã€‹
</a></p>
<p>æ–°å¢çš„APIæ˜¯<code>SKStorefront</code></p>
<h2 id="SKStorefront"><a href="#SKStorefront" class="headerlink" title="SKStorefront"></a>SKStorefront</h2><p><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img/20200623231316.png" alt=""></p>
<p>å®˜æ–¹æ–‡æ¡£è§ï¼š<br><a href="https://developer.apple.com/documentation/storekit/skstorefront" target="_blank" rel="noopener">https://developer.apple.com/documentation/storekit/skstorefront</a></p>
<p>è·å–åœ°åŒºä»£ç </p>
<figure class="highlight arduino"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="meta">#available(iOS 13.0, *) &#123;</span></span><br><span class="line">    <span class="built_in">print</span>(SKPaymentQueue.<span class="keyword">default</span>().storefront?.countryCode ?? <span class="string">""</span>)</span><br><span class="line"> &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„æœ‰å¯èƒ½ä¸ºnil</p>
<p>countryCodeä½¿ç”¨çš„æ˜¯ISO 3166-1 Alpha-3ä»£ç </p>
<p><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img/20200623232654.png" alt=""></p>
<p>SKStorefrontè¿˜å¯ä»¥é€šè¿‡<code>paymentQueueDidChangeStorefront</code>ç›‘å¬App Storeåœ°åŒºçš„å˜åŒ–</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">func payment<span class="constructor">QueueDidChangeStorefront(<span class="params">_</span> <span class="params">queue</span>: SKPaymentQueue)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> storefront = queue.storefront &#123;</span><br><span class="line">        <span class="comment">// Refresh the displayed products based on the new storefront.</span></span><br><span class="line">        for product <span class="keyword">in</span> storeProducts &#123;</span><br><span class="line">            <span class="keyword">if</span> should<span class="constructor">Show(<span class="params">product</span>.<span class="params">productIdentifier</span>, <span class="params">in</span>: <span class="params">storefront</span>)</span> &#123;</span><br><span class="line">                <span class="comment">// Display this product in your store UI.</span></span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Appleå®˜æ–¹æ–‡æ¡£è¯´SKStorefrontéšæ—¶å¯èƒ½å˜åŒ–ï¼Œç”šè‡³æ˜¯åœ¨è´­ä¹°è¿‡ç¨‹ä¸­ï¼Œå› æ­¤æ–°å¢äº†ä¸€ä¸ªä»£ç†æ–¹æ³•<code>paymentQueue:shouldContinueTransaction:inStorefront:</code><br><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img/20200624111003.png" alt=""><br>æ­¤æ–¹æ³•çš„ä½œç”¨æ˜¯åœ¨è´­ä¹°æ—¶å€™å‘ç”ŸSKStorefrontå˜åŒ–,å¯ä»¥åˆ¤æ–­è¦ä¸è¦ç»§ç»­æ‰§è¡Œè¿™ä¸ªTransactionã€‚</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="type">SKPaymentQueue</span>.<span class="keyword">default</span>().delegate = <span class="keyword">self</span>  <span class="comment">// Set your object as the SKPaymentQueue delegate.</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">paymentQueue</span><span class="params">(<span class="number">_</span> paymentQueue: SKPaymentQueue,</span></span></span><br><span class="line"><span class="function"><span class="params">                  shouldContinue transaction: SKPaymentTransaction,</span></span></span><br><span class="line"><span class="function"><span class="params">                  <span class="keyword">in</span> newStorefront: SKStorefront)</span></span> -&gt; <span class="type">Bool</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> shouldShow(transaction.payment.productIdentifier, <span class="keyword">in</span>: newStorefront)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœæ­¤åœ°åŒºä¸æ”¯æŒè´­ä¹°<code>paymentQueue:shouldContinueTransaction:inStorefront:</code>è¿”å›<code>false</code>ã€‚åœ¨Transactionå›è°ƒä¸­å°±ä¼šæ”¶åˆ°ä¸€ä¸ª<code>SKErrorStoreProductNotAvailable</code>çš„Errorä¿¡æ¯</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">paymentQueue</span><span class="params">(<span class="number">_</span> queue: SKPaymentQueue,</span></span></span><br><span class="line"><span class="function"><span class="params">                  updatedTransactions transactions: [SKPaymentTransaction])</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> transaction <span class="keyword">in</span> transactions &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> transactionError = transaction.error <span class="keyword">as</span> <span class="type">NSError?</span>,</span><br><span class="line">            transactionError.domain == <span class="type">SKErrorDomain</span></span><br><span class="line">            &amp;&amp; transactionError.code == <span class="type">SKError</span>.storeProductNotAvailable.rawValue &#123;</span><br><span class="line">            <span class="comment">// Show an alert.</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯<code>SKStorefront</code>åªæ”¯æŒiOS13+ï¼Œå¹¶ä¸æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ã€‚å› æ­¤è¿˜è¦æƒ³åˆ«çš„åŠæ³•ã€‚</p>
<h2 id="é€šç”¨åšæ³•"><a href="#é€šç”¨åšæ³•" class="headerlink" title="é€šç”¨åšæ³•"></a>é€šç”¨åšæ³•</h2><p> æˆ‘ä»¬çš„éœ€æ±‚æ˜¯æ ¹æ®å›½å®¶å’Œåœ°åŒºï¼Œä¸‹å‘ä¸åŒæ¯”ä¾‹çš„SKU,ä¸å­˜åœ¨è¿™ä¸ªSKUåªåœ¨è¿™ä¸ªåœ°åŒºé”€å”®çš„æƒ…å†µã€‚<strong>å› ä¸ºè®¢é˜…ç±»å‹çš„SKUï¼Œç”¨æˆ·å¯ä»¥åœ¨è®¢é˜…ç®¡ç†é‡Œé¢åˆ‡æ¢å¥—é¤</strong></p>
<p> æˆ‘çš„åšæ³•æ˜¯ä»SKUä»·æ ¼å¤„ç†å…¥æ‰‹ï¼Œå› ä¸ºæˆ‘ä»¬æ˜¯æµ·å¤–é¡¹ç›®ï¼Œåœ¨å…¨çƒé”€å”®ã€‚æ‰€ä»¥è¦è¦å‘ˆç°ç”¨æˆ·æ‰€åœ¨åœ°åŒºçš„ä»·æ ¼å’Œè´§å¸ã€‚å¯ä»¥é€šè¿‡<code>NumberFormatter</code>è¿›è¡Œè½¬æ¢<br> <figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> formatter = <span class="module-access"><span class="module"><span class="identifier">NumberFormatter</span>.</span></span>init<span class="literal">()</span></span><br><span class="line">formatter.formatterBehavior = <span class="module-access"><span class="module"><span class="identifier">NumberFormatter</span>.</span><span class="module"><span class="identifier">Behavior</span>.</span></span>behavior10_4</span><br><span class="line">formatter.numberStyle = <span class="module-access"><span class="module"><span class="identifier">NumberFormatter</span>.</span><span class="module"><span class="identifier">Style</span>.</span></span>currency</span><br><span class="line"><span class="comment">//SKProductä¸­æœ‰priceLocale</span></span><br><span class="line">formatter.locale = product!.priceLocale</span><br><span class="line"><span class="keyword">let</span> price :String = formatter.<span class="built_in">string</span>(from: self.product!.price) ?? <span class="string">"$4.99"</span></span><br></pre></td></tr></table></figure></p>
<p> ä»ä¸Šè¿°ä»£ç å¯ä»¥çœ‹åˆ°ï¼ŒSKProductä¸­æœ‰ä¸ª<code>priceLocale</code>å±æ€§ï¼Œèµ‹å€¼ç»™NumberFormatteråå¯ä»¥å¯¹ä»·æ ¼è¿›è¡Œå¤„ç†ã€‚</p>
<p>priceLocaleæ˜¯Localç±»å‹ï¼ˆOCä¸­æ˜¯NSLocalï¼‰</p>
<p> <img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img/20200624161049.png" alt=""></p>
<p> Localä¸­æœ‰<code>identifier</code>ã€<code>regionCode</code>ç­‰å±æ€§ã€‚<code>regionCode</code>ä»£è¡¨çš„å°±æ˜¯åœ°åŒºï¼Œå¯èƒ½ä¸ºnilï¼Œ<code>identifier</code>æ˜¯æ ‡è¯†ç¬¦ï¼Œæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚</p>
<p> ä¸‹å›¾æ˜¯App Storeåˆ‡æ¢åˆ°æ¾³å¤§åˆ©äºšåœ°åŒºï¼Œæ‰“å°çš„ç»“æœ<br> <img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img/20200624151437.png" alt=""><br> ä¸‹å›¾æ˜¯ç¾å›½<br> <img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img/20200624161330.png" alt=""></p>
<p> ä½†æ˜¯regionCodeå¯èƒ½ä¸ºnilï¼Œæ‰€ä»¥è¦åšä¸‹åˆ¤æ–­ï¼Œå½“regionCodeä¸ºnilæ—¶å€™ä½¿ç”¨identifierï¼Œæˆ–è€…è·Ÿç€ä¸šåŠ¡é€»è¾‘è°ƒæ•´ã€‚</p>
<p> identifierçš„æ ¼å¼ä¸€èˆ¬æ˜¯éƒ½æ˜¯å›ºå®šçš„ï¼Œå¯ä»¥æ ¹æ®@ç¬¦åˆ†å‰²ï¼Œæ‹¿åˆ°å‰é¢çš„<code>è¯­è¨€_åœ°åŒº</code>çš„å€¼ã€‚</p>
<blockquote>
<p>å¦‚ä½•å¿«é€Ÿåˆ‡æ¢App Storeåœ°åŒºå¯ä»¥çœ‹æˆ‘ä¹‹å‰å†™çš„è¿™ç¯‡æ–‡ç« <a href="http://leevcan.com/2016/03/25/iOS%E5%BC%80%E5%8F%91%E4%B8%AD%E4%B8%80%E4%BA%9B%E5%B0%8F%E5%B7%A5%E5%85%B7/" target="_blank" rel="noopener">ã€ŠiOSå¼€å‘ä¸­ä¸€äº›å°å·¥å…·ã€‹</a> ä½¿ç”¨Switcherè¿™ä¸ªå·¥å…·ã€‚å®‰è£…åœ°å€ï¼š<a href="http://switchr.imagility.io/" target="_blank" rel="noopener">http://switchr.imagility.io/</a></p>
</blockquote>
<p>è¿™ä¸ªåŠæ³•å¿…é¡»å…ˆè·å–ä¸€ä¸ªå¯ç”¨çš„<code>SKProduct</code>,å¹¶ä¸èƒ½åœ¨è¯·æ±‚<code>SKProduct</code>ä¹‹å‰æ‹¿åˆ°åœ°åŒºã€‚æ‰€ä»¥è¿˜æ˜¯æœ‰ä¸€å®šçš„å±€é™æ€§ã€‚</p>
<p>æˆ‘ä¸€èˆ¬æ˜¯åœ¨<code>productsRequest:didReceiveResponse:</code>å›è°ƒä¸­ï¼Œæ‹¿åˆ°ä¸€ä¸ª<code>SKProduct</code>è·å–åˆ°åœ°åŒºåå°±å­˜èµ·æ¥ã€‚æœ‰ä¸ªè¿™ä¸ªå‚æ•°ä¹Ÿå¯ä»¥åœ¨åŸ‹ç‚¹ä¸ŠæŠ¥ä¸­ç”¨åˆ°ï¼Œæ ‡æ˜ç”¨æˆ·çš„App Storeåœ°åŒºã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/30/%E4%BB%8E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90Swift%E5%A4%9A%E7%BA%BF%E7%A8%8B%E2%80%94DispatchGroup/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img/avatar.png">
      <meta itemprop="name" content="weican Li">
      <meta itemprop="description" content="iOS Developer">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="licc">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/30/%E4%BB%8E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90Swift%E5%A4%9A%E7%BA%BF%E7%A8%8B%E2%80%94DispatchGroup/" class="post-title-link" itemprop="url">ä»æºç åˆ†æSwiftå¤šçº¿ç¨‹â€”DispatchGroup</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-05-30 22:18:46" itemprop="dateCreated datePublished" datetime="2020-05-30T22:18:46+08:00">2020-05-30</time>
            </span>

          
            <span id="/2020/05/30/%E4%BB%8E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90Swift%E5%A4%9A%E7%BA%BF%E7%A8%8B%E2%80%94DispatchGroup/" class="post-meta-item leancloud_visitors" data-flag-title="ä»æºç åˆ†æSwiftå¤šçº¿ç¨‹â€”DispatchGroup" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2020/05/30/%E4%BB%8E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90Swift%E5%A4%9A%E7%BA%BF%E7%A8%8B%E2%80%94DispatchGroup/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/05/30/%E4%BB%8E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90Swift%E5%A4%9A%E7%BA%BF%E7%A8%8B%E2%80%94DispatchGroup/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>æœ¬æ–‡ä»æºç åˆ†æGCDä¸­çš„DispatchGroupæ˜¯æ€ä¹ˆè°ƒåº¦çš„ï¼Œnotifyçš„èƒŒåæ˜¯å¦‚ä½•å®ç°çš„ã€‚å¦‚æœä½ å¯¹Swiftä¸­GCDå¦‚ä½•ä½¿ç”¨ä¸å¤ªäº†è§£ã€‚å¯ä»¥å‚è€ƒ<a href="http://leevcan.com/2020/05/22/%E4%BB%8E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90Swift%E5%A4%9A%E7%BA%BF%E7%A8%8B/" target="_blank" rel="noopener">ã€Šè¯¦è§£Swiftå¤šçº¿ç¨‹ã€‹</a></p>
</blockquote>
<h3 id="API"><a href="#API" class="headerlink" title="API"></a>API</h3><p>ä»¥ä¸‹ä»£ç æ˜¯DispatchGroupçš„å¸¸ç”¨ä½¿ç”¨åœºæ™¯</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">        let g1 = DispatchGroup.init()</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//ç›´æ¥è¾“å…¥notify null</span></span><br><span class="line">        g1.notify(<span class="string">queue:</span> DispatchQueue.global()) &#123;</span><br><span class="line">            print(<span class="string">"notify null"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//A B å¹¶å‘ A B å®Œæˆåå¼€å¯Cä»»åŠ¡</span></span><br><span class="line"></span><br><span class="line">        g1.enter()</span><br><span class="line">        DispatchQueue.global().async &#123;</span><br><span class="line">            <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="number">0.</span>.<span class="number">.3</span>&#123;</span><br><span class="line">              print(<span class="string">"task A: \(Thread.current)"</span>)</span><br><span class="line">          &#125;</span><br><span class="line">          g1.leave()</span><br><span class="line">        &#125;</span><br><span class="line">      </span><br><span class="line">        g1.enter()</span><br><span class="line">        DispatchQueue.global().async &#123;</span><br><span class="line">            <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="number">0.</span>.<span class="number">.3</span> &#123;</span><br><span class="line">                print(<span class="string">"task B: \(Thread.current)"</span>)</span><br><span class="line">          &#125;</span><br><span class="line">            <span class="comment">//sleep(UInt32(3.5))</span></span><br><span class="line">          g1.leave()</span><br><span class="line">      &#125;</span><br><span class="line">        </span><br><span class="line">      g1.notify(<span class="string">queue:</span> DispatchQueue.global()) &#123;</span><br><span class="line">            print(<span class="string">"notify A&amp;B"</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      g1.notify(<span class="string">queue:</span> DispatchQueue.global()) &#123;</span><br><span class="line">            print(<span class="string">"notify A&amp;B again"</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      </span><br><span class="line">      </span><br><span class="line">      <span class="comment">//æ‰“å°ç»“æœ</span></span><br><span class="line">notify <span class="literal">null</span></span><br><span class="line">task <span class="string">A:</span> &lt;<span class="string">NSThread:</span> <span class="number">0x600002be85c0</span>&gt;&#123;number = <span class="number">4</span>, name = (<span class="literal">null</span>)&#125;</span><br><span class="line">task <span class="string">B:</span> &lt;<span class="string">NSThread:</span> <span class="number">0x600002bc5300</span>&gt;&#123;number = <span class="number">6</span>, name = (<span class="literal">null</span>)&#125;</span><br><span class="line">task <span class="string">A:</span> &lt;<span class="string">NSThread:</span> <span class="number">0x600002be85c0</span>&gt;&#123;number = <span class="number">4</span>, name = (<span class="literal">null</span>)&#125;</span><br><span class="line">task <span class="string">B:</span> &lt;<span class="string">NSThread:</span> <span class="number">0x600002bc5300</span>&gt;&#123;number = <span class="number">6</span>, name = (<span class="literal">null</span>)&#125;</span><br><span class="line">task <span class="string">A:</span> &lt;<span class="string">NSThread:</span> <span class="number">0x600002be85c0</span>&gt;&#123;number = <span class="number">4</span>, name = (<span class="literal">null</span>)&#125;</span><br><span class="line">task <span class="string">A:</span> &lt;<span class="string">NSThread:</span> <span class="number">0x600002be85c0</span>&gt;&#123;number = <span class="number">4</span>, name = (<span class="literal">null</span>)&#125;</span><br><span class="line">task <span class="string">B:</span> &lt;<span class="string">NSThread:</span> <span class="number">0x600002bc5300</span>&gt;&#123;number = <span class="number">6</span>, name = (<span class="literal">null</span>)&#125;</span><br><span class="line">task <span class="string">B:</span> &lt;<span class="string">NSThread:</span> <span class="number">0x600002bc5300</span>&gt;&#123;number = <span class="number">6</span>, name = (<span class="literal">null</span>)&#125;</span><br><span class="line">notify A&amp;B</span><br><span class="line">notify A&amp;B again</span><br></pre></td></tr></table></figure>
<p>ç”±ä»¥ä¸Šä»£ç ç»“æœå¯ä»¥å¾—çŸ¥ï¼Œnotityä¹‹å‰æ²¡æœ‰è°ƒç”¨enter()å’Œlevae()ä¼šç›´æ¥è¢«è°ƒç”¨ã€‚<br>å¦‚æœåœ¨notityä¹‹å‰è°ƒç”¨äº†enter()å’Œleave()ã€‚notifyä¼šåœ¨æœ€åä¸€ä¸ªleave()è°ƒç”¨åæ‰ä¼šå›è°ƒã€‚</p>
<p>wait()çš„ä½¿ç”¨</p>
<figure class="highlight maxima"><table><tr><td class="code"><pre><span class="line"><span class="built_in">let</span> <span class="built_in">g1</span> = DispatchGroup.init()</span><br><span class="line">        </span><br><span class="line">  <span class="built_in">g1</span>.enter()</span><br><span class="line">  DispatchQueue.global().async &#123;</span><br><span class="line">      <span class="keyword">for</span> <span class="symbol">_</span> <span class="keyword">in</span> <span class="number">0</span>...<span class="number">3</span>&#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"task A: \(Thread.current)"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">g1</span>.leave()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">g1</span>.enter()</span><br><span class="line">  DispatchQueue.global().async &#123;</span><br><span class="line">      <span class="keyword">for</span> <span class="symbol">_</span> <span class="keyword">in</span> <span class="number">0</span>...<span class="number">3</span> &#123;</span><br><span class="line">          <span class="built_in">print</span>(<span class="string">"task B: \(Thread.current)"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">      sleep(UInt32(<span class="number">3.5</span>))</span><br><span class="line">    <span class="built_in">g1</span>.leave()</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  <span class="built_in">let</span> result = <span class="built_in">g1</span>.wait(timeout: .now() + <span class="number">3</span>)</span><br><span class="line">  </span><br><span class="line"> </span><br><span class="line">  switch result &#123;</span><br><span class="line">  case .success:</span><br><span class="line">      <span class="built_in">g1</span>.notify(queue: DispatchQueue.global()) &#123;</span><br><span class="line">          DispatchQueue.global().async &#123;</span><br><span class="line">              <span class="keyword">for</span> <span class="symbol">_</span> <span class="keyword">in</span> <span class="number">0</span>...<span class="number">3</span> &#123;</span><br><span class="line">                  <span class="built_in">print</span>(<span class="string">"task D: \(Thread.current)"</span>)</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">  case .timedOut:</span><br><span class="line">      <span class="built_in">print</span>(<span class="string">"timedOut"</span>)</span><br><span class="line">      <span class="built_in">break</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  //æ‰“å°ç»“æœ</span><br><span class="line">  timedOut</span><br></pre></td></tr></table></figure>
<h3 id="æŸ¥çœ‹æºç "><a href="#æŸ¥çœ‹æºç " class="headerlink" title="æŸ¥çœ‹æºç "></a>æŸ¥çœ‹æºç </h3><p>Swiftä½¿ç”¨çš„GCDæ˜¯æ¡¥æ¥OCçš„æºç ã€‚æ‰€ä»¥åº•å±‚è¿˜æ˜¯libdispatchã€‚</p>
<p>æºç å¯ä»¥å»opensourceä¸‹è½½ï¼š<a href="https://opensource.apple.com/tarballs/libdispatch/" target="_blank" rel="noopener">https://opensource.apple.com/tarballs/libdispatch/</a></p>
<p>ä¹Ÿå¯ä»¥å»githubä¸ŠAppleå®˜æ–¹ä»“åº“å»ä¸‹è½½ï¼š<a href="https://github.com/apple/swift-corelibs-libdispatch" target="_blank" rel="noopener">https://github.com/apple/swift-corelibs-libdispatch</a></p>
<blockquote>
<p>è¦æ³¨æ„Appleçš„æºç æ˜¯ä¸€ç›´åœ¨è¿­ä»£å‡çº§çš„ã€‚å°è£…ä¹Ÿæ˜¯è¶Šæ¥è¶Šæ·±ï¼Œåœ¨opensourceä¸Šå¯ä»¥çœ‹åˆ°å¾ˆå¤šç‰ˆæœ¬çš„æºç ã€‚å†™è¿™ç¯‡æ–‡ç« æ—¶å€™æœ€æ–°ç‰ˆæœ¬ä¸º1173.40.5ç‰ˆæœ¬ã€‚æœ¬æ–‡åˆ†æåŸºäº931.60.2ç‰ˆæœ¬ã€‚ç½‘é€Ÿå¾ˆå¤šèµ„æ–™çš„æºç éƒ½æ˜¯å¾ˆè€çš„187.9ç‰ˆæœ¬ä¹‹å‰ã€‚å†…éƒ¨å®ç°å˜åŠ¨å¾ˆå¤§ã€‚</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img/20200601114808.png" alt=""></p>
<p>ä¸‹è½½æºç åï¼Œå¯ä»¥åœ¨semaphore.cä¸­æ‰¾åˆ°DispatchGroupçš„å®ç°ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img/20200601114842.png" alt=""></p>
<h4 id="create"><a href="#create" class="headerlink" title="create"></a>create</h4><p>å…ˆæ¥çœ‹çœ‹dispatch_group_createçš„å®ç°</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//libdispatch-913.60.2.tar.gz</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">dispatch_group_t</span></span><br><span class="line">dispatch_group_create(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> _dispatch_group_create_with_count(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//è€Œç½‘ä¸Šçš„èµ„æ–™ä¸€èˆ¬éƒ½æ¯”è¾ƒè€</span></span><br><span class="line"><span class="comment">//ä¸€èˆ¬æ˜¯ libdispatch-187.9.tar.gz æˆ–è€…ä¹‹å‰</span></span><br><span class="line"><span class="comment">//è¿™æ˜¯æ—§çš„ä»£ç  å¯ä»¥çœ‹åˆ°ä¼ å…¥çš„å€¼æ˜¯LONG_MAX</span></span><br><span class="line"><span class="keyword">dispatch_group_t</span></span><br><span class="line">dispatch_group_create(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> (<span class="keyword">dispatch_group_t</span>)dispatch_semaphore_create(LONG_MAX);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>_dispatch_group_create_with_countçš„å®ç°</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">DISPATCH_ALWAYS_INLINE</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">dispatch_group_t</span></span><br><span class="line">_dispatch_group_create_with_count(<span class="keyword">long</span> count)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//dispatch_group_tå°±æ˜¯dispatchGroup</span></span><br><span class="line">	<span class="comment">//dispatch_group_tæœ¬è´¨ä¸Šå°±æ˜¯dispatch_group_s è¯¦è§ä¸‹æ–¹</span></span><br><span class="line">	<span class="keyword">dispatch_group_t</span> dg = (<span class="keyword">dispatch_group_t</span>)_dispatch_object_alloc(</span><br><span class="line">			DISPATCH_VTABLE(group), <span class="keyword">sizeof</span>(struct dispatch_group_s));</span><br><span class="line">	<span class="comment">//æŠŠcountçš„å€¼å­˜è¿›å»ç»“æ„ä½“</span></span><br><span class="line">	_dispatch_semaphore_class_init(count, dg);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 å¦‚æœæœ‰å€¼ å°±æ‰§è¡Œos_atomic_store2o</span></span><br><span class="line"><span class="comment">     </span></span><br><span class="line"><span class="comment">	_dispatch_group_create_and_enter å°±æ˜¯ä¼ å…¥1è¿›æ¥</span></span><br><span class="line"><span class="comment">	dispatch_group_t</span></span><br><span class="line"><span class="comment">    _dispatch_group_create_and_enter(void)&#123;</span></span><br><span class="line"><span class="comment">	return _dispatch_group_create_with_count(1);</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">    **/</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (count) &#123;</span><br><span class="line">		os_atomic_store2o(dg, do_ref_cnt, <span class="number">1</span>, relaxed); <span class="comment">// &lt;rdar://problem/22318411&gt;</span></span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">			#define os_atomic_store2o(p, f, v, m) \</span></span><br><span class="line"><span class="comment">			æ³¨æ„ &amp;(p)-&gt;f</span></span><br><span class="line"><span class="comment">			ç­‰äºæŠŠ1å­˜è¿›dg.do_ref_cnt</span></span><br><span class="line"><span class="comment">			os_atomic_store(&amp;(p)-&gt;f, (v), m)</span></span><br><span class="line"><span class="comment">		**/</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> dg;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬ä¸€ä¸ªä¸€ä¸ªæ¥åˆ†æ</p>
<p>é€šè¿‡æœç´¢å‘ç°dispatch_group_tæœ¬è´¨ä¸Šå°±æ˜¯dispatch_group_s</p>
<p><img src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img/20200601114914.png" alt=""></p>
<p>dispatch_group_sæ˜¯ä¸€ä¸ªç»“æ„ä½“</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dispatch_group_s</span> &#123;</span></span><br><span class="line">	DISPATCH_SEMAPHORE_HEADER(group, dg);</span><br><span class="line">    <span class="comment">//çœ‹åå­—çŸ¥é“å’Œwaitæ–¹æ³•æœ‰å…³</span></span><br><span class="line">	<span class="keyword">int</span> <span class="keyword">volatile</span> dg_waiters;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">//dispatch_continuation_så¯ä»¥è‡ªè¡Œæœç´¢ æœ€åæ˜¯ä¸ªdispatch_object_s</span></span><br><span class="line">	<span class="comment">//è¿™é‡Œå¯ä»¥ç†è§£ä¸ºå­˜å‚¨ä¸€ä¸ªé“¾è¡¨çš„ é“¾è¡¨å¤´å’Œå°¾ã€‚çœ‹å‚æ•°åçŸ¥é“å’Œnotifyæœ‰å…³</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dispatch_continuation_s</span> *<span class="title">volatile</span> <span class="title">dg_notify_head</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dispatch_continuation_s</span> *<span class="title">volatile</span> <span class="title">dg_notify_tail</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>ä»ä¸Šé¢ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œcreatæ–¹æ³•åˆ›å»ºäº†ä¸€ä¸ªdispatch_group_tï¼ˆä¹Ÿæ˜¯dispatch_group_sï¼‰å‡ºæ¥ï¼Œé»˜è®¤ä¼ è¿›æ¥çš„countæ˜¯0ï¼Œå¹¶ä¸”æŠŠcounté€šè¿‡dispatch_semaphore_class_init(count, dg)å­˜äº†èµ·æ¥ã€‚</p>
<p>dispatch_semaphore_class_init</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//_dispatch_semaphore_class_init(count, dg);</span></span><br><span class="line">static void</span><br><span class="line"><span class="constructor">_dispatch_semaphore_class_init(<span class="params">long</span> <span class="params">value</span>, <span class="params">dispatch_semaphore_class_t</span> <span class="params">dsemau</span>)</span></span><br><span class="line">&#123;	</span><br><span class="line">	<span class="comment">//dsemauå°±æ˜¯dg æœ¬è´¨å°±æ˜¯æŠŠä¼ é€’è¿›æ¥çš„countå­˜èµ·æ¥</span></span><br><span class="line">	<span class="keyword">struct</span> dispatch_semaphore_header_s *dsema = dsemau._dsema_hdr;</span><br><span class="line"></span><br><span class="line">	dsema-&gt;do_next = DISPATCH_OBJECT_LISTLESS;</span><br><span class="line">	dsema-&gt;do_targetq = <span class="constructor">_dispatch_get_root_queue(DISPATCH_QOS_DEFAULT, <span class="params">false</span>)</span>;</span><br><span class="line">	<span class="comment">//valueå°±æ˜¯ä¼ è¿›æ¥çš„count</span></span><br><span class="line">	dsema-&gt;dsema_value = value;</span><br><span class="line">	<span class="constructor">_dispatch_sema4_init(&amp;<span class="params">dsema</span>-&gt;<span class="params">dsema_sema</span>, <span class="params">_DSEMA4_POLICY_FIFO</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ok,é€šè¿‡creatæ–¹æ³•æˆ‘ä»¬çŸ¥é“æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªdispatch_group_så‡ºæ¥ï¼Œå¹¶ä¸”æŠŠ0å­˜äº†èµ·æ¥ã€‚çŸ¥é“dispatch_group_sä¸­æœ‰ä¸€ä¸ªç±»ä¼¼é“¾è¡¨çš„å¤´å’Œå°¾ï¼Œçœ‹å‚æ•°åçŸ¥é“å’Œnotifyæœ‰å…³ã€‚</p>
<h4 id="enter"><a href="#enter" class="headerlink" title="enter()"></a>enter()</h4><p>enter() æœ¬è´¨ä¸Šè°ƒç”¨dispatch_group_enter()</p>
<p>dispatch_group_enter</p>
<figure class="highlight cs"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">dispatch_group_enter(dispatch_group_t dg)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//os_atomic_inc_orig2oæ˜¯å®å®šä¹‰ï¼Œå¯ä»¥ä¸€ç›´ç‚¹è¿›å»çœ‹ã€‚æœ¬è´¨ä¸Šå°±æ˜¯æŠŠdgçš„dg_valueåš+1æ“ä½œã€‚</span></span><br><span class="line">	<span class="keyword">long</span> <span class="keyword">value</span> = os_atomic_inc_orig2o(dg, dg_value, acquire);</span><br><span class="line">    </span><br><span class="line">	<span class="keyword">if</span> (slowpath((unsigned <span class="keyword">long</span>)<span class="keyword">value</span> &gt;= (unsigned <span class="keyword">long</span>)LONG_MAX)) &#123;</span><br><span class="line">		DISPATCH_CLIENT_CRASH(<span class="keyword">value</span>,</span><br><span class="line">				<span class="string">"Too many nested calls to dispatch_group_enter()"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">value</span> == <span class="number">0</span>) &#123;</span><br><span class="line">		_dispatch_retain(dg); <span class="comment">// &lt;rdar://problem/22318411&gt;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>ä»æºç ä¸Šçœ‹enteræ²¡åšå…¶ä½™çš„æ“ä½œï¼Œå°±æ˜¯æŠŠdgçš„dg_valueåš+1æ“ä½œã€‚å¦‚æœdg_valueå€¼è¿‡å¤§å°±ä¼šcrashã€‚</p>
<h4 id="leave"><a href="#leave" class="headerlink" title="leave()"></a>leave()</h4><p>é‚£ä¹ˆåŒç†æˆ‘ä»¬å¯ä»¥æƒ³åˆ°leave()åº”è¯¥æ˜¯åš-1æ“ä½œã€‚</p>
<figure class="highlight cs"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">dispatch_group_leave(dispatch_group_t dg)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//dg_value -1</span></span><br><span class="line">	<span class="keyword">long</span> <span class="keyword">value</span> = os_atomic_dec2o(dg, dg_value, release);</span><br><span class="line">	<span class="keyword">if</span> (slowpath(<span class="keyword">value</span> == <span class="number">0</span>)) &#123;</span><br><span class="line">    	<span class="comment">//å½“value==0 æ‰§è¡Œ_dispatch_group_wake</span></span><br><span class="line">		<span class="keyword">return</span> (<span class="keyword">void</span>)_dispatch_group_wake(dg, <span class="literal">true</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//ä¸æˆå¯¹å‡ºç° crash</span></span><br><span class="line">	<span class="keyword">if</span> (slowpath(<span class="keyword">value</span> &lt; <span class="number">0</span>)) &#123;</span><br><span class="line">		DISPATCH_CLIENT_CRASH(<span class="keyword">value</span>,</span><br><span class="line">				<span class="string">"Unbalanced call to dispatch_group_leave()"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»æºç å¾—çŸ¥ï¼Œleaveçš„æ ¸å¿ƒé€»è¾‘æ˜¯åˆ¤æ–­value==0æ—¶å€™æ‰§è¡Œ<strong>_dispatch_group_wake</strong>ã€‚åŒæ—¶å½“levaeæ¬¡æ•°æ¯”enterå¤šæ—¶å€™ï¼Œvalue&lt;0ä¼šcrash</p>
<p>åŒæ—¶çœŸæ­£æ‰§è¡Œçš„é€»è¾‘åº”è¯¥åœ¨_dispatch_group_wakeä¸­</p>
<h4 id="notify"><a href="#notify" class="headerlink" title="notify()"></a>notify()</h4><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">DISPATCH_ALWAYS_INLINE</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span></span><br><span class="line">_dispatch_group_notify(<span class="keyword">dispatch_group_t</span> dg, <span class="keyword">dispatch_queue_t</span> dq,</span><br><span class="line">		<span class="keyword">dispatch_continuation_t</span> dsn)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//æŠŠç›®æ ‡é˜Ÿåˆ—ä¿å­˜åˆ°dc_dataä¸­</span></span><br><span class="line">	dsn-&gt;dc_data = dq;</span><br><span class="line">	dsn-&gt;do_next = <span class="literal">NULL</span>;</span><br><span class="line">	_dispatch_retain(dq);</span><br><span class="line">	<span class="keyword">if</span> (os_mpsc_push_update_tail(dg, dg_notify, dsn, do_next)) &#123;</span><br><span class="line">		_dispatch_retain(dg);</span><br><span class="line">		os_atomic_store2o(dg, dg_notify_head, dsn, ordered);</span><br><span class="line">		<span class="comment">// seq_cst with atomic store to notify_head &lt;rdar://problem/11750916&gt;</span></span><br><span class="line">		<span class="comment">//åˆ¤æ–­dg.dg_valueæ˜¯å¦ä¸º0 </span></span><br><span class="line">		<span class="keyword">if</span> (os_atomic_load2o(dg, dg_value, ordered) == <span class="number">0</span>) &#123;</span><br><span class="line">			_dispatch_group_wake(dg, <span class="literal">false</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼Œæ ¸å¿ƒé€»è¾‘è¿˜æ˜¯dg.davalueä¸º0çš„è¯ï¼Œå°±ç›´æ¥è°ƒç”¨_dispatch_group_wakeã€‚æ‰€ä»¥å¯ä»¥è§£é‡Šä¸ºä»€ä¹ˆnotifyè°ƒç”¨ä¹‹å‰æ²¡æœ‰enterå’Œleaveä¸ºä»€ä¹ˆä¼šç›´æ¥è¢«å›è°ƒã€‚<strong>å› ä¸ºæ²¡æœ‰enterå’Œleaveï¼Œdg_valueä¸º0ï¼Œç›´æ¥è°ƒç”¨_dispatch_group_wake</strong></p>
<h4 id="dispatch-group-wake"><a href="#dispatch-group-wake" class="headerlink" title="_dispatch_group_wake()"></a>_dispatch_group_wake()</h4><p>å¯ä»¥è¯´DispatchGroupçš„æ ¸å¿ƒé€»è¾‘å°±åœ¨_dispatch_group_wakeæ–¹æ³•ä¸­</p>
<p>å…ˆæ¥çœ‹çœ‹æºç å®ç°</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">DISPATCH_NOINLINE</span><br><span class="line">static long</span><br><span class="line"><span class="constructor">_dispatch_group_wake(<span class="params">dispatch_group_t</span> <span class="params">dg</span>, <span class="params">bool</span> <span class="params">needs_release</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	dispatch_continuation_t next, head, tail = NULL;</span><br><span class="line">	long rval;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// cannot use os_mpsc_capture_snapshot() because we can have concurrent</span></span><br><span class="line">	<span class="comment">// _dispatch_group_wake() calls</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">//dispatch_group_s ä¸­dg_notify_head</span></span><br><span class="line">	head = os<span class="constructor">_atomic_xchg2o(<span class="params">dg</span>, <span class="params">dg_notify_head</span>, NULL, <span class="params">relaxed</span>)</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (head) &#123;</span><br><span class="line">		<span class="comment">// snapshot before anything is notified/woken &lt;rdar://problem/8554546&gt;</span></span><br><span class="line">		tail = os<span class="constructor">_atomic_xchg2o(<span class="params">dg</span>, <span class="params">dg_notify_tail</span>, NULL, <span class="params">release</span>)</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	rval = (long)os<span class="constructor">_atomic_xchg2o(<span class="params">dg</span>, <span class="params">dg_waiters</span>, 0, <span class="params">relaxed</span>)</span>;</span><br><span class="line">	<span class="keyword">if</span> (rval) &#123;</span><br><span class="line">		<span class="comment">// wake group waiters</span></span><br><span class="line">		<span class="constructor">_dispatch_sema4_create(&amp;<span class="params">dg</span>-&gt;<span class="params">dg_sema</span>, <span class="params">_DSEMA4_POLICY_FIFO</span>)</span>;</span><br><span class="line">		<span class="constructor">_dispatch_sema4_signal(&amp;<span class="params">dg</span>-&gt;<span class="params">dg_sema</span>, <span class="params">rval</span>)</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	uint16_t refs = needs_release ? <span class="number">1</span> : <span class="number">0</span>; <span class="comment">// &lt;rdar://problem/22318411&gt;</span></span><br><span class="line">	<span class="keyword">if</span> (head) &#123;</span><br><span class="line">		<span class="comment">// async group notify blocks</span></span><br><span class="line">		<span class="keyword">do</span> &#123;</span><br><span class="line">			next = os<span class="constructor">_mpsc_pop_snapshot_head(<span class="params">head</span>, <span class="params">tail</span>, <span class="params">do_next</span>)</span>;</span><br><span class="line">			dispatch_queue_t dsn_queue = (dispatch_queue_t)head-&gt;dc_data;</span><br><span class="line">			<span class="comment">//headå°±æ˜¯notifyçš„block åœ¨ç›®æ ‡é˜Ÿåˆ—dsn_queueä¸Šè¿è¡Œ</span></span><br><span class="line">			<span class="constructor">_dispatch_continuation_async(<span class="params">dsn_queue</span>, <span class="params">head</span>)</span>;</span><br><span class="line">			<span class="constructor">_dispatch_release(<span class="params">dsn_queue</span>)</span>;</span><br><span class="line">		&#125; <span class="keyword">while</span> ((head = next));</span><br><span class="line">		refs++;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (refs) <span class="constructor">_dispatch_release_n(<span class="params">dg</span>, <span class="params">refs</span>)</span>;</span><br><span class="line">	return <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ˜¯å¦è¿˜è®°å¾—å‰é¢æåˆ°çš„dispatch_group_sä¸­çš„é“¾è¡¨å¤´å’Œå°¾ï¼Ÿ</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line">head = os<span class="constructor">_atomic_xchg2o(<span class="params">dg</span>, <span class="params">dg_notify_head</span>, NULL, <span class="params">relaxed</span>)</span>;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œå–å‡ºdispatch_group_sä¸­çš„é“¾è¡¨å¤´ï¼Œå¦‚æœæœ‰é“¾è¡¨å¤´å†å–å‡ºé“¾è¡¨å°¾ã€‚</p>
<p>æ ¸å¿ƒé€»è¾‘åœ¨è¿™ä¸ªdo whileå¾ªç¯ä¸­</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (head) &#123;</span><br><span class="line">		<span class="comment">// async group notify blocks</span></span><br><span class="line">		<span class="keyword">do</span> &#123;</span><br><span class="line">			next = os<span class="constructor">_mpsc_pop_snapshot_head(<span class="params">head</span>, <span class="params">tail</span>, <span class="params">do_next</span>)</span>;</span><br><span class="line">			dispatch_queue_t dsn_queue = (dispatch_queue_t)head-&gt;dc_data;</span><br><span class="line">			<span class="comment">//headå°±æ˜¯notifyçš„block åœ¨ç›®æ ‡é˜Ÿåˆ—dsn_queueä¸Šè¿è¡Œ</span></span><br><span class="line">			<span class="constructor">_dispatch_continuation_async(<span class="params">dsn_queue</span>, <span class="params">head</span>)</span>;</span><br><span class="line">			<span class="constructor">_dispatch_release(<span class="params">dsn_queue</span>)</span>;</span><br><span class="line">		&#125; <span class="keyword">while</span> ((head = next));</span><br><span class="line">		refs++;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡<code>head-&gt;dc_data</code>æ‹¿åˆ°ç›®æ ‡é˜Ÿåˆ—ï¼Œç„¶åé€šè¿‡<code>_dispatch_continuation_async(dsn_queue, head)</code>å°†headè¿è¡Œåœ¨ç›®æ ‡é˜Ÿåˆ—ä¸Šã€‚</p>
<p>é‚£headæ˜¯ä»€ä¹ˆå°±ä¸€ç›®äº†ç„¶äº†ã€‚<code>è¿™ä¸ªé˜Ÿåˆ—ä¸­å­˜å‚¨çš„æ˜¯notifyå›è°ƒçš„block</code></p>
<p>å†æ¥çœ‹çœ‹dispatch_group_sçš„å®šä¹‰</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dispatch_group_s</span> &#123;</span></span><br><span class="line">	DISPATCH_SEMAPHORE_HEADER(group, dg);</span><br><span class="line">    <span class="comment">//çœ‹åå­—çŸ¥é“å’Œwaitæ–¹æ³•æœ‰å…³</span></span><br><span class="line">	<span class="keyword">int</span> <span class="keyword">volatile</span> dg_waiters;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">//è¿™é‡Œå°±æ˜¯æŠŠæ‰€æœ‰notifyçš„å›è°ƒblockå­˜è¿›é“¾è¡¨é‡Œï¼Œç„¶åæ‹¿åˆ°å¤´ç»“ç‚¹å’Œå°¾ç»“ç‚¹ã€‚</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dispatch_continuation_s</span> *<span class="title">volatile</span> <span class="title">dg_notify_head</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">dispatch_continuation_s</span> *<span class="title">volatile</span> <span class="title">dg_notify_tail</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>


<h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>DispatchGroup åœ¨åˆ›å»ºæ—¶å€™ä¼šå»ºç«‹ä¸€ä¸ªé“¾è¡¨ï¼Œæ¥å­˜å‚¨notifyçš„blockå›è°ƒã€‚</p>
<p>åˆ¤æ–­notifyæ‰§è¡Œçš„ä¾æ®å°±æ˜¯dg_valueæ˜¯å¦ä¸º0</p>
<p>å½“ä¸è°ƒç”¨enterå’Œleaveæ—¶å€™ï¼Œdg_value=0ï¼Œnotifyçš„å›è°ƒä¼šç«‹å³æ‰§è¡Œï¼Œå¹¶ä¸”æœ‰å¤šä¸ªnotifyä¼šæŒ‰ç…§é¡ºåºä¾æ¬¡è°ƒç”¨ã€‚</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> g1 = <span class="module-access"><span class="module"><span class="identifier">DispatchGroup</span>.</span></span>init<span class="literal">()</span></span><br><span class="line">        </span><br><span class="line">g1.notify(queue: <span class="module-access"><span class="module"><span class="identifier">DispatchQueue</span>.</span></span>global<span class="literal">()</span>) &#123;</span><br><span class="line">	print(<span class="string">"notify null"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">g1.notify(queue: <span class="module-access"><span class="module"><span class="identifier">DispatchQueue</span>.</span></span>global<span class="literal">()</span>) &#123;</span><br><span class="line">	print(<span class="string">"notify null2"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ç›´æ¥è¾“å…¥notify null,notify null2</span></span><br></pre></td></tr></table></figure>

<p>å½“æœ‰enteræ—¶å€™dg_value+1ã€‚leaveæ—¶å€™-1ã€‚<br>å½“æœ€åä¸€ä¸ªleaveæ‰§è¡Œåï¼Œdg_value==0ã€‚å»å¾ªç¯é“¾è¡¨æ‰§è¡Œnotifyçš„å›è°ƒ</p>
<figure class="highlight maxima"><table><tr><td class="code"><pre><span class="line"> 	   <span class="built_in">let</span> <span class="built_in">g1</span> = DispatchGroup.init()</span><br><span class="line">  </span><br><span class="line">        //A B å¹¶å‘ A B å®Œæˆåå¼€å¯Cä»»åŠ¡</span><br><span class="line"></span><br><span class="line">        <span class="built_in">g1</span>.enter()</span><br><span class="line">        DispatchQueue.global().async &#123;</span><br><span class="line">            <span class="keyword">for</span> <span class="symbol">_</span> <span class="keyword">in</span> <span class="number">0</span>...<span class="number">3</span>&#123;</span><br><span class="line">              <span class="built_in">print</span>(<span class="string">"task A: \(Thread.current)"</span>)</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="built_in">g1</span>.leave()</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">g1</span>.enter()</span><br><span class="line">        DispatchQueue.global().async &#123;</span><br><span class="line">            <span class="keyword">for</span> <span class="symbol">_</span> <span class="keyword">in</span> <span class="number">0</span>...<span class="number">3</span>&#123;</span><br><span class="line">              <span class="built_in">print</span>(<span class="string">"task B: \(Thread.current)"</span>)</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="built_in">g1</span>.leave()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">g1</span>.notify(queue: DispatchQueue.global()) &#123;</span><br><span class="line">			<span class="built_in">print</span>(<span class="string">"notify A&amp;B"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ ¹æ®æºç ä¹Ÿå¾—çŸ¥ï¼Œenterå’Œleaveå¿…é¡»æˆå¯¹å‡ºç°ã€‚</p>
<p>å½“enterå¤šçš„æ—¶å€™ï¼Œdg_valueæ°¸è¿œå¤§äº0ï¼Œnotifyä¸ä¼šè¢«æ‰§è¡Œã€‚</p>
<p>å½“leaveå¤šçš„æ—¶å€™ï¼Œdg_valueå°äº0ï¼Œé€ æˆCrash</p>
<h4 id="æ€è€ƒ"><a href="#æ€è€ƒ" class="headerlink" title="æ€è€ƒ"></a>æ€è€ƒ</h4><p>Appleçš„APIå°è£…çš„å¾ˆå¥½ï¼Œå…¶ä¸­çš„ä¸€äº›è®¾è®¡æ¨¡å¼ä¹Ÿå€¼å¾—æˆ‘ä»¬å­¦ä¹ ã€‚</p>
<p>GCDçš„æ‰§è¡Œæ•ˆç‡ç‰¹åˆ«é«˜ï¼Œåœ¨è¯»æºç ä¸­å‘ç°ifåˆ¤æ–­ç”¨äº†å¾ˆå¤š<code>slowpath</code> <code>fastpath</code></p>
<figure class="highlight cs"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">dispatch_group_leave(dispatch_group_t dg)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//dg_value -1</span></span><br><span class="line">	<span class="keyword">long</span> <span class="keyword">value</span> = os_atomic_dec2o(dg, dg_value, release);</span><br><span class="line">	<span class="keyword">if</span> (slowpath(<span class="keyword">value</span> == <span class="number">0</span>)) &#123;</span><br><span class="line">		<span class="keyword">return</span> (<span class="keyword">void</span>)_dispatch_group_wake(dg, <span class="literal">true</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//ä¸æˆå¯¹å‡ºç° crash</span></span><br><span class="line">	<span class="keyword">if</span> (slowpath(<span class="keyword">value</span> &lt; <span class="number">0</span>)) &#123;</span><br><span class="line">		DISPATCH_CLIENT_CRASH(<span class="keyword">value</span>,</span><br><span class="line">				<span class="string">"Unbalanced call to dispatch_group_leave()"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªä¼šå†å¦èµ·ä¸€ç¯‡åšå®¢æ¥ç ”ç©¶ã€‚</p>
<p>å…³äºDispatchGroup çš„<code>wait()</code>å®ç°å°±ä¸å†åˆ†æäº†ã€‚å¤§å®¶å¯ä»¥è‡ªè¡Œä¸‹è½½æºç æ¥ç ”ç©¶ä¸‹ã€‚</p>
<p>å¸¦æ³¨é‡Šçš„æºç è¯¦è§Github:</p>
<p><a href="https://github.com/liweican1992/libdispatch" target="_blank" rel="noopener">https://github.com/liweican1992/libdispatch</a></p>
<p><a href="https://github.com/liweican1992/swift-corelibs-foundation" target="_blank" rel="noopener">https://github.com/liweican1992/swift-corelibs-foundation</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/22/%E4%BB%8E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90Swift%E5%A4%9A%E7%BA%BF%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img/avatar.png">
      <meta itemprop="name" content="weican Li">
      <meta itemprop="description" content="iOS Developer">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="licc">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/22/%E4%BB%8E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90Swift%E5%A4%9A%E7%BA%BF%E7%A8%8B/" class="post-title-link" itemprop="url">è¯¦è§£Swiftå¤šçº¿ç¨‹</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-05-22 17:18:00" itemprop="dateCreated datePublished" datetime="2020-05-22T17:18:00+08:00">2020-05-22</time>
            </span>

          
            <span id="/2020/05/22/%E4%BB%8E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90Swift%E5%A4%9A%E7%BA%BF%E7%A8%8B/" class="post-meta-item leancloud_visitors" data-flag-title="è¯¦è§£Swiftå¤šçº¿ç¨‹" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2020/05/22/%E4%BB%8E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90Swift%E5%A4%9A%E7%BA%BF%E7%A8%8B/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/05/22/%E4%BB%8E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90Swift%E5%A4%9A%E7%BA%BF%E7%A8%8B/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Swiftç»ˆäºåœ¨5.xç‰ˆæœ¬å˜å¾—ç¨³å®šï¼Œå…ˆæ¥çœ‹çœ‹Swift5.1ä¸­çš„GCDå¦‚ä½•ä½¿ç”¨</p>
<ul>
<li><h4 id="é˜Ÿåˆ—"><a href="#é˜Ÿåˆ—" class="headerlink" title="é˜Ÿåˆ—"></a>é˜Ÿåˆ—</h4></li>
</ul>
<h6 id="ä¸²è¡Œé˜Ÿåˆ—"><a href="#ä¸²è¡Œé˜Ÿåˆ—" class="headerlink" title="ä¸²è¡Œé˜Ÿåˆ—"></a>ä¸²è¡Œé˜Ÿåˆ—</h6><p>ä¸²è¡Œé˜Ÿåˆ—ä¸€èˆ¬åªåˆ†é…ä¸€ä¸ªçº¿ç¨‹ï¼Œé˜Ÿåˆ—å¦‚æœæœ‰ä»»åŠ¡æ‰§è¡Œæ˜¯ä¸å…è®¸æ’é˜Ÿã€‚<br>ä¸²è¡Œé˜Ÿåˆ—ä¸­æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹ä¸å…è®¸è¢«å½“å‰é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡é˜»å¡ï¼ˆæ­»é”ï¼‰ï¼Œä½†æ˜¯èƒ½è¢«å…¶ä»–å¯¹åˆ—é˜»å¡</p>
<p>é»˜è®¤åˆ›å»ºçš„æ˜¯ä¸²è¡Œé˜Ÿåˆ—</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">let<span class="built_in"> queue </span>= DispatchQueue(label: <span class="string">"com.youdao.queueName"</span>)</span><br></pre></td></tr></table></figure>

<p>ä¸»çº¿ç¨‹å°±æ˜¯ä¸²è¡Œé˜Ÿåˆ—</p>
<figure class="highlight reasonml"><table><tr><td class="code"><pre><span class="line"><span class="module-access"><span class="module"><span class="identifier">DispatchQueue</span>.</span></span>main</span><br></pre></td></tr></table></figure>

<p>å¸¸è§çš„ä¸»çº¿ç¨‹æ­»é”</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line"><span class="comment">//main Threed</span></span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(<span class="number">1</span>)</span></span></span><br><span class="line">DispatchQueue<span class="selector-class">.main</span><span class="selector-class">.sync</span> &#123;</span><br><span class="line">     print(<span class="number">2</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(<span class="number">3</span>)</span></span></span><br></pre></td></tr></table></figure>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2020/05/22/%E4%BB%8E%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90Swift%E5%A4%9A%E7%BA%BF%E7%A8%8B/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/15/%E8%BD%AC%E7%A7%BB%E7%AE%80%E4%B9%A6%E5%88%B0Github/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img/avatar.png">
      <meta itemprop="name" content="weican Li">
      <meta itemprop="description" content="iOS Developer">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="licc">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/15/%E8%BD%AC%E7%A7%BB%E7%AE%80%E4%B9%A6%E5%88%B0Github/" class="post-title-link" itemprop="url">è½¬ç§»ç®€ä¹¦åˆ°Github</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-05-15 18:40:00" itemprop="dateCreated datePublished" datetime="2020-05-15T18:40:00+08:00">2020-05-15</time>
            </span>

          
            <span id="/2020/05/15/%E8%BD%AC%E7%A7%BB%E7%AE%80%E4%B9%A6%E5%88%B0Github/" class="post-meta-item leancloud_visitors" data-flag-title="è½¬ç§»ç®€ä¹¦åˆ°Github" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2020/05/15/%E8%BD%AC%E7%A7%BB%E7%AE%80%E4%B9%A6%E5%88%B0Github/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/05/15/%E8%BD%AC%E7%A7%BB%E7%AE%80%E4%B9%A6%E5%88%B0Github/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>ä»Šå¤©ç®€ä¹¦è´¦å·è«åå…¶å¦™çš„è¢«å°äº†ï¼ŒåŠ ä¸Šä¹‹å‰å°äº†å¥½å‡ ç¯‡æŠ€æœ¯æ–‡ç« ã€‚ç»ˆäºä½¿æˆ‘ä¸‹å®šå†³å¿ƒå¹²æ‰ç®€ä¹¦ã€‚</p>
<p>ç”¨ç®€ä¹¦å·²ç»æœ‰5å¹´äº†ï¼Œå†™äº†20å¤šç¯‡åšå®¢ï¼Œæ”¶è·äº†100+çš„ç²‰ä¸ã€‚</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2020/05/15/%E8%BD%AC%E7%A7%BB%E7%AE%80%E4%B9%A6%E5%88%B0Github/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="weican Li"
      src="https://cdn.jsdelivr.net/gh/liweican1992/hexoPic/img/avatar.png">
  <p class="site-author-name" itemprop="name">weican Li</p>
  <div class="site-description" itemprop="description">iOS Developer</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">22</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/liweican1992" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;liweican1992" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:liweican1992@163.com" title="E-Mail â†’ mailto:liweican1992@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">weican Li</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : true,
      appId      : '2vtATvMKrRqHP269UUtJOy6L-MdYXbMMI',
      appKey     : 'zHsuq1nT4cg9Vse62lvSHrUq',
      placeholder: "åœ¨æ­¤è¾“å…¥ç•™è¨€",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : true,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
